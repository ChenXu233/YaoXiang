name: Performance Benchmark

on:
  schedule:
    # 每周日 UTC 0 点运行性能测试
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      compare:
        description: 'Compare against commit'
        required: false
        default: ''

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.90.0

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/git
            ~/.cargo/registry
            target
          key: ${{ runner.os }}-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-bench-

      - name: Run benchmarks
        run: |
          cargo bench --all-features -- --output-format bencher | tee bench-results.txt

      - name: Parse benchmark results
        run: |
          # 提取关键指标
          echo "## Benchmark Results" > benchmark-report.md
          echo "" >> benchmark-report.md
          echo "**Date**: $(date -u +%Y-%m-%d)" >> benchmark-report.md
          echo "**Rust Version**: $(rustc --version)" >> benchmark-report.md
          echo "" >> benchmark-report.md
          
          # 解析 JSON 格式的 benchmark 结果
          if command -v cargo &> /dev/null; then
            cargo bench --all-features -- --format json > bench-json.json 2>&1 || true
          fi
          
          # 保留原始文本结果
          cp bench-results.txt benchmark-details.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            bench-results.txt
            benchmark-details.txt

      - name: Upload to historical tracking
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-history
          path: bench-results.txt
          retention-days: 365

  compare:
    name: Performance Comparison
    needs: benchmark
    if: github.event.inputs.compare != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download current benchmark
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results
          path: current

      - name: Download comparison benchmark
        uses: actions/download-artifact@v4
        with:
          name: benchmark-history
          path: comparison
          merge-multiple: true

      - name: Compare performance
        run: |
          echo "# Performance Comparison Report" > comparison-report.md
          echo "" >> comparison-report.md
          echo "Comparing against: ${{ github.event.inputs.compare }}" >> comparison-report.md
          echo "" >> comparison-report.md
          
          # 简单的文本对比
          if [ -f "current/bench-results.txt" ] && [ -f "comparison/bench-results.txt" ]; then
            diff -u "comparison/bench-results.txt" "current/bench-results.txt" >> comparison-report.md || true
          fi
          
          cat comparison-report.md

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: comparison-report.md
