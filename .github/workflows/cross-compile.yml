name: Cross-Compile CI

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always

jobs:
  # 基础检查（与主CI共享）
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.90.0
          components: rustfmt, clippy
      - name: Check formatting
        run: cargo fmt --check --all
      - name: Clippy
        run: cargo clippy --all --all-features -- -D warnings

  # Linux 交叉编译
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-musl
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.90.0
          targets: ${{ matrix.target }}

      - name: Install cross compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Build release
        run: cargo build --release --all-features --target ${{ matrix.target }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yaoxiang-linux-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/yaoxiang

  # macOS 交叉编译
  build-macos:
    name: Build macOS
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-apple-darwin
          - aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.90.0
          targets: ${{ matrix.target }}

      - name: Install cross toolchain
        run: |
          # 安装 macOS 交叉编译工具链
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            lld \
            cctools \
            libssl-dev

      - name: Set up Darwin target
        run: |
          echo "CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER=x86_64-apple-darwin-clang" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER=aarch64-apple-darwin-clang" >> $GITHUB_ENV
          echo "CARGO_TARGET_X86_64_APPLE_DARWIN_AR=x86_64-apple-darwin-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_APPLE_DARWIN_AR=aarch64-apple-darwin-ar" >> $GITHUB_ENV

      - name: Build release
        run: cargo build --release --all-features --target ${{ matrix.target }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yaoxiang-macos-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/yaoxiang

  # Windows 交叉编译 (使用 MinGW)
  build-windows:
    name: Build Windows
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-pc-windows-gnu
          - aarch64-pc-windows-gnu
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.90.0
          targets: ${{ matrix.target }}

      - name: Install MinGW
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-mingw-w64-x86-64 \
            g++-mingw-w64-x86-64

      - name: Build release
        run: |
          cargo build --release --all-features --target ${{ matrix.target }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yaoxiang-windows-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/yaoxiang.exe

  # WASM 编译
  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.90.0
          targets: wasm32-unknown-unknown

      - name: Build WASM
        run: cargo build --release --features wasm --target wasm32-unknown-unknown

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yaoxiang-wasm
          path: target/wasm32-unknown-unknown/release/yaoxiang.wasm

  # 创建发布包
  release:
    name: Create Release
    needs: [build-linux, build-macos, build-windows, build-wasm]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release
        run: |
          mkdir -p release
          cd artifacts
          
          # 重命名并移动产物
          for dir in yaoxiang-linux-*; do
            if [ -d "$dir" ]; then
              target=$(echo "$dir" | sed 's/yaoxiang-linux-//')
              cp "$dir/yaoxiang" "../release/yaoxiang-linux-${target}"
            fi
          done
          
          for dir in yaoxiang-macos-*; do
            if [ -d "$dir" ]; then
              target=$(echo "$dir" | sed 's/yaoxiang-macos-//')
              cp "$dir/yaoxiang" "../release/yaoxiang-macos-${target}"
            fi
          done
          
          for dir in yaoxiang-windows-*; do
            if [ -d "$dir" ]; then
              target=$(echo "$dir" | sed 's/yaoxiang-windows-//')
              cp "$dir/yaoxiang.exe" "../release/yaoxiang-windows-${target}.exe"
            fi
          done
          
          cp yaoxiang-wasm/yaoxiang.wasm ../release/
          
          # 创建校验和
          cd ../release
          sha256sum * > checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
