# YaoXiangï¼ˆçˆ»è±¡ï¼‰å®ç°è®¡åˆ’

> ç‰ˆæœ¬ï¼šv1.0.0
> çŠ¶æ€ï¼šå®ç°è§„åˆ’
> ä½œè€…ï¼šæ²«éƒé…±
> æ—¥æœŸï¼š2024-12-31

---

## ä¸€ã€æ¦‚è¿°

### 1.1 æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£è¯¦ç»†è§„åˆ’äº† YaoXiang ç¼–ç¨‹è¯­è¨€çš„é«˜æ€§èƒ½è§£é‡Šå™¨å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ ¸å¿ƒæ¶æ„è®¾è®¡ã€å…³é”®æŠ€æœ¯é€‰å‹ã€ä¼˜åŒ–ç­–ç•¥ï¼Œä»¥åŠæœªæ¥ç¼–è¯‘å™¨å’Œè‡ªä¸¾çš„æ¼”è¿›è·¯çº¿å›¾ã€‚

### 1.2 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | è¦æ±‚ |
|------|------|
| æ€§èƒ½ | è§£é‡Šå™¨è¿è¡Œé€Ÿåº¦è¾¾åˆ°åŸç”Ÿä»£ç çš„ 50% ä»¥ä¸Š |
| å¯åŠ¨ | å¯åŠ¨æ—¶é—´æ§åˆ¶åœ¨ 100 æ¯«ç§’ä»¥å†… |
| å†…å­˜ | å†…å­˜å ç”¨ä½äºåŒåŠŸèƒ½ Rust ç¨‹åºçš„ 2 å€ |
| å…¼å®¹æ€§ | æ”¯æŒ YaoXiang è¯­è¨€è§„èŒƒçš„å…¨éƒ¨ç‰¹æ€§ |

### 1.3 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         YaoXiang å®ç°æ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   å‰ç«¯å±‚    â”‚ â†’  â”‚   ä¸­é—´å±‚    â”‚ â†’  â”‚        åç«¯å±‚           â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â€¢ è¯æ³•åˆ†æ  â”‚    â”‚ â€¢ AST ä¼˜åŒ–  â”‚    â”‚ â€¢ å­—èŠ‚ç è™šæ‹Ÿæœº          â”‚ â”‚
â”‚  â”‚ â€¢ è¯­æ³•åˆ†æ  â”‚    â”‚ â€¢ ç±»å‹æ£€æŸ¥  â”‚    â”‚ â€¢ JIT ç¼–è¯‘å™¨            â”‚ â”‚
â”‚  â”‚ â€¢ è§£æå™¨   â”‚    â”‚ â€¢ IR è½¬æ¢   â”‚    â”‚ â€¢ æœ¬åœ°ä»£ç ç”Ÿæˆ          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      è¿è¡Œæ—¶ç³»ç»Ÿ                              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â€¢ å†…å­˜ç®¡ç† â€¢ åƒåœ¾å›æ”¶ â€¢ å¹¶å‘è°ƒåº¦ â€¢ æ ‡å‡†åº“                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æŠ€æœ¯é€‰å‹

### 2.1 æ ¸å¿ƒæŠ€æœ¯å†³ç­–

**å­—èŠ‚ç  vs ç›´æ¥è§£é‡Š**ï¼šé‡‡ç”¨å­—èŠ‚ç è™šæ‹Ÿæœºæ–¹æ¡ˆã€‚

| å­—èŠ‚ç ä¼˜åŠ¿ | è¯´æ˜ |
|------------|------|
| æŒ‡ä»¤ç´§å‡‘ | å ç”¨ç©ºé—´å° |
| å¯ç¼“å­˜ | é¿å…é‡å¤è§£æ |
| JIT å‹å¥½ | ä¾¿äºæ¸è¿›å¼ä¼˜åŒ– |
| è·¨å¹³å° | ä¾¿äºç§»æ¤ |

**åƒåœ¾å›æ”¶ç­–ç•¥**ï¼šå¢é‡å¼åˆ†ä»£ GCã€‚

- å°å¯¹è±¡æ ˆåˆ†é…
- å¤§å¯¹è±¡å †åˆ†é…
- åˆ†ä»£å›æ”¶
- å¢é‡æ ‡è®°ã€å¹¶å‘æ¸…é™¤

**å¹¶å‘æ¨¡å‹**ï¼šM:N çº¿ç¨‹æ¨¡å‹ã€‚

- ç»¿è‰²çº¿ç¨‹æ˜ å°„åˆ°ç³»ç»Ÿçº¿ç¨‹
- å·¥ä½œçªƒå–è´Ÿè½½å‡è¡¡
- åç¨‹æ ˆæŒ‰éœ€å¢é•¿

---

## ä¸‰ã€æ¨¡å—è®¾è®¡

### 3.1 è¯æ³•åˆ†æå™¨

```rust
#[derive(Debug, Clone, PartialEq)]
pub struct Token {
    pub kind: TokenKind,
    pub span: Span,
    pub literal: Option<Literal>,
}

#[derive(Debug, Clone, PartialEq)]
pub enum TokenKind {
    // å…³é”®å­—ï¼ˆ18ä¸ªæ ¸å¿ƒå…³é”®å­—ï¼Œä¸å¯è¦†ç›–ï¼‰
    KwType, KwFn, KwPub, KwUse,
    KwSpawn, KwRef, KwMut,
    KwIf, KwElif, KwElse, KwMatch,
    KwWhile, KwFor, KwIn, KwReturn, KwBreak, KwContinue, KwAs,

    // æ ‡è¯†ç¬¦å’Œå­—é¢é‡
    Identifier(String),
    Underscore,
    IntLiteral(i128),
    FloatLiteral(f64),
    BoolLiteral(bool),
    CharLiteral(char),
    StringLiteral(String),

    // è¿ç®—ç¬¦å’Œåˆ†éš”ç¬¦
    Plus, Minus, Star, Slash, Percent,
    Eq, Neq, Lt, Le, Gt, Ge,
    And, Or, Not,
    ColonColon, DotDotDot,
    LParen, RParen, LBracket, RBracket, LBrace, RBrace,
    Comma, Colon, Semicolon, Pipe,
    Dot, Arrow, FatArrow,

    // ç‰¹æ®Š
    Eof,
    Error(String),
}
```

> **ğŸ“ è®¾è®¡è¯´æ˜**ï¼š
> - **æ¨¡å—è®¾è®¡**ï¼šé‡‡ç”¨å¤šæ–‡ä»¶æ¨¡å—ç³»ç»Ÿï¼Œé€šè¿‡ `use` å¯¼å…¥æ–‡ä»¶ã€‚ä¸æ”¯æŒå•æ–‡ä»¶ `mod { ... }` è¯­æ³•ï¼Œé¿å…ä»£ç è†¨èƒ€
> - **ç±»å‹å…³é”®å­—**ï¼ˆå¯è¦†ç›–ï¼‰ï¼š`void`, `bool`, `char`, `string`, `bytes`, `int`, `float` - å½“å‰ä½œä¸ºæ™®é€š `Identifier` å¤„ç†ï¼Œè§£æå™¨åœ¨ç±»å‹ä¸Šä¸‹æ–‡ä¸­è¯†åˆ«
> - **å¸ƒå°”å­—é¢é‡**ï¼š`true`, `false` - å½“å‰ä½œä¸ºæ™®é€š `Identifier` å¤„ç†ï¼Œè§£æå™¨åœ¨è¡¨è¾¾å¼ä¸Šä¸‹æ–‡ä¸­è¯†åˆ«ä¸º `BoolLiteral`
> - **`in` å…³é”®å­—**ï¼šæ”¯æŒ Python é£æ ¼çš„åˆ—è¡¨æ¨å¯¼å¼è¯­æ³•ç³–
>   ```yaoxiang
>   [x * 2 for x in range(10) if x % 2 == 0]  // ç”Ÿæˆ [0, 4, 8, 12, 16]
>   ```

### 3.2 è¯­æ³•åˆ†æå™¨

é‡‡ç”¨ LL(1) é€’å½’ä¸‹é™è§£æå™¨ç»“åˆ Pratt Parser å¤„ç†è¡¨è¾¾å¼ï¼š

```rust
#[derive(Debug, Clone)]
pub enum Expr {
    Lit(Literal),
    Var(String),
    BinOp(BinOp, Box<Expr>, Box<Expr>),
    UnOp(UnOp, Box<Expr>),
    FnCall { func: Box<Expr>, args: Vec<Expr> },
    FnDef {
        name: String,
        params: Vec<Param>,
        return_type: Option<Type>,
        body: Box<Block>,
        is_async: bool,
    },
    If {
        condition: Box<Expr>,
        then_branch: Box<Block>,
        elif_branches: Vec<(Box<Expr>, Box<Block>)>,
        else_branch: Option<Box<Block>>,
    },
    Match {
        expr: Box<Expr>,
        arms: Vec<MatchArm>,
    },
    For {
        var: String,
        iterable: Box<Expr>,
        body: Box<Block>,
    },
    While {
        condition: Box<Expr>,
        body: Box<Block>,
    },
    Block(Vec<Stmt>),
    Return(Option<Box<Expr>>),
    // ...
}
```

### 3.3 ç±»å‹æ£€æŸ¥å™¨

æ ¸å¿ƒç®—æ³•é‡‡ç”¨ Hindley-Milner ç±»å‹æ¨æ–­çš„æ‰©å±•ç‰ˆæœ¬ï¼š

```rust
#[derive(Debug, Clone)]
pub struct TypeEnvironment {
    variables: HashMap<String, Type>,
    constraints: Vec<TypeConstraint>,
    generics: HashSet<String>,
}

#[derive(Debug, Clone, PartialEq)]
pub enum Type {
    Void, Bool,
    Int(usize), Float(usize),
    Char, String, Bytes,
    Struct(StructType),
    Union(UnionType),
    Enum(Vec<String>),
    Tuple(Vec<Type>),
    List(Box<Type>),
    Dict(Box<Type>, Box<Type>),
    Fn {
        params: Vec<Type>,
        return_type: Box<Type>,
        is_async: bool,
    },
    TypeVar(usize),
    TypeRef(String),
}
```

### 3.4 ä¸­é—´è¡¨ç¤ºï¼ˆIRï¼‰

```rust
#[derive(Debug)]
pub enum Value {
    Const(ConstValue),
    Local(usize),        // å±€éƒ¨å˜é‡ç´¢å¼•
    Arg(usize),          // å‚æ•°ç´¢å¼•
    Temp(usize),         // ä¸´æ—¶å˜é‡
    StaticAddr(usize),   // é™æ€æ•°æ®åœ°å€
}

#[derive(Debug)]
pub enum Instruction {
    // ç§»åŠ¨æŒ‡ä»¤
    Move { dst: Value, src: Value },

    // ç®—æœ¯è¿ç®—
    Add { dst: Value, lhs: Value, rhs: Value },
    Sub { dst: Value, lhs: Value, rhs: Value },
    Mul { dst: Value, lhs: Value, rhs: Value },
    Div { dst: Value, lhs: Value, rhs: Value },

    // æ¯”è¾ƒè·³è½¬
    Cmp { dst: Value, lhs: Value, rhs: Value },
    Jmp(usize),
    JmpIf(Value, usize),
    JmpIfNot(Value, usize),

    // å‡½æ•°è°ƒç”¨
    Call { dst: Option<Value>, func: Value, args: Vec<Value> },
    CallAsync { dst: Value, func: Value, args: Vec<Value> },
    Ret(Option<Value>),

    // å†…å­˜æ“ä½œ
    Alloc { dst: Value, size: Value },
    Free(Value),
    LoadField { dst: Value, src: Value, field: usize },
    StoreField { dst: Value, field: usize, src: Value },

    // å¹¶å‘æ“ä½œ
    Spawn { func: Value },
    Await(Value),
    Yield,
}
```

### 3.5 å­—èŠ‚ç è™šæ‹Ÿæœº

```rust
pub struct VM {
    // å¯„å­˜å™¨
    regs: Vec<Value>,
    ip: usize,
    sp: usize,
    fp: usize,

    // è¿è¡Œæ—¶
    stack: Vec<Value>,
    frames: Vec<Frame>,
    constants: Vec<ConstValue>,
    globals: Vec<Value>,

    // å†…å­˜ç®¡ç†
    heap: Heap,
    gc: GC,

    // å¹¶å‘
    scheduler: Scheduler,
}
```

### 3.6 åƒåœ¾å›æ”¶å™¨

é‡‡ç”¨å¢é‡å¼åˆ†ä»£æ”¶é›†å™¨ï¼š

```rust
pub struct GC {
    heaps: Vec<HeapSpace>,     // åˆ†ä»£å †ç©ºé—´
    large_objects: Heap,       // å¤§å¯¹è±¡å †
    global_root: Vec<GCRoot>,  // å…¨å±€æ ¹é›†åˆ
    threads: Vec<GCRoot>,      // çº¿ç¨‹æ ¹é›†åˆ
    state: GCState,
    collector: Collector,
}

pub struct HeapSpace {
    young: Heap,               // å¹´è½»ä»£
    old: Heap,                 // è€å¹´ä»£
    allocation_buffer: Vec<u8>,
    card_table: Vec<u8>,
}
```

### 3.7 å¹¶å‘è°ƒåº¦å™¨

é‡‡ç”¨ M:N çº¿ç¨‹æ¨¡å‹ï¼Œå·¥ä½œçªƒå–è´Ÿè½½å‡è¡¡ï¼š

```rust
pub struct Scheduler {
    runqueues: Vec<Arc<RunQueue>>,
    global_queue: Arc<GlobalQueue>,
    workers: Vec<Worker>,
    task_counter: AtomicUsize,
}

pub struct Task {
    id: TaskId,
    state: AtomicTaskState,
    stack: TaskStack,
    context: Context,
    future: Option<BoxFuture>,
    spawned_at: Instant,
}
```

---

## å››ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 4.1 è§£é‡Šå™¨ä¼˜åŒ–

| ä¼˜åŒ–æŠ€æœ¯ | è¯´æ˜ |
|----------|------|
| çƒ­ç‚¹æ£€æµ‹ | é‡‡æ ·åˆ†æè¯†åˆ«çƒ­ç‚¹å‡½æ•° |
| ç±»å‹ç‰¹åŒ– | é’ˆå¯¹å¸¸è§ç±»å‹ç”Ÿæˆç‰¹åŒ–å­—èŠ‚ç  |
| å†…è”ç¼“å­˜ | ç¼“å­˜å·²çŸ¥ç±»å‹çš„å®ç° |
| å­—èŠ‚ç ç¼“å­˜ | é¿å…é‡å¤è§£æç›¸åŒä»£ç  |

### 4.2 å†…å­˜ä¼˜åŒ–

| ä¼˜åŒ–æŠ€æœ¯ | è¯´æ˜ |
|----------|------|
| æ ˆåˆ†é…ä¼˜å…ˆ | å°å¯¹è±¡åˆ†é…åœ¨æ ˆä¸Š |
| å°å¯¹è±¡ä¼˜åŒ– | bump allocator å¿«é€Ÿåˆ†é… |
| å†…å­˜å¸ƒå±€ä¼˜åŒ– | ç»“æ„ä½“å­—æ®µé‡æ’å‡å°‘å¡«å…… |

### 4.3 ç¼“å­˜ä¼˜åŒ–

| ä¼˜åŒ–æŠ€æœ¯ | è¯´æ˜ |
|----------|------|
| æŒ‡ä»¤ç¼“å­˜ä¼˜åŒ– | çº¿æ€§ä»£ç å¸ƒå±€ |
| æ•°æ®ç¼“å­˜ä¼˜åŒ– | SoA å¸ƒå±€æé«˜å‘é‡åŒ– |

---

## äº”ã€JIT ç¼–è¯‘å™¨

### 5.1 åˆ†å±‚ç¼–è¯‘

| å±‚çº§ | è¯´æ˜ |
|------|------|
| è§£é‡Šå™¨ | ç«‹å³å¼€å§‹æ‰§è¡Œï¼Œæ”¶é›†ç±»å‹ä¿¡æ¯ |
| åŸºçº¿ç¼–è¯‘ | å¿«é€Ÿç”Ÿæˆæœºå™¨ç  |
| ä¼˜åŒ–ç¼–è¯‘ | åŸºäº profiling ä¼˜åŒ– |

### 5.2 ä»£ç ç”Ÿæˆ

```rust
pub trait CodeGenerator {
    fn emit_prologue(&mut self, frame: &Frame);
    fn emit_epilogue(&mut self, frame: &Frame);
    fn emit_add(&mut self, dst: Reg, lhs: Reg, rhs: Reg);
    fn emit_call(&mut self, func: Reg, args: Vec<Reg>, dst: Reg);
}
```

---

## å…­ã€è·¯çº¿å›¾

### 6.1 å®ç°é˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®ç°è·¯çº¿å›¾                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  v0.1: Rust è§£é‡Šå™¨ â”€â”€â”€â”€â”€â”€â”€â”€â†’ v0.5: Rust JIT ç¼–è¯‘å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â†’ v1.0: Rust AOT â”‚
â”‚        (å½“å‰é˜¶æ®µ)                        â”‚                      ç¼–è¯‘å™¨      â”‚
â”‚                                           â”‚                                   â”‚
â”‚                                           â–¼                                   â”‚
â”‚  v0.6: YaoXiang è§£é‡Šå™¨ â†â”€â”€â”€â”€â”€â”€â”€ v1.0: YaoXiang JIT ç¼–è¯‘å™¨ â†â”€â”€â”€â”€ v2.0:       â”‚
â”‚        ï¼ˆè‡ªä¸¾ï¼‰                     ï¼ˆè‡ªä¸¾ï¼‰                      YaoXiang AOT â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ—¶é—´ | äº¤ä»˜ç‰© |
|--------|------|--------|
| M1: è§£é‡Šå™¨åŸå‹ | ç¬¬ 1-2 ä¸ªæœˆ | åŸºæœ¬è§£é‡Šå™¨ |
| M2: å®Œæ•´è§£é‡Šå™¨ | ç¬¬ 3-4 ä¸ªæœˆ | åŠŸèƒ½å®Œæ•´çš„è§£é‡Šå™¨ |
| M3: JIT ç¼–è¯‘å™¨ | ç¬¬ 5-7 ä¸ªæœˆ | æ”¯æŒ JIT çš„è¿è¡Œæ—¶ |
| M4: AOT ç¼–è¯‘å™¨ | ç¬¬ 8-10 ä¸ªæœˆ | åŸç”Ÿç¼–è¯‘å™¨ |
| M5: è‡ªä¸¾ | ç¬¬ 11-14 ä¸ªæœˆ | è‡ªä¸¾ç¼–è¯‘å™¨ |

---

## ä¸ƒã€æµ‹è¯•ç­–ç•¥

### 7.1 æµ‹è¯•å±‚æ¬¡

| å±‚çº§ | è¯´æ˜ |
|------|------|
| å•å…ƒæµ‹è¯• | æµ‹è¯•å„ä¸ªæ¨¡å—çš„ç‹¬ç«‹åŠŸèƒ½ |
| é›†æˆæµ‹è¯• | æµ‹è¯•æ¨¡å—é—´çš„åä½œ |
| ç«¯åˆ°ç«¯æµ‹è¯• | æµ‹è¯•å®Œæ•´ç¨‹åºçš„æ‰§è¡Œ |
| æ¨¡ç³Šæµ‹è¯• | éšæœºæµ‹è¯•å‘ç°è¾¹ç•Œé—®é¢˜ |

### 7.2 æ€§èƒ½æµ‹è¯•

| æµ‹è¯•ç±»å‹ | è¯´æ˜ |
|----------|------|
| å¾®åŸºå‡†æµ‹è¯• | å•ä¸ªæ“ä½œçš„æ€§èƒ½ |
| å®åŸºå‡†æµ‹è¯• | å®Œæ•´ç¨‹åºçš„æ€§èƒ½ |
| å¹¶å‘æµ‹è¯• | å¹¶å‘æ€§èƒ½æµ‹è¯• |

---

## å…«ã€é£é™©ä¸åº”å¯¹

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|--------|------|----------|
| æ€§èƒ½ä¸è¾¾é¢„æœŸ | ä¸­ | é«˜ | æ¸è¿›ä¼˜åŒ–ã€JIT å‡çº§ |
| ç±»å‹ç³»ç»Ÿå¤æ‚åº¦è¿‡é«˜ | ä¸­ | ä¸­ | ç®€åŒ–å®ç°ã€è¿­ä»£å®Œå–„ |
| JIT å®ç°å›°éš¾ | ä¸­ | é«˜ | å…ˆå®Œæˆè§£é‡Šå™¨ |
| è‡ªä¸¾å›°éš¾ | ä½ | é«˜ | Rust å®ç°å…œåº• |

---

## ä¹ã€å¾…å®ç°ç‰¹æ€§æé†’ âš ï¸

> âš ï¸ **é‡è¦æé†’**ï¼šä»¥ä¸‹ç‰¹æ€§å°šæœªå®ç°ï¼Œå®ç°æ—¶è¯·å‚è€ƒæœ¬æé†’é¿å…é—æ¼ï¼

### 9.1 ä¸å¯å˜æ€§æ£€æŸ¥

**åŠŸèƒ½æè¿°**ï¼šç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œç¡®ä¿ä¸å¯å˜å˜é‡ï¼ˆé»˜è®¤ï¼‰ä¸ä¼šè¢«é‡æ–°èµ‹å€¼ã€‚

```yaoxiang
// âœ… æ­£ç¡® - å¯å˜å˜é‡
mut x = 10
x = 20  // å…è®¸

// âŒ é”™è¯¯ - ä¸å¯å˜å˜é‡
x = 10
x = 20  // åº”è¯¥æŠ¥é”™ï¼šcannot assign to immutable variable
```

**å®ç°ä½ç½®**ï¼š`src/frontend/typecheck/`

**å®ç°è¦æ±‚**ï¼š
1. åœ¨ `TypeEnvironment` ä¸­å­˜å‚¨å˜é‡çš„å¯å˜æ€§ä¿¡æ¯
2. åœ¨èµ‹å€¼è¡¨è¾¾å¼æ£€æŸ¥æ—¶ï¼ŒéªŒè¯ç›®æ ‡å˜é‡æ˜¯å¦å¯å˜
3. é”™è¯¯ç±»å‹å»ºè®®ï¼š`ImmutableAssignError { name: String, span: Span }`

**å‚è€ƒä»£ç ä½ç½®**ï¼š
- AST ä¸­å·²æœ‰ `StmtKind::Var { is_mut: bool }` å­—æ®µ
- `src/frontend/typecheck/check.rs` ä¸­çš„ `check_var` å‡½æ•°
- `src/frontend/typecheck/infer.rs` ä¸­çš„ `infer_var_decl` å‡½æ•°

---

## é™„å½•Aï¼šæŒ‡ä»¤é›†

### A.1 æŒ‡ä»¤ç¼–ç 

| ç±»åˆ« | æŒ‡ä»¤å‰ç¼€ | æ•°é‡ |
|------|----------|------|
| æ ˆæ“ä½œ | 0x00-0x0F | 16 |
| åŠ è½½å­˜å‚¨ | 0x10-0x2F | 32 |
| ç®—æœ¯è¿ç®— | 0x30-0x5F | 48 |
| æ¯”è¾ƒè·³è½¬ | 0x60-0x7F | 32 |
| å‡½æ•°è°ƒç”¨ | 0x80-0x8F | 16 |
| å†…å­˜åˆ†é… | 0x90-0x9F | 16 |
| ç±»å‹æ“ä½œ | 0xA0-0xAF | 16 |
| å¹¶å‘æ“ä½œ | 0xB0-0xBF | 16 |

### A.2 æ ¸å¿ƒæŒ‡ä»¤

| æŒ‡ä»¤ | æ“ä½œæ•° | è¯´æ˜ |
|------|--------|------|
| NOP | - | ç©ºæ“ä½œ |
| PUSH | const | å°†å¸¸é‡å‹æ ˆ |
| POP | reg | å¼¹æ ˆåˆ°å¯„å­˜å™¨ |
| DUP | - | å¤åˆ¶æ ˆé¡¶ |
| ADD | - | åŠ æ³• |
| SUB | - | å‡æ³• |
| MUL | - | ä¹˜æ³• |
| DIV | - | é™¤æ³• |
| CALL | func | å‡½æ•°è°ƒç”¨ |
| RET | - | è¿”å› |
| SPAWN | func | åˆ›å»ºå¼‚æ­¥ä»»åŠ¡ |
| AWAIT | - | ç­‰å¾…å¼‚æ­¥ä»»åŠ¡ |

---

> ã€Œé“ç”Ÿä¹‹ï¼Œå¾·ç•œä¹‹ï¼Œç‰©å½¢ä¹‹ï¼ŒåŠ¿æˆä¹‹ã€‚ã€
>
> ç¼–ç¨‹è¯­è¨€ä¹‹é“ï¼Œåœ¨äºè®¾è®¡ä¹‹å®Œå–„ã€å®ç°ä¹‹ç²¾è¿›ã€æ€§èƒ½ä¹‹ä¼˜åŒ–ã€‚
