# RFC-003：版本规划与实现建议

> **状态**: 长期审核中
> **作者**: 晨煦
> **创建日期**: 2025-01-05
> **最后更新**: 2025-01-05

## 摘要

提出 YaoXiang 的版本发布计划和分阶段实现策略，基于**组件化 Phase 设计**而非版本号划分，包含从 v0.1 到 v1.0 的路线图和各 Phase 详细计划链接。重点说明：
1. **字节码中间形态**：用于支持交互式环境（REPL）和渐进式编译
2. **自举（Bootstrap）**：使用 YaoXiang 自身编写 YaoXiang 编译器
3. **AOT 编译**：将字节码编译为本地机器码，实现更高性能

## 动机

### 为什么需要清晰的版本规划？

- **项目管理**：将宏大目标分解为可执行的里程碑
- **用户预期**：让用户了解语言的发展阶段和成熟度
- **资源分配**：明确每个阶段的重点和优先级
- **风险控制**：及时发现问题并调整方向

### 核心设计决策

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           YaoXiang 编译策略三层设计                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌───────────────────────────────────────────────────────────────────────────────┐      │
│  │  Layer 1: 字节码编译（当前阶段）                                               │      │
│  │                                                                               │      │
│  │  Source Code ──▶ Bytecode (.yxb) ──▶ VM 解释执行                              │      │
│  │                                                                               │      │
│  │  目的：                                                                        │      │
│  │  • 支持交互式 REPL 环境                                                        │      │
│  │  • 渐进式编译（增量编译）                                                      │      │
│  │  • 快速迭代开发                                                                │      │
│  │  • 平台无关的编译产物                                                          │      │
│  └───────────────────────────────────────────────────────────────────────────────┘      │
│                                      │                                                   │
│                                      ▼                                                   │
│  ┌───────────────────────────────────────────────────────────────────────────────┐      │
│  │  Layer 2: 自举（Bootstrap）                                                   │      │
│  │                                                                               │      │
│  │  YaoXiang 编译器 v0.x (Rust) ──▶ YaoXiang 编译器 v1.0 (YaoXiang)             │      │
│  │                                                                               │      │
│  │  目的：                                                                        │      │
│  │  • 验证语言的表达能力                                                          │      │
│  │  • 证明语言已可用于实际开发                                                    │      │
│  │  • 减少对宿主语言（Rust）的依赖                                                │      │
│  └───────────────────────────────────────────────────────────────────────────────┘      │
│                                      │                                                   │
│                                      ▼                                                   │
│  ┌───────────────────────────────────────────────────────────────────────────────┐      │
│  │  Layer 3: AOT 编译（未来阶段）                                                │      │
│  │                                                                               │      │
│  │  Source Code ──▶ Machine Code ──▶ 直接运行                                    │      │
│  │       │                                                                        │      │
│  │       ▼                                                                        │      │
│  │  Bytecode ──▶┌──────────┐                                                      │      │
│  │              │  AOT      │                                                      │      │
│  │              │  Compiler │                                                      │      │
│  │              └──────────┘                                                      │      │
│  │                                                                               │      │
│  │  目的：                                                                        │      │
│  │  • 达到原生编译语言的性能                                                      │      │
│  │  • 消除 VM 解释开销                                                            │      │
│  │  • 生成独立可执行文件                                                          │      │
│  └───────────────────────────────────────────────────────────────────────────────┘      │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 字节码中间形态的设计目的

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           字节码中间形态的核心价值                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  1. 交互式 REPL 支持                                                                   │
│     ┌─────────────────────────────────────────────────────────────────────────────┐    │
│     │  $ yaoxiang                                                                     │    │
│     │  YaoXiang 0.3.0 REPL                                                           │    │
│     │  > let x = 42                                                                   │    │
│     │  x: Int = 42                                                                    │    │
│     │  > fn add(a, b) => a + b                                                       │    │
│     │  add: (a: Int, b: Int) -> Int                                                  │    │
│     │  > add(x, 100)                                                                  │    │
│     │  142                                                                             │    │
│     │                                                                                 │    │
│     │  实现方式：即时编译输入代码为字节码，然后 VM 解释执行                           │    │
│     └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                          │
│  2. 渐进式编译                                                                         │
│     ┌─────────────────────────────────────────────────────────────────────────────┐    │
│     │  修改单个函数后，只需重新编译该函数对应的字节码                                │    │
│     │  无需重新编译整个项目                                                         │    │
│     │                                                                                 │    │
│     │  优势：编译速度更快，适合大型项目开发                                           │    │
│     └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                          │
│  3. 平台无关性                                                                         │
│     ┌─────────────────────────────────────────────────────────────────────────────┐    │
│     │  .yxb 文件可以在任何平台运行                                                  │    │
│     │  只需安装对应平台的 VM 即可                                                   │    │
│     │                                                                                 │    │
│     │  类似于 Java 的 .class 文件，实现 Write Once Run Anywhere                      │    │
│     └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 核心原则

```
渐进式交付 ──→ 每个版本都有可用功能
向后兼容 ──→ 避免破坏性变更
质量优先 ──→ 每个版本都经过充分测试
自举验证 ──→ 通过自举证明语言表达能力
性能优化 ──→ AOT 编译实现原生性能
```

## 提案

### 1. 组件化 Phase 设计

#### 1.1 Phase 概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           YaoXiang 组件架构                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Phase 1          Phase 2          Phase 3          Phase 4          Phase 5│
│   ────────         ────────         ────────         ────────         ────────│
│   词法分析器   →   类型检查器   →   字节码生成   →     虚拟机      →   标准库  │
│   (完成)          (完成)          (基本完成)        (进行中)        (部分)    │
│                                                                             │
│   src/frontend/    src/frontend/    src/middle/      src/vm/         src/std/ │
│   lexer/           typecheck/       codegen/         runtime/                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 1.2 各 Phase 详细计划

| Phase | 模块 | 状态 | 详细计划 |
|-------|------|------|----------|
| **Phase 1** | 词法分析器 | ✅ 完成 | [01-lexer.md](../../.claude/plan/phase/01-lexer.md) |
| **Phase 2** | 类型检查器 | ✅ 完成 | [02-typecheck.md](../../.claude/plan/phase/02-typecheck.md) |
| **Phase 3** | 字节码生成器 | ⚠️ 基本完成 | [03-codegen.md](../../.claude/plan/phase/03-codegen.md) |
| **Phase 4** | 虚拟机 | 🔶 进行中 | [04-vm.md](../../.claude/plan/phase/04-vm.md) |
| **Phase 5** | 标准库 | ⚠️ 部分完成 | [05-stdlib.md](../../.claude/plan/phase/05-stdlib.md) |

### 2. 版本路线图

#### 2.1 总体时间线

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        YaoXiang 完整发展路线图                                                     │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                  │
│  Phase 1&2   Phase 3      Phase 4          Phase 5         Phase 6         Phase 7         Phase 8              │
│    │          │            │                │               │               │               │                   │
│    ▼          ▼            ▼                ▼               ▼               ▼               ▼                   │
│  v0.1 ────── v0.2 ─────── v0.3 ─────────── v0.5 ────────── v0.7 ────────── v0.9 ────────── v1.0              │
│    │          │            │                │               │               │               │                   │
│    │          │            │                │               │               │               │                   │
│  同步核心   字节码生成   完整虚拟机       标准库完善       自举编译        AOT 编译       稳定发布              │
│ (词法+类型) (codegen)   (VM+并发)        (Rust生态)      (YaoXiang写)    (机器码)       (生产可用)            │
│                                                                                                                  │
│  ════════════════════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                  编译策略演进                                                        │
│  ════════════════════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                                  │
│  Layer 1: 字节码编译 ─────────────────────────────────────────────────────────────────────────────────────▶  │
│            (当前)          REPL + 渐进式编译                                                                  │
│                                                                                                                  │
│  Layer 2: 自举 ──────────────────────────────────────────────────────────────────────────────────────────▶  │
│            (v0.9)         YaoXiang 编译器自编写                                                               │
│                                                                                                                  │
│  Layer 3: AOT 编译 ───────────────────────────────────────────────────────────────────────────────────────▶  │
│            (v1.0)         生成机器码，原生性能                                                                 │
│                                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.2 各版本详情

| 版本 | 目标 | 时间 | 核心特性 | 成熟度 |
|------|------|------|----------|--------|
| **v0.1** | 同步核心 | 1-2月 | 词法分析器、类型检查器、REPL | 原型 |
| **v0.2** | 字节码生成 | 2-3月 | IR转换、字节码生成、指令集 | 试验 |
| **v0.3** | 完整虚拟机 | 2-3月 | 指令执行、内存管理、并发调度 | 预览 |
| **v0.5** | 标准库完善 | 3-4月 | IO、字典、网络、并发标准库 | 测试 |
| **v0.7** | 优化稳定 | 2-3月 | 性能优化、工具链完善、文档 | 稳定 |
| **v0.9** | 自举编译 | 3-4月 | YaoXiang 编译器自编写、减少 Rust 依赖 | 预发布 |
| **v1.0** | AOT + 稳定 | 3-4月 | AOT 机器码编译、生产可用 | 生产 |

#### 2.3 三层编译策略详解

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        编译策略三层详解                                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  Layer 1: 字节码编译（v0.1 - v0.7）                                                                     │  │
│  │                                                                                                         │  │
│  │  $ yaoxiang compile script.yx  ──▶  script.yxb  ──▶  yaoxiang run script.yxb                         │  │
│  │                                                                                                         │  │
│  │  编译产物：.yxb 字节码文件                                                                              │  │
│  │  执行方式：VM 解释执行                                                                                  │  │
│  │  适用场景：开发、测试、交互式 REPL                                                                      │  │
│  │  性能级别：解释执行，性能中等                                                                           │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  Layer 2: 自举编译（v0.9）                                                                              │  │
│  │                                                                                                         │  │
│  │  阶段 1: 用 Rust 编写 YaoXiang 编译器（当前）                                                           │  │
│  │      └── yaoxiang compiler (Rust) 编译 yaoxiang 代码                                                   │  │
│  │                                                                                                         │  │
│  │  阶段 2: 用 YaoXiang 重写编译器核心模块                                                                 │  │
│  │      └── yaoxiang compiler (YaoXiang) 编译 yaoxiang 代码                                               │  │
│  │                                                                                                         │  │
│  │  阶段 3: 验证自举编译器                                                                                 │  │
│  │      └── 两个编译器编译同一代码，结果一致                                                               │  │
│  │                                                                                                         │  │
│  │  目的：验证语言表达能力，减少外部依赖                                                                   │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  Layer 3: AOT 编译（v1.0）                                                                              │  │
│  │                                                                                                         │  │
│  │  $ yaoxiang compile --aot script.yx  ──▶  script  (可执行文件)                                         │  │
│  │                                                                                                         │  │
│  │  编译产物：平台相关的机器码可执行文件                                                                   │  │
│  │  执行方式：直接运行，无需 VM                                                                            │  │
│  │  适用场景：生产部署、性能敏感应用                                                                       │  │
│  │  性能级别：原生编译性能，最高                                                                           │  │
│  │                                                                                                         │  │
│  │  技术方案：                                                                                             │  │
│  │  • LLVM 后端：使用 LLVM 生成高质量机器码（推荐）                                                        │  │
│  │  • 自研后端：纯 YaoXiang 实现 AOT 编译（长期目标）                                                      │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3 编译阶段划分表（RFC-008 对齐版）

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                           编译阶段详细划分（RFC-008 对齐）                                                  │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                            │
│  ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  阶段  │  输入              │  输出              │  对应 Phase  │  所有模式      │  版本     │  说明              │  │
│  ├────────┼────────────────────┼────────────────────┼──────────────┼────────────────┼───────────┼────────────────────┤  │
│  │  1     │  源代码 (.yx)      │  Token 流          │  P1          │  ✅ 相同       │  v0.1+    │  Lexer             │  │
│  │  2     │  Token 流          │  AST               │  P2          │  ✅ 相同       │  v0.1+    │  Parser            │  │
│  │  3     │  AST               │  typed AST         │  P3          │  ✅ 相同       │  v0.1+    │  TypeCheck         │  │
│  │  4     │  typed AST         │  IR / Bytecode     │  P4          │  ✅ 相同       │  v0.2+    │  Codegen           │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────────────────────────────────  │  │
│  │  5     │  IR/Bytecode       │  编译期优化        │  P5-P7       │  ✅ 相同       │  v0.3+    │  优化阶段          │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────────────────────────────────  │  │
│  │  6a    │  Bytecode          │  即时执行结果      │  P12         │  Embedded     │  v0.3+    │  Embedded 模式     │  │
│  │  6b    │  Bytecode          │  DAG 调度执行      │  P9-P11      │  Standard     │  v0.3+    │  Standard 模式     │  │
│  │  6c    │  Bytecode          │  并行 + WS 执行    │  P9-P14      │  Full         │  v0.5+    │  Full 模式         │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────────────────────────────────  │  │
│  │  7     │  源代码            │  即时编译+执行     │  P1-P6       │  ✅ 相同       │  v0.1+    │  REPL              │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────────────────────────────────  │  │
│  │  8     │  YaoXiang 源码     │  Bytecode          │  P1-P17      │  ✅ 相同       │  v0.9+    │  Bootstrap         │  │
│  │  9     │  Bytecode/源码     │  机器码            │  P18         │  ✅ 相同       │  v1.0+    │  AOT               │  │
│  └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                            │
│  关键说明：                                                                                                                 │
│  • 阶段 1-5 是纯编译期处理，嵌入式/Standard/Full 共享同一套前端代码（见 plan/PHASE-IMPLEMENTATION-PLAN.md）                  │
│  • 阶段 6 区分三种运行时模式（见 RFC-008 三层架构）：                                                                        │
│  │   ├── 6a Embedded：即时执行（P12），无 DAG 调度                                                                        │
│  │   ├── 6b Standard：DAG + Scheduler + VM（P9-P11），惰性求值 + 并发调度                                                 │
│  │   └── 6c Full：Standard + WorkStealer + @blocking（P9-P14），并行优化                                                   │
│  • 阶段 7 是交互式环境，基于阶段 6 的运行时                                                                                  │
│  • 阶段 8-9 是未来扩展，需要先完成自举和 AOT 基础设施                                                                        │
│                                                                                                                            │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

> **详见**：[Phase 实现方案（RFC-008 对齐版）](../../plan/PHASE-IMPLEMENTATION-PLAN.md)
```

#### 2.4 自举验证策略

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        自举编译验证策略                                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                  │
│  自举目标版本：v0.9                                                                                              │
│                                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  阶段 A: 核心模块重写                                                                                    │  │
│  │                                                                                                         │  │
│  │  ┌────────────────────┐    ┌────────────────────┐    ┌────────────────────┐                           │  │
│  │  │  Lexer (Rust)      │ ──▶│  Lexer (YaoXiang)  │ ──▶│  功能等价 ✓         │                           │  │
│  │  └────────────────────┘    └────────────────────┘    └────────────────────┘                           │  │
│  │                                                                                                         │  │
│  │  优先级：1. Lexer → 2. Parser → 3. TypeChecker → 4. Codegen                                           │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  阶段 B: 交叉编译验证                                                                                    │  │
│  │                                                                                                         │  │
│  │  用 Rust 编译器编译 YaoXiang Lexer 源码 ──▶ 生成字节码 ──▶ 用 YaoXiang Lexer 编译同一源码              │  │
│  │                                                                                                         │  │
│  │  结果验证：两个编译器生成的字节码完全一致 ✓                                                               │  │
│  │                                                                                                         │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  阶段 C: 渐进式替换                                                                                      │  │
│  │                                                                                                         │  │
│  │  第1步：用 Rust 编译器编译整个项目                                                                       │  │
│  │  第2步：将 Lexer 替换为 YaoXiang 实现（Bootstrapped）                                                    │  │
│  │  第3步：用新编译器继续替换 Parser                                                                        │  │
│  │  ...                                                                                                    │  │
│  │  第N步：完全自举                                                                                         │  │
│  │                                                                                                         │  │
│  │  好处：每一步都可验证，降低风险                                                                          │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.5 AOT 编译技术方案

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        AOT 编译技术方案                                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                  │
│  目标版本：v1.0                                                                                                  │
│                                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  方案 1: LLVM 后端（推荐，优先实现）                                                                     │  │
│  │                                                                                                         │  │
│  │  优势：                                                                                                  │  │
│  │  • LLVM 经过多年验证，代码质量高                                                                        │  │
│  │  • 支持多平台（x86, ARM, WASM, etc.）                                                                   │  │
│  │  • 优化能力强（死代码消除、循环展开、内联等）                                                            │  │
│  │  • 社区活跃，持续维护                                                                                    │  │
│  │                                                                                                         │  │
│  │  劣势：                                                                                                  │  │
│  │  • LLVM 库体积较大                                                                                       │  │
│  │  • 依赖 LLVM 版本                                                                                        │  │
│  │  • 学习曲线陡峭                                                                                          │  │
│  │                                                                                                         │  │
│  │  实现方式：                                                                                              │  │
│  │  Bytecode ──▶ LLVM IR ──▶ LLVM Optimizer ──▶ Machine Code                                               │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  方案 2: 自研后端（长期目标）                                                                            │  │
│  │                                                                                                         │  │
│  │  优势：                                                                                                  │  │
│  │  • 完全掌控编译流程                                                                                      │  │
│  │  • 可针对 YaoXiang 特性做专门优化                                                                        │  │
│  │  • 减少外部依赖                                                                                          │  │
│  │                                                                                                         │  │
│  │  劣势：                                                                                                  │  │
│  │  • 开发成本高                                                                                            │  │
│  │  • 需要支持多个平台                                                                                      │  │
│  │  • 优化能力需要长期积累                                                                                  │  │
│  │                                                                                                         │  │
│  │  策略：先实现简单平台（如 x86-64 Linux），逐步扩展                                                        │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

#### 2.6 版本发布标准

```
v0.x 系列：
  - 功能完整但可能存在边界情况问题
  - API可能变更
  - 仅供学习和试验

v1.0：
  - 所有核心功能稳定
  - API冻结
  - 适合生产使用
  - 完整的文档和教程
```

#### 2.7 运行时分层架构（RFC-008）

> **详见**：[RFC-008: Runtime 并发模型与调度器脱耦设计](./008-runtime-concurrency-model.md)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    YaoXiang 运行时分层架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│  📦 编译阶段（所有模式相同）                                                │
│     Source Code ──▶ Lexer ──▶ Parser ──▶ TypeCheck ──▶ Codegen ──▶ Bytecode│
│                                                                             │
│     ┌───────────────────────────────────────────────────────────────────┐   │
│     │ 🟢 Embedded     │  🔵 Standard        │  🟣 Full                 │   │
│     │ 即时执行器       │  DAG + Scheduler   │  Full + WorkStealer     │   │
│     │ 无 DAG 调度     │  num_workers 可配置│  @blocking              │   │
│     └───────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  运行时        │ 编译阶段  │ 运行时组件        │ 版本   │ 目标场景           │
│  ──────────────┼───────────┼───────────────────┼────────┼────────────────   │
│  Embedded      │ 相同      │ 即时执行器        │ v0.3+  │ WASM/游戏脚本     │
│  Standard      │ 相同      │ DAG + Scheduler   │ v0.3+  │ Web服务/数据流    │
│  Full          │ 相同      │ Standard + WS     │ v0.5+  │ 科学计算/并行     │
└─────────────────────────────────────────────────────────────────────────────┘
```

**运行时切换机制**：
- 向下切换：Full ──▶ Standard ──▶ Embedded
- 向上切换：不可能（Embedded 无法切换到更高层）
- 切换方式：编译时 feature flag / 运行时标准库

**调度器接口标准化**：
- 使用 YaoXiang 泛型 `[S]` 实现调度器脱耦
- 无需 Trait，编译期多态
- 支持单线程/多线程/WorkStealer 调度器注入

### 3. Phase 1：词法分析器 ✅ 完成

**详细计划**: [01-lexer.md](../../.claude/plan/phase/01-lexer.md)

**完成状态**：
- ✅ 17 个关键字识别
- ✅ 标识符和字面量
- ✅ 运算符和分隔符
- ✅ 注释支持
- ✅ 位置追踪
- ✅ 错误处理

**文件位置**: `src/frontend/lexer/`

### 4. Phase 2：类型检查器 ✅ 完成

**详细计划**: [02-typecheck.md](../../.claude/plan/phase/02-typecheck.md)

**完成状态**：
- ✅ Hindley-Milner 类型推断
- ✅ 泛型函数和泛型类型
- ✅ 合一算法（Unification）
- ✅ 类型约束求解
- ✅ 错误收集和报告

**文件位置**: `src/frontend/typecheck/`

### 5. Phase 3：字节码生成器 ⚠️ 基本完成

**详细计划**: [03-codegen.md](../../.claude/plan/phase/03-codegen.md)

**完成状态**：
- ✅ 基本块生成
- ✅ 表达式翻译（算术、比较）
- ✅ 控制流（if/else, while, for）
- ✅ Match/switch 模式匹配
- ⚠️ 完整函数调用（待完善）
- ⚠️ 闭包支持（待完善）
- ❌ 逃逸分析（未实现）

**文件位置**: `src/middle/codegen/`

**下一步任务**：
1. 完善函数调用协议
2. 完善闭包支持
3. 实现逃逸分析

### 6. Phase 4：虚拟机 🔶 进行中

**详细计划**: [04-vm.md](../../.claude/plan/phase/04-vm.md)

**完成状态**：
- ✅ 虚拟机核心架构
- ✅ 调用帧管理
- ✅ 基础指令解释器
- ✅ 内联缓存
- ⚠️ 工作窃取调度器（基础）
- ⚠️ DAG 依赖分析（基础）
- ❌ 垃圾回收器（未实现）
- ❌ 所有权运行时（未实现）

**文件位置**: `src/vm/`, `src/runtime/`

**下一步任务**：
1. 完善指令实现
2. 实现基本 GC
3. 完善工作窃取调度器

### 7. Phase 5：标准库 ⚠️ 部分完成

**详细计划**: [05-stdlib.md](../../.claude/plan/phase/05-stdlib.md)

**完成状态**：
- ✅ 列表（List）
- ⚠️ IO（基础）
- ⚠️ 字典（基础）
- ⚠️ 字符串（基础）
- ⚠️ 数学（基础）
- ⚠️ 网络（基础）
- ⚠️ 并发（基础）
- ❌ 格式化（未实现）
- ❌ 时间（未实现）
- ❌ JSON（未实现）

**文件位置**: `src/std/`

**下一步任务**：
1. 完善 IO 模块
2. 实现 fmt 模块
3. 实现 time 模块

### 8. 生态建设策略

#### 8.1 寄生策略

| 阶段 | 策略 | 说明 |
|------|------|------|
| **短期** | 调用 Rust 库 | 复用 crates.io 生态，寄生 Cargo |
| **中期** | 多目标编译 | WASM（浏览器）、JVM、.NET |
| **长期** | 自建生态 | 标准库、包管理器、第三方库 |

#### 8.2 当前依赖

```toml
[dependencies]
# 并发和线程安全
parking_lot = "0.12"
crossbeam = "0.8"
rayon = "1.10"
once_cell = "1.19"
atomic = "0.6"

# 数据结构
indexmap = "2.12.1"
hashbrown = "0.16.1"
smallvec = "1.15.1"

# 字符串处理
regex = "1"
unicode-ident = "1.0"

# 文件系统
walkdir = "2"
tempfile = "3"

# 序列化
serde = { version = "1", features = ["derive"] }
ron = "0.12.0"

# 网络
tokio = { version = "1", features = ["full"] }
```

### 9. 工具链优先策略

```
工具链开发优先级：
┌─────────────────────────────────────────────────────────────┐
│  第一阶段（v0.1-v0.2）                                       │
│  ├── yaoxiang-cli     命令行工具                            │
│  ├── yaoxiang-fmt     代码格式化（基于AST）                  │
│  └── yaoxiang-lsp     基础LSP支持                           │
├─────────────────────────────────────────────────────────────┤
│  第二阶段（v0.3-v0.5）                                       │
│  ├── yaoxiang-clippy  静态分析、代码质量                    │
│  ├── yaoxiang-debug   基础调试支持                          │
│  └── yaoxiang-test    测试框架                              │
├─────────────────────────────────────────────────────────────┤
│  第三阶段（v0.7-v1.0）                                       │
│  ├── yaoxiang-debug   图形化调试器（DAG可视化）              │
│  ├── yaoxiang-profile 性能分析器                            │
│  └── yaoxiang-doc     文档生成器                            │
└─────────────────────────────────────────────────────────────┘
```

### 10. 成功指标

#### 10.1 技术指标

| 指标 | v0.1目标 | v0.3目标 | v0.7目标 | v0.9目标 | v1.0目标 |
|------|----------|----------|----------|----------|----------|
| 编译速度 | < 5s | < 5s | < 3s | < 2s | < 2s |
| 解释执行 | 基础正确 | 完整正确 | 优化执行 | 优化执行 | 高效执行 |
| 并行效率 | N/A | 40%线性 | 60%线性 | 70%线性 | 80%线性 |
| 错误消息 | 基础 | 清晰 | 友好+建议 | 友好+定位 | 友好+定位 |
| 覆盖率 | 70% | 80% | 90% | 92% | 95% |
| **自举验证** | ❌ | ❌ | ❌ | ✅ 核心模块 | ✅ 完全自举 |
| **AOT 编译** | ❌ | ❌ | ❌ | ❌ | ✅ 机器码 |

#### 10.2 组件成熟度

| 组件 | v0.1 | v0.3 | v0.7 | v0.9 | v1.0 |
|------|------|------|------|------|------|
| 词法分析器 | ✅ | ✅ | ✅ | ✅(自举) | ✅ |
| 类型检查器 | ✅ | ✅ | ✅ | ✅(自举) | ✅ |
| 字节码生成 | ⚠️ | ✅ | ✅ | ✅(自举) | ✅ |
| 虚拟机 | ❌ | ⚠️ | ✅ | ✅ | ✅ |
| 标准库 | ❌ | ⚠️ | ⚠️ | ✅ | ✅ |
| 工具链 | ❌ | ⚠️ | ⚠️ | ✅ | ✅ |
| **自举编译器** | ❌ | ❌ | ❌ | ⚠️ 核心 | ✅ 完全 |

## 权衡

### 优点

1. **渐进式交付**：每个版本都有可用的功能
2. **风险可控**：小步快跑，及时发现问题
3. **组件解耦**：各 Phase 独立开发和测试
4. **用户友好**：清晰的升级路径

### 缺点

1. **前期功能受限**：v0.1 功能有限
2. **API 可能变更**：v1.0 前不稳定
3. **资源投入**：多版本维护成本

## 开放问题

- [ ] JIT 编译的时机选择（AOT vs JIT）
- [ ] 标准库的范围界定（内置 vs 外部库）
- [ ] 包管理器的设计决策
- [ ] 长期维护策略
- [ ] 社区治理模式
- [ ] 自举模块替换顺序（优先级问题）
- [ ] 自举编译器的交叉验证策略
- [ ] AOT 后端技术选型（LLVM vs 自研）
- [ ] 嵌入式运行时对自举的影响

## 参考文献

- [语义化版本 2.0.0](https://semver.org/lang/zh-CN/)
- [Rust 发布模型](https://forge.rust-lang.org/release.html)
- [Chrome 版本发布](https://www.chromium.org/developers/calendars/)
- [SemVer 最佳实践](https://doc.rust-lang.org/cargo/reference/semver.html)
- [RFC-001: 并作模型与错误处理系统](./001-concurrent-model-error-handling.md)
- [RFC-008: Runtime 并发模型与调度器脱耦设计](./008-runtime-concurrency-model.md)
