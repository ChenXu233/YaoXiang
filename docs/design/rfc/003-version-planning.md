# RFC-003：版本规划

> **状态**: 长期审核中
> **作者**: 晨煦
> **创建日期**: 2025-01-05
> **最后更新**: 2025-01-06

## 摘要

YaoXiang 的版本发布计划，从 v0.1 到 v1.0 的路线图。

**核心目标**：
1. **字节码编译**：支持 REPL 和渐进式编译
2. **自举 (Bootstrap)**：使用 YaoXiang 编写 YaoXiang 编译器
3. **AOT 编译**：字节码编译为本地机器码

## 一、动机

### 为什么需要版本规划？

1. **项目管理**：将目标分解为可执行的里程碑
2. **用户预期**：让用户了解语言的发展阶段
3. **资源分配**：明确每个阶段的重点
4. **风险控制**：及时发现问题并调整方向

### 核心设计决策

- **字节码优先**：先实现解释执行，再考虑 AOT
- **渐进式交付**：每个版本都有可用功能
- **向后兼容**：v1.0 前 API 可能变更，但会提前公告
- **自举验证**：通过自举证明语言表达能力
- **性能分层**：先跑通，再优化

## 二、组件状态 (Phase)

| Phase | 模块 | 状态 | 位置 |
|-------|------|------|------|
| P1 | 词法分析器 | ✅ 完成 | `src/frontend/lexer/` |
| P2 | 类型检查器 | ✅ 完成 | `src/frontend/typecheck/` |
| P3 | 字节码生成器 | ⚠️ 基本完成 | `src/middle/codegen/` |
| P4 | 虚拟机 | 🔶 进行中 | `src/vm/`, `src/runtime/` |
| P5 | 标准库 | ⚠️ 部分完成 | `src/std/` |

**下一步优先**：完成 P3（函数调用、闭包）→ 完善 P4（指令实现、基本 GC）

## 三、版本路线图

### v0.1：可运行里程碑

**目标**：端到端运行 Hello World

```
$ yaoxiang compile hello.yx -o hello.yxb
$ yaoxiang run hello.yxb
Hello, YaoXiang!
```

**完成标准**：
- 词法分析、语法分析、类型检查完整
- 字节码生成可用
- VM 能解释执行基本程序
- print 函数可用

**未包含**：GC（可用引用计数/手动管理）、完整 DAG 调度（用简单调度替代）

### v0.3：并发预览

**目标**：支持基础并发

- DAG 任务依赖图
- 基础调度器
- spawn 并发

### v0.5：标准库完善

**目标**：可用性提升

- IO、字典、网络模块
- 工具链（fmt、基础 LSP）
- 性能优化

### v0.7：稳定版本

**目标**：API 趋于稳定

- 完整文档
- 工具链完善
- 边界情况修复

### v0.9：自举开始

**目标**：核心模块用 YaoXiang 重写

- Lexer → Parser → TypeChecker → Codegen 逐步替换
- 交叉验证：两个编译器结果一致

### v1.0：生产可用

**目标**：稳定发布

- 完整自举
- AOT 编译（LLVM 后端）
- 生产可用

## 四、编译策略三层设计

| 层级 | 版本 | 输入 | 输出 | 说明 |
|------|------|------|------|------|
| L1: 字节码 | v0.1+ | 源码 (.yx) | 字节码 (.yxb) | VM 解释执行 |
| L2: 自举 | v0.9+ | YaoXiang 源码 | 字节码 | 自己编译自己 |
| L3: AOT | v1.0+ | 源码/字节码 | 机器码 | 原生性能 |

**字节码优先的理由**：
1. **REPL 支持**：即时编译输入代码，交互式开发
2. **渐进式编译**：修改单个函数只需重新编译该部分
3. **平台无关**：.yxb 文件跨平台运行，只需对应平台的 VM

## 五、依赖策略

**短期**：调用 Rust 库复用 crates.io（Cargo 寄生）

**当前依赖**：
- 并发：parking_lot, crossbeam, rayon
- 数据结构：indexmap, hashbrown, smallvec
- 网络：tokio
- 序列化：serde, ron

**长期**：自建标准库和包管理器

## 六、工具链

| 版本 | 工具 |
|------|------|
| v0.1 | yaoxiang-cli |
| v0.3 | yaoxiang-fmt, yaoxiang-lsp (基础) |
| v0.5 | yaoxiang-clippy, yaoxiang-debug |
| v1.0 | 完整工具链 |

## 七、成功指标

| 指标 | v0.1 | v0.3 | v0.5 | v1.0 |
|------|------|------|------|------|
| 端到端运行 | ✅ | ✅ | ✅ | ✅ |
| 并发支持 | ❌ | ✅ 基础 | ✅ 完整 | ✅ |
| 标准库 | 基础 | 基础 | 完善 | 完整 |
| 自举 | ❌ | ❌ | ❌ | ✅ |
| AOT | ❌ | ❌ | ❌ | ✅ |
| 代码覆盖率 | 70% | 80% | 90% | 95% |

## 八、开放问题

- [ ] JIT vs AOT 时机选择
- [ ] 包管理器设计
- [ ] 自举模块替换顺序
- [ ] AOT 后端选型（LLVM vs 自研）

## 九、版本发布标准

**v0.x 系列**：
- 功能完整但可能存在边界情况问题
- API 可能变更
- 仅供学习和试验

**v1.0**：
- 所有核心功能稳定
- API 冻结
- 适合生产使用
- 完整的文档和教程

## 参考

- [语义化版本 2.0.0](https://semver.org/lang/zh-CN/)
- [Rust 发布模型](https://forge.rust-lang.org/release.html)
- [RFC-001: 并发模型与错误处理](./001-concurrent-model-error-handling.md)
- [RFC-008: Runtime 并发模型](./008-runtime-concurrency-model.md)
