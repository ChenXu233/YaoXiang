# RFC 013: 错误代码规范

> **状态**: 草案
> **作者**: Claude
> **创建日期**: 2026-02-02
> **最后更新**: 2026-02-02

## 摘要

本 RFC 提出 YaoXiang 编译器的错误代码分类规范，采用类似 Rust 的分层编号系统，将错误代码按功能模块分组，便于用户理解、文档组织和工具集成。

## 动机

### 为什么需要标准化的错误代码？

1. **用户体验**：用户看到错误代码能快速判断错误类型和严重程度
2. **文档组织**：按类别分组便于编写和维护错误参考文档
3. **工具集成**：IDE 和其他工具可以根据错误代码提供快速修复建议
4. **国际化支持**：错误代码与消息分离，便于多语言翻译

### 当前的问题

当前错误代码采用简单顺序编号（如 E0001, E0002...），存在以下问题：
- 无法从代码判断错误类别
- 扩展新错误类型时没有明确规则
- 与 Rust 等主流语言的风格不一致

## 提案

### 核心设计：分层编号系统

采用四位数字编号，前两位表示类别，后两位表示该类别内的序号：

```
Exxxx
││││
│││└── 类别内序号 (01-99)
││└─── 子类别 (0-9)
└───── 主类别 (0-9)
```

### 主类别划分

| 主类别 | 范围 | 描述 |
|--------|------|------|
| **0** | E01xx-E09xx | 词法与语法分析 |
| **1** | E10xx-E19xx | 类型检查 |
| **2** | E20xx-E29xx | 语义分析 |
| **3** | E30xx-E39xx | 代码生成 |
| **4** | E40xx-E49xx | 泛型与特质 |
| **5** | E50xx-E59xx | 模块与导入 |
| **6** | E60xx-E69xx | 运行时错误 |
| **7** | E70xx-E79xx | I/O 与系统错误 |
| **8** | E80xx-E89xx | 内部编译器错误 |
| **9** | E90xx-E99xx | 保留/实验性 |

### 子类别划分

以类型检查（1xx）为例：

| 子类别 | 范围 | 描述 |
|--------|------|------|
| **10x** | E10xx | 基础类型错误 |
| **11x** | E11xx | 变量相关错误 |
| **12x** | E12xx | 函数调用错误 |
| **13x** | E13xx | 类型推断错误 |
| **14x** | E14xx | 模式匹配错误 |
| **15x** | E15xx | 类型转换错误 |

---

## 详细设计

### 完整错误代码列表

#### E01xx-E02xx：词法与语法分析

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E0101 | 无效字符 | 源代码包含非法字符 |
| E0102 | 数字字面量格式错误 | 数字格式不正确 |
| E0103 | 字符串未终止 | 多行字符串缺少结束引号 |
| E0104 | 字符字面量格式错误 | 字符字面量不正确 |
| E0201 | 期望的 token | 语法分析时期望特定 token |
| E0202 | 意外的 token | 遇到意外的 token |
| E0203 | 语法无效 | 表达式/语句语法错误 |
| E0204 | 括号不匹配 | 圆括号、方括号、花括号不匹配 |
| E0205 | 缺少分号 | 语句末尾缺少分号 |

#### E10xx-E11xx：类型基础错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E1001 | 类型不匹配 | 期望类型与实际类型不符 |
| E1002 | 未知类型 | 引用的类型不存在 |
| E1003 | 类型定义无效 | 类型定义语法错误 |
| E1004 | 基本类型重复定义 | 尝试重新定义基本类型 |
| E1010 | 整数溢出 | 整数常量超出范围 |

#### E11xx-E12xx：变量相关错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E1101 | 未知变量 | 引用的变量未定义 |
| E1102 | 变量遮蔽 | 同名变量遮蔽外层变量（警告） |
| E1103 | 不可变赋值 | 尝试修改不可变变量 |
| E1104 | 未初始化使用 | 使用未初始化的变量 |
| E1105 | 可变性冲突 | 不可变上下文中使用可变引用 |

#### E12xx-E13xx：函数调用错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E1201 | 参数数量不匹配 | 函数调用参数数量与定义不符 |
| E1202 | 参数类型不匹配 | 参数类型检查失败 |
| E1203 | 返回类型不匹配 | 函数返回值类型错误 |
| E1204 | 找不到函数 | 调用未定义的函数 |
| E1205 | 递归深度超限 | 递归调用超出限制 |

#### E13xx-E14xx：类型推断错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E1301 | 无法推断类型 | 上下文无法推断类型 |
| E1302 | 类型推断冲突 | 多处约束导致类型矛盾 |
| E1303 | 多态实例化错误 | 泛型类型实例化失败 |
| E1304 | 未绑定的类型变量 | 类型变量未受约束 |
| E1305 | 无限类型 | 类型定义无限递归 |

#### E14xx-E15xx：模式匹配错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E1401 | 模式不穷尽 | match 表达式未覆盖所有情况 |
| E1402 | 模式冲突 | 多个模式覆盖相同情况 |
| E1403 | 不可达模式 | 永远无法匹配的模式 |
| E1404 | 解构错误 | 结构模式匹配失败 |

#### E15xx-E16xx：类型转换与操作错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E1501 | 操作不支持 | 类型不支持该操作 |
| E1502 | 下标越界 | 数组/列表索引超出范围 |
| E1503 | 字段不存在 | 访问不存在的结构体字段 |
| E1504 | 不支持的运算符 | 运算符类型不兼容 |
| E1505 | 比较类型不匹配 | 比较操作数类型不兼容 |

#### E20xx-E29xx：语义分析错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E2001 | 作用域错误 | 变量不在当前作用域 |
| E2002 | 重复定义 | 同一作用域内重复定义 |
| E2003 | 生命周期错误 | 生命周期约束不满足 |
| E2004 | self 参数错误 | 方法缺少 self 参数 |
| E2005 | self 类型错误 | self 类型不匹配 |

#### E40xx-E49xx：泛型与特质错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E4001 | 泛型参数不匹配 | 泛型参数数量/类型不匹配 |
| E4002 | 泛型约束违反 | 不满足 trait 约束 |
| E4003 | 关联类型错误 | 关联类型定义/使用错误 |
| E4004 | 特质实现重复 | 重复实现同一 trait |
| E4005 | 特质未找到 | 找不到要求的 trait |
| E4006 | Sized 约束错误 | Sized 约束不满足 |

#### E50xx-E59xx：模块与导入错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E5001 | 找不到模块 | 导入的模块不存在 |
| E5002 | 循环导入 | 模块间循环依赖 |
| E5003 | 符号未导出 | 尝试访问未导出的符号 |
| E5004 | 路径无效 | 模块路径格式错误 |
| E5005 | 私有访问 | 访问私有符号 |

#### E60xx-E69xx：运行时错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E6001 | 除零错误 | 整数除以零 |
| E6002 | 断言失败 | assert! 宏失败 |
| E6003 | 下溢/溢出 | 算术运算溢出 |
| E6004 | 栈溢出 | 栈空间耗尽 |
| E6005 | 堆分配失败 | 内存分配失败 |
| E6006 | 索引越界 | 运行时索引越界 |
| E6007 | 类型断言失败 | 尝试将类型断言为不兼容类型 |

#### E70xx-E79xx：I/O 与系统错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E7001 | 文件不存在 | 尝试读取不存在的文件 |
| E7002 | 权限被拒 | 文件权限不足 |
| E7003 | I/O 错误 | 通用 I/O 错误 |
| E7004 | 网络错误 | 网络操作失败 |

#### E80xx-E89xx：内部编译器错误

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| E8001 | 编译器 panic | 编译器内部错误 |
| E8002 | 代码生成错误 | IR/字节码生成失败 |
| E8003 | 未实现功能 | 使用未实现的功能 |
| E8004 | 优化失败 | 编译器优化错误 |

---

### 错误消息格式

错误消息采用以下格式：

```
error[E####]: <简短描述>
  --> <文件>:<行>:<列>
   <行> | <代码片段>
          ^^^<高亮>
```

#### 完整示例

```
error[E1101]: Unknown variable: x
  --> src/main.yx:5:12
   5 |   print(x)
          ^
```

### 警告与提示

警告代码使用 `W` 前缀：

| 代码 | 类型 | 说明 |
|------|------|------|
| W0101 | 警告 | 未使用的变量 |
| W0102 | 警告 | 未使用的导入 |
| W0103 | 警告 | 变量遮蔽 |
| W0104 | 警告 | 死代码 |

---

### 向后兼容性

#### 迁移策略

1. **短期**：保持现有错误代码与新系统的映射
2. **渐进式迁移**：在 0.5.x 版本系列中逐步迁移到新编号
3. **版本说明**：在迁移期间发布版本说明文档

#### 兼容性表

| 旧代码 | 新代码 | 状态 |
|--------|--------|------|
| E0001 | E1001 | 重映射 |
| E0002 | E1101 | 重映射 |
| E0003 | E1002 | 重映射 |
| E0004 | E1201 | 重映射 |
| ... | ... | ... |

---

## 权衡

### 优点

- **一致性**：与 Rust 社区标准一致
- **可扩展性**：预留充足编号空间
- **可识别性**：从编号即可判断错误类别
- **文档友好**：便于分类组织和查找

### 缺点

- **迁移成本**：需要更新现有错误代码
- **学习成本**：用户需要了解编号规则
- **编号空间**：99 个/子类别可能不够

## 替代方案

| 方案 | 描述 | 优点 | 缺点 |
|------|------|------|------|
| 纯顺序编号 | E0001, E0002... | 简单 | 无法分类 |
| 功能前缀 | TYPE-001, PARSE-001 | 明确 | 冗长 |
| 本方案 | Exxxx 分层编号 | 平衡 | 需要迁移 |

## 实现策略

### 阶段一：错误代码重构

1. 在 `src/frontend/typecheck/errors.rs` 中重新定义错误代码
2. 更新 `src/util/diagnostic/` 中的渲染逻辑
3. 添加错误代码到文档的映射

### 阶段二：工具支持

1. 更新 IDE 插件识别新错误代码
2. 添加 `yaoxiang explain E1101` 命令解释错误

### 阶段三：文档与迁移

1. 生成完整的错误代码参考文档
2. 发布迁移指南
3. 添加错误代码搜索网站

---

## 开放问题

- [ ] 是否需要在错误消息中显示错误代码描述的超链接？
- [ ] 警告代码是否使用 `W` 前缀还是继续用 `E`？
- [ ] 错误代码文档是否需要包含常见修复建议？

---

## 附录

### 错误代码速查表

#### 按主类别

| 主类别 | 范围 | 内容 |
|--------|------|------|
| 0 | E01xx-E02xx | 词法与语法分析 |
| 1 | E10xx-E15xx | 类型检查 |
| 2 | E20xx-E29xx | 语义分析 |
| 3 | E30xx-E39xx | 代码生成 |
| 4 | E40xx-E49xx | 泛型与特质 |
| 5 | E50xx-E59xx | 模块与导入 |
| 6 | E60xx-E69xx | 运行时错误 |
| 7 | E70xx-E79xx | I/O 与系统 |
| 8 | E80xx-E89xx | 内部错误 |

#### 按严重程度

| 程度 | 代码前缀 | 说明 |
|------|----------|------|
| 错误 | E | 导致编译失败 |
| 警告 | W | 不影响编译 |
| 信息 | I | 提示性消息 |

---

## 参考文献

- [Rust 编译器错误索引](https://doc.rust-lang.org/error_codes/error-index.html)
- [GCC 错误消息格式](https://gcc.gnu.org/onlinedocs/gcc-13.1.0/gcc/Warning-Options.html)
- [Clang 诊断格式](https://clang.llvm.org/diagnostics.html)
