# RFC-001ï¼šå¹¶ä½œæ¨¡å‹ä¸é”™è¯¯å¤„ç†ç³»ç»Ÿ

> **çŠ¶æ€**: å®¡æ ¸ä¸­
> **ä½œè€…**: æ™¨ç…¦
> **åˆ›å»ºæ—¥æœŸ**: 2025-01-05
> **æœ€åæ›´æ–°**: 2025-01-05

## è®¾è®¡æ¥æºä¸å‚è€ƒ

æœ¬æ–‡æ¡£çš„è®¾è®¡åŸºäºä»¥ä¸‹æ–‡æ¡£ï¼Œå¹¶ä½œä¸º language-spec çš„è¯¦ç»†è®¾è®¡æ¥æºï¼š

| æ–‡æ¡£ | å…³ç³» | è¯´æ˜ |
|------|------|------|
| [async-whitepaper](../async-whitepaper.md) | **è®¾è®¡æºå¤´** | å¹¶ä½œæ¨¡å‹çš„ç†è®ºåŸºç¡€å’Œæ ¸å¿ƒæ¦‚å¿µ |
| [language-spec](../language-spec.md) | **è§„èŒƒç›®æ ‡** | æœ¬RFCçš„è®¾è®¡å°†æ•´åˆåˆ°è¯­è¨€è§„èŒƒä¸­ |

> **è¯´æ˜**ï¼šæœ¬RFCæ˜¯å¯¹ [async-whitepaper](../async-whitepaper.md) ä¸­æå‡ºçš„å¹¶ä½œæ¨¡å‹çš„å…·ä½“åŒ–å’Œè§„èŒƒåŒ–ï¼Œå°†å…¶è½¬åŒ–ä¸ºå¯å®ç°çš„è¯­è¨€è®¾è®¡ã€‚

## æ‘˜è¦

æå‡ºYaoXiangçš„å¹¶ä½œæ¨¡å‹ï¼ˆä¸‰å±‚å¹¶å‘æ¶æ„ï¼‰ã€å‰¯ä½œç”¨å¤„ç†æœºåˆ¶ã€DAGä¾èµ–åˆ†æã€Resultç±»å‹ç³»ç»Ÿå’Œé”™è¯¯å›¾å¯è§†åŒ–ã€‚æ ¸å¿ƒè®¾è®¡ç†å¿µæºè‡ªã€Šæ˜“ç»ã€‹"ä¸‡ç‰©å¹¶ä½œï¼Œå¾ä»¥è§‚å¤"â€”â€”ä»¥åŒæ­¥è¯­æ³•æè¿°é€»è¾‘ï¼Œè¿è¡Œæ—¶è‡ªåŠ¨å¹¶å‘æ‰§è¡Œã€‚

## åŠ¨æœº

### ä¸ºä»€ä¹ˆéœ€è¦å¹¶ä½œæ¨¡å‹ï¼Ÿ

å½“å‰ä¸»æµè¯­è¨€çš„å¹¶å‘æ¨¡å‹å­˜åœ¨æ˜æ˜¾ç¼ºé™·ï¼š

| è¯­è¨€ | å¹¶å‘æ¨¡å‹ | é—®é¢˜ |
|------|----------|------|
| Rust | async/await + tokio | å¼‚æ­¥ä¼ æŸ“ã€å­¦ä¹ æ›²çº¿é™¡å³­ |
| Go | goroutine | æ— ç±»å‹å®‰å…¨ã€é€ƒé€¸åˆ†æå›°éš¾ |
| Python | asyncio | GILé™åˆ¶ã€æ€§èƒ½å·® |
| JavaScript | Promise/async | å›è°ƒåœ°ç‹±è™½ç¼“è§£ä½†ä»å¤æ‚ |

### æ ¸å¿ƒçŸ›ç›¾

1. **é€æ˜æ€§ vs å¯æ§æ€§**ï¼šå®Œå…¨é€æ˜ä½†ä¸å¯æ§ vs å®Œå…¨å¯æ§ä½†ä¸é€æ˜
2. **å¹¶å‘ vs å¯è°ƒè¯•**ï¼šå¹¶å‘ç¨‹åºéš¾è°ƒè¯• vs å¯è°ƒè¯•ç¨‹åºéš¾å¹¶å‘
3. **å®‰å…¨ vs æ€§èƒ½**ï¼šGCå®‰å…¨ä½†æœ‰å¼€é”€ vs æ‰‹åŠ¨ç®¡ç†é«˜æ•ˆä½†å±é™©

### å¹¶ä½œæ¨¡å‹çš„è§£å†³æ€è·¯

```
ä¼ ç»Ÿå›°å¢ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¹¶ä½œæ¨¡å‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è§£å†³æ–¹æ¡ˆ
å®Œå…¨é€æ˜ä½†ä¸å¯æ§ â”€â”€â”€â”€â†’ ä¸‰å±‚æ¨¡å‹ â”€â”€â”€â”€â†’ ä»L1åˆ°L3æ¸è¿›å¼é‡‡ç”¨
å¹¶å‘ç¨‹åºéš¾è°ƒè¯• â”€â”€â”€â”€â”€â”€â†’ å›¾è°ƒè¯• â”€â”€â”€â”€â”€â”€â†’ é”™è¯¯å›¾å¯è§†åŒ–
GCå®‰å…¨ä½†æœ‰å¼€é”€ â”€â”€â”€â”€â”€â”€â†’ æ‰€æœ‰æƒ â”€â”€â”€â”€â”€â”€â†’ Rustå¼ç¼–è¯‘æ—¶æ£€æŸ¥
```

## ææ¡ˆ

### 1. å¹¶ä½œæ¨¡å‹ï¼šä¸‰å±‚å¹¶å‘æ¶æ„

å¹¶ä½œæ¨¡å‹å…è®¸å¼€å‘è€…ä»¥åŒæ­¥ã€é¡ºåºçš„æ€ç»´æè¿°é€»è¾‘ï¼Œè€Œè¯­è¨€è¿è¡Œæ—¶ä»¤å…¶ä¸­çš„è®¡ç®—å•å…ƒå¦‚ä¸‡ç‰©å¹¶ä½œèˆ¬è‡ªåŠ¨ã€é«˜æ•ˆåœ°å¹¶å‘æ‰§è¡Œã€‚

#### ä¸‰å±‚æŠ½è±¡

| å±‚çº§ | æ¨¡å¼ | è¯­æ³•æ ‡è®° | æ‰§è¡Œæ–¹å¼ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|----------|----------|
| **L1** | `@block`åŒæ­¥ | `@block` | å®Œå…¨é¡ºåº | è°ƒè¯•ã€æ–°æ‰‹ã€å…³é”®ä»£ç æ®µ |
| **L2** | æ˜¾å¼spawn | `spawn` | å¼€å‘è€…å¯æ§ | ä¸­çº§ç”¨æˆ·ã€éœ€è¦æ§åˆ¶å¹¶å‘ |
| **L3** | å®Œå…¨é€æ˜ | æ— ï¼ˆé»˜è®¤ï¼‰ | è‡ªåŠ¨æœ€ä¼˜ | ä¸“å®¶ã€è‡ªåŠ¨å¹¶è¡Œä¼˜åŒ– |

#### L1: `@block`åŒæ­¥æ¨¡å¼

å®Œå…¨é¡ºåºæ‰§è¡Œï¼Œç¦ç”¨æ‰€æœ‰å¹¶å‘ä¼˜åŒ–ï¼Œä¾¿äºè°ƒè¯•å’Œç†è§£ã€‚

```yaoxiang
# L1: @block åŒæ­¥æ¨¡å¼ï¼ˆæ³¨è§£æ”¾åœ¨è¿”å›ç±»å‹åï¼‰
fetch_sync: (String) -> JSON @block = (url) => {
    HTTP.get(url).json()
}

main: () -> Void @block = () => {
    # ä¸¥æ ¼é¡ºåºæ‰§è¡Œï¼Œæ— ä»»ä½•å¹¶å‘
    data1 = fetch_sync("https://api.example.com/data1")
    data2 = fetch_sync("https://api.example.com/data2")
    process(data1, data2)
}
```

> **ğŸ“Œ å¼€æ”¾é—®é¢˜**: `@block`æ³¨è§£ä½ç½®è¯¦è§[é™„å½•A](#é™„å½•a-blockæ³¨è§£ä½ç½®è®¨è®º)

#### L2: æ˜¾å¼spawnå¹¶å‘

å¼€å‘è€…æ˜¾å¼æ ‡è®°å¯å¹¶å‘å•å…ƒï¼Œä¿æŒå¯æ§æ€§åŒæ—¶è·å¾—å¹¶å‘æ”¶ç›Šã€‚

```yaoxiang
# L2: æ˜¾å¼ spawn å¹¶å‘
fetch_data: (String) -> JSON spawn = (url) => {
    HTTP.get(url).json()
}

process_users_and_posts: () -> Void spawn = () => {
    users = fetch_data("https://api.example.com/users")
    posts = fetch_data("https://api.example.com/posts")

    # users å’Œ posts è‡ªåŠ¨å¹¶è¡Œæ‰§è¡Œ
    print("Users: " + users.length.to_string())
    print("Posts: " + posts.length.to_string())
}

# æ˜¾å¼å¹¶å‘å—
compute_all: () -> (Int, Int, Int) spawn = () => {
    (a, b, c) = spawn {
        heavy_calc(1),
        heavy_calc(2),
        heavy_calc(3)
    }
    (a, b, c)
}
```

#### L3: å®Œå…¨é€æ˜ï¼ˆé»˜è®¤ï¼‰

æ— éœ€ä»»ä½•æ ‡è®°ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨åˆ†æä¾èµ–å¹¶ç”Ÿæˆæœ€ä¼˜å¹¶è¡Œæ‰§è¡Œè®¡åˆ’ã€‚

```yaoxiang
# L3: å®Œå…¨é€æ˜ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰
heavy_calc: (Int) -> Int = (n) => {
    fibonacci(n)  # é»˜è®¤æƒ°æ€§æ±‚å€¼
}

auto_parallel: (Int) -> Int = (n) => {
    # ç³»ç»Ÿè‡ªåŠ¨åˆ†æï¼ša, b, c æ— ä¾èµ–ï¼Œå¯å®Œå…¨å¹¶è¡Œ
    a = heavy_calc(1)
    b = heavy_calc(2)
    c = heavy_calc(3)

    a + b + c  # åœ¨æ­¤å¤„ç­‰å¾…æ‰€æœ‰ç»“æœ
}

# æ•°æ®å¹¶è¡Œå¾ªç¯ï¼ˆè‡ªåŠ¨å¹¶è¡ŒåŒ–ï¼‰
parallel_sum: (Int) -> Int spawn = (n) => {
    total = spawn for i in 0..n {
        fibonacci(i)  # æ¯æ¬¡è¿­ä»£å¹¶è¡Œæ‰§è¡Œ
    }
    total
}
```

### 2. å‰¯ä½œç”¨å¤„ç†ä¸DAGä¾èµ–åˆ†æ

#### 2.1 æ ¸å¿ƒåŸåˆ™ï¼šåŒæ­¥è¯­æ³•ï¼Œå¼‚æ­¥æœ¬è´¨

```
ç¨‹åº â†’ ç¼–è¯‘æ—¶åˆ†æ â†’ DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰
           â†“
       è¿è¡Œæ—¶è°ƒåº¦ â†’ è‡ªåŠ¨å¹¶è¡Œ
```

#### 2.2 Voidå‡½æ•°æ€¥åˆ‡è§„åˆ™

è¿”å›`Void`çš„å‡½æ•°è‡ªåŠ¨æ€¥åˆ‡æ±‚å€¼ï¼Œä¿è¯å‰¯ä½œç”¨å¿…ç„¶æ‰§è¡Œã€‚

```yaoxiang
# Void å‡½æ•°è‡ªåŠ¨æ€¥åˆ‡æ‰§è¡Œ
log_message: (String) -> Void = (msg) => {
    print(msg)  # å‰¯ä½œç”¨ï¼Œç«‹å³æ‰§è¡Œ
}

side_effect_demo: () -> Void = () => {
    msg = get_message()  # å¯èƒ½è¿”å›æƒ°æ€§
    log_message(msg)     # è¿™é‡Œçš„ print å¿…å®šæ‰§è¡Œ
}
```

#### 2.3 èµ„æºå†²çªæ£€æµ‹

ç¼–è¯‘æ—¶åˆ†æèµ„æºè®¿é—®æ¨¡å¼ï¼Œè‡ªåŠ¨ä¸²è¡ŒåŒ–å†²çªæ“ä½œã€‚

```rust
// ç¼–è¯‘æ—¶åˆ†æèµ„æºè®¿é—®
struct ResourceAccess {
    reads: Set<ResourceId>,   // è¯»å–çš„èµ„æº
    writes: Set<ResourceId>,  // å†™å…¥çš„èµ„æº
}

// å†²çªè§„åˆ™çŸ©é˜µ
// â•”â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•—
// â•‘   è®¿é—®    â•‘   è¯»     â•‘    å†™    â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•£
// â•‘   è¯»      â•‘  å¯å¹¶è¡Œ  â•‘  ä¸²è¡ŒåŒ–  â•‘
// â•‘   å†™      â•‘  ä¸²è¡ŒåŒ–  â•‘  ä¸²è¡ŒåŒ–  â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•

// ç¤ºä¾‹
file1 = open("a.txt")  # èµ„æº1
file2 = open("b.txt")  # èµ„æº2
// file1 è¯»å’Œ file2 å†™ â†’ ä¸²è¡ŒåŒ–
// file1 è¯»å’Œ file2 è¯» â†’ å¯å¹¶è¡Œ
```

#### 2.4 æ‰‹åŠ¨æ§åˆ¶æ³¨è§£

| æ³¨è§£ | è¡Œä¸º | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `@eager` | å¼ºåˆ¶æ€¥åˆ‡æ±‚å€¼ | éœ€è¦ç«‹å³è·å–ç»“æœçš„è®¡ç®— |
| `@ordered` | å¼ºåˆ¶é¡ºåºæ‰§è¡Œ | æœ‰åºå‰¯ä½œç”¨ã€è°ƒè¯• |
| `@concurrent` | å¼ºåˆ¶å¹¶å‘ï¼ˆé»˜è®¤ï¼‰ | æ˜¾å¼å£°æ˜å¹¶å‘æ„å›¾ |

```yaoxiang
# å¼ºåˆ¶æ€¥åˆ‡æ±‚å€¼
@eager
expensive_computation: (Int) -> Int = (n) => {
    fibonacci(n)
}

# å¼ºåˆ¶é¡ºåºæ‰§è¡Œï¼ˆå³ä½¿åœ¨spawnå—å†…ï¼‰
@ordered
log_sequential: (String) -> Void = (msg) => {
    print("[Order] " + msg)
}

# æ•°æ®å¹¶è¡Œçš„æœ‰åºæ”¶é›†
ordered_collect: (Int) -> [Int] = (n) => {
    result = spawn for i in 0..n {
        heavy_calc(i)
    }
    @ordered(result)  # ä¿æŒåŸå§‹é¡ºåº
}
```

#### 2.5 å¹¶ä½œå›¾å¯è§†åŒ–

```
æºä»£ç                      å¹¶ä½œå›¾ï¼ˆDAGï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ a = calc(1)     â”‚       â”‚   calc(1)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚      â”‚      â”‚
â”‚ b = calc(2)     â”‚  â†’    â”‚   calc(2)   â”‚  â† å¯å¹¶è¡Œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚      â”‚      â”‚
â”‚ c = calc(3)     â”‚       â”‚   calc(3)   â”‚  â† å¯å¹¶è¡Œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
â”‚ d = a + b + c   â”‚               â”‚ ä¾èµ–æ±‡èš
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                          â”‚   add.add    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Resultç±»å‹ä¸é”™è¯¯å›¾ç³»ç»Ÿ

#### 3.1 Resultç±»å‹å®šä¹‰

```yaoxiang
# æ ‡å‡†Resultç±»å‹ï¼ˆç»Ÿä¸€æ„é€ å™¨è¯­æ³•ï¼‰
type Result[T, E] = ok(T) | err(E)

# ä½¿ç”¨ç¤ºä¾‹
type ParseError = invalid_format | unexpected_eof | position(Int)

parse_config: (String) -> Result[Config, ParseError] = (content) => {
    if content.is_empty() {
        err(invalid_format)
    } else {
        ok(parse(content))
    }
}
```

#### 3.2 é”™è¯¯ä¼ æ’­è¯­æ³•

é‡‡ç”¨Rustå¼`?`è¿ç®—ç¬¦ï¼Œå®ç°é€æ˜é”™è¯¯ä¼ æ’­ã€‚

```yaoxiang
# Rustå¼ ? è¿ç®—ç¬¦
process() -> Result[Data, Error] = {
    data = fetch_data()?      # è‡ªåŠ¨ç­‰å¾…å¹¶æ£€æŸ¥é”™è¯¯
    processed = transform(data)?
    save(processed)?          # é”™è¯¯è‡ªåŠ¨å‘ä¸Šä¼ æ’­
}

# æ¨¡å¼åŒ¹é…å¤„ç†é”™è¯¯
handle_result: (Result[Int, Error]) -> String = (result) => {
    match result {
        ok(value) => "Success: " + value.to_string()
        err(e) => match e {
            network_error => "Network failed"
            parse_error => "Parse failed"
            _ => "Unknown error"
        }
    }
}
```

#### 3.3 é”™è¯¯å›¾å¯è§†åŒ–

é”™è¯¯å›¾ç±»ä¼¼è°ƒç”¨æ ˆï¼Œä½†æ˜¾ç¤ºDAGä¸­çš„é”™è¯¯ä¼ æ’­è·¯å¾„ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Error: Division by zero                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Error Graph:                                                â”‚
â”‚                                                             â”‚
â”‚   main()                                                   â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€â–º calculate()                                        â”‚
â”‚     â”‚         â”‚                                             â”‚
â”‚     â”‚         â””â”€â”€â–º divide(100, 0)  âœ— [Division by zero]     â”‚
â”‚     â”‚                                                       â”‚
â”‚     â””â”€â”€â–º fallback()  âœ“                                      â”‚
â”‚                                                             â”‚
â”‚ å› æœé“¾: main â†’ calculate â†’ divide                           â”‚
â”‚ æ•è·ä½ç½®: calculate (ç¬¬42è¡Œ)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.4 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

```yaoxiang
# ç»„åˆå¤šä¸ªå¯èƒ½å‡ºé”™çš„æ“ä½œ
batch_process: ([String]) -> Result[[String], Error] = (items) => {
    results = items.map(item => {
        process_item(item)?
    })
    ok(results)
}

# with? è¯­æ³•ç³–ï¼ˆæœªæ¥ç‰¹æ€§ï¼‰
validate_user: (User) -> Result[ValidatedUser, ValidationError] = (user) => {
    name = user.name.with?(validate_name)?
    email = user.email.with?(validate_email)?
    ok(ValidatedUser(name, email))
}
```

## è¯¦ç»†è®¾è®¡

### 1. ç¼–è¯‘å™¨æ”¹åŠ¨

| ç»„ä»¶ | æ”¹åŠ¨ |
|------|------|
| lexer | æ–°å¢ `@block`ã€`@eager`ã€`@ordered`ã€`spawn` å…³é”®å­—/æ³¨è§£ |
| parser | æ”¯æŒ `spawn` æ ‡è®°å‡½æ•°ã€`spawn { }` å¹¶å‘å— |
| typecheck | Send/Sync çº¦æŸæ£€æŸ¥ã€èµ„æºè®¿é—®åˆ†æ |
| codegen | DAGæ„å»ºã€ä¾èµ–å›¾ç”Ÿæˆ |

### 2. è¿è¡Œæ—¶æ”¹åŠ¨

| ç»„ä»¶ | æ”¹åŠ¨ |
|------|------|
| è°ƒåº¦å™¨ | å·¥ä½œçªƒå–è°ƒåº¦å™¨ã€ä¼˜å…ˆçº§é˜Ÿåˆ— |
| DAGæ‰§è¡Œå™¨ | å¹¶ä½œå›¾éå†ã€ä¾èµ–è§£æ |
| é”™è¯¯ä¼ æ’­ | é”™è¯¯å›¾ç”Ÿæˆã€æ ˆè¿½è¸ªå¢å¼º |
| çº¿ç¨‹æ±  | å¹¶å‘ä»»åŠ¡ç®¡ç†ã€èµ„æºéš”ç¦» |

### 3. ç±»å‹ç³»ç»Ÿå½±å“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç±»å‹çº¦æŸå±‚æ¬¡                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   Send â”€â”€â–º å¯å®‰å…¨è·¨çº¿ç¨‹ä¼ è¾“                                 â”‚
â”‚     â”‚                                                       â”‚
â”‚     â””â”€â”€â–º Sync â”€â”€â–º å¯å®‰å…¨è·¨çº¿ç¨‹å…±äº«                          â”‚
â”‚          â”‚                                                  â”‚
â”‚          â””â”€â”€â–º æ»¡è¶³ Send + Sync çš„ç±»å‹å¯è‡ªåŠ¨å¹¶å‘              â”‚
â”‚                                                             â”‚
â”‚ Arc[T] å®ç° Send + Syncï¼ˆçº¿ç¨‹å®‰å…¨å¼•ç”¨è®¡æ•°ï¼‰                  â”‚
â”‚ Mutex[T] æä¾›å†…éƒ¨å¯å˜æ€§                                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. è¯­æ³•BNF

```
FunctionDecl    ::= Identifier ':' Type ('spawn' | '@block')? '=' Expr
ConcurrentBlock ::= 'spawn' '{' Expr (',' Expr)* '}' | 'spawn' 'for' ...
Pattern         ::= 'ok' '(' Pattern ')' | 'err' '(' Pattern ')' | '_'
ErrorPropagate  ::= Expr '?'
```

### 5. å‘åå…¼å®¹æ€§

- âœ… å®Œå…¨å‘åå…¼å®¹
- ä»…æ–°å¢è¯­æ³•ï¼ŒåŸæœ‰ä»£ç æ— éœ€ä¿®æ”¹
- L3æ¨¡å¼ï¼ˆå®Œå…¨é€æ˜ï¼‰ä¸ºé»˜è®¤ï¼Œéœ€è€ƒè™‘æ¸è¿›å¯ç”¨ç­–ç•¥

## æƒè¡¡

### ä¼˜ç‚¹

1. **æ¸è¿›å¼é‡‡ç”¨**ï¼šä¸‰å±‚æ¨¡å‹é€‚åº”ä¸åŒæŠ€èƒ½æ°´å¹³
2. **è‡ªç„¶è¯­æ³•**ï¼šåŒæ­¥ä»£ç è·å¾—å¹¶è¡Œæ€§èƒ½
3. **ç¼–è¯‘æ—¶å®‰å…¨**ï¼šSend/Syncçº¦æŸæ¶ˆé™¤æ•°æ®ç«äº‰
4. **å¯è°ƒè¯•æ€§**ï¼šé”™è¯¯å›¾æä¾›æ¸…æ™°çš„é”™è¯¯ä¼ æ’­è§†å›¾
5. **èµ„æºå®‰å…¨**ï¼šç¼–è¯‘æ—¶èµ„æºå†²çªæ£€æµ‹é˜²æ­¢æ­»é”

### ç¼ºç‚¹

1. **å­¦ä¹ æ›²çº¿**ï¼šéœ€è¦ç†è§£DAGä¾èµ–æ¦‚å¿µ
2. **ç¼–è¯‘æ—¶é—´**ï¼šå…¨ç¨‹åºDAGåˆ†æå¯èƒ½è¾ƒæ…¢
3. **å·¥å…·é“¾å¤æ‚åº¦**ï¼šéœ€è¦å…¨æ–°çš„è°ƒè¯•å’Œå¯è§†åŒ–å·¥å…·
4. **è°ƒè¯•æŒ‘æˆ˜**ï¼šL3æ¨¡å¼çš„è°ƒè¯•éœ€è¦ç‰¹æ®Šå·¥å…·æ”¯æŒ

## æ›¿ä»£æ–¹æ¡ˆ

| æ–¹æ¡ˆ | ä¸ºä»€ä¹ˆä¸é€‰æ‹© |
|------|--------------|
| ä»…æ”¯æŒæ˜¾å¼async/await | æ— æ³•å®ç°çœŸæ­£çš„é€æ˜å¹¶å‘ |
| ä»…æ”¯æŒå®Œå…¨é€æ˜å¹¶å‘ | ç”¨æˆ·å¤±å»æ§åˆ¶æƒï¼Œæ— æ³•è°ƒè¯• |
| Goå¼goroutine | æ— ç±»å‹å®‰å…¨ã€æ— æ³•ç¼–è¯‘æ—¶æ£€æŸ¥ |
| ä»…L1æ¨¡å¼ | æ”¾å¼ƒå¹¶ä½œæ¨¡å‹çš„æ ¸å¿ƒä»·å€¼ |

## å®ç°ç­–ç•¥

### é˜¶æ®µåˆ’åˆ†

1. **é˜¶æ®µ1 (v0.1)**: `@block`åŒæ­¥æ¨¡å¼ã€åŸºç¡€ç±»å‹
2. **é˜¶æ®µ2 (v0.3)**: `spawn`å—ã€æ˜¾å¼å¹¶å‘
3. **é˜¶æ®µ3 (v0.5)**: L3å®Œå…¨é€æ˜ã€DAGè‡ªåŠ¨åˆ†æ
4. **é˜¶æ®µ4 (v1.0)**: é”™è¯¯å›¾ã€å›¾è°ƒè¯•å™¨

### ä¾èµ–å…³ç³»

- RFC-001 æ— å¤–éƒ¨ä¾èµ–ï¼ˆåŸºç¡€æ ¸å¿ƒï¼‰
- RFC-002ï¼ˆlibuvé›†æˆï¼‰å¯å¹¶è¡Œå¼€å‘
- RFC-003ï¼ˆç‰ˆæœ¬è§„åˆ’ï¼‰å¯å¹¶è¡Œå¼€å‘

### é£é™©

1. **DAGåˆ†ææ€§èƒ½**: å…¨ç¨‹åºåˆ†æå¯èƒ½O(nÂ²)ï¼Œéœ€è¦ä¼˜åŒ–ç®—æ³•
2. **å·¥å…·é“¾ç¼ºå¤±**: è°ƒè¯•å™¨éœ€è¦ä»é›¶å¼€å‘
3. **ç”¨æˆ·æ¥å—åº¦**: é€æ˜å¹¶å‘è¿åç›´è§‰ï¼Œéœ€è¦è‰¯å¥½æ–‡æ¡£

## å¼€æ”¾é—®é¢˜

- [ ] L3æ¨¡å¼çš„å›é€€æœºåˆ¶ï¼šå¦‚ä½•ä»é€æ˜æ¨¡å¼å›é€€åˆ°L2/L1ï¼Ÿ
- [ ] åµŒå¥—spawnçš„ä¾èµ–åˆ†æå¤æ‚åº¦å¦‚ä½•æ§åˆ¶ï¼Ÿ
- [ ] é”™è¯¯å›¾çš„äº¤äº’å¼æ¢ç´¢ä½“éªŒè®¾è®¡
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼šä¸Goã€Rust asyncçš„å¯¹æ¯”
- [ ] @orderedåœ¨å¾ªç¯ä¸­çš„è¯­ä¹‰å®šä¹‰
- [ ] @blockæ³¨è§£ä½ç½®é€‰æ‹©ï¼ˆè¯¦è§é™„å½•Aï¼‰

---

## é™„å½•

### é™„å½•Aï¼š@blockæ³¨è§£ä½ç½®è®¨è®º

> **è®¨è®ºçŠ¶æ€**: å¼€æ”¾ä¸­
> **å‘èµ·è€…**: @æ™¨ç…¦
> **æ—¥æœŸ**: 2025-01-05

#### é—®é¢˜æè¿°

`@block`æ³¨è§£æ”¾åœ¨å‡½æ•°ç­¾åçš„å“ªä¸ªä½ç½®ï¼Ÿéœ€è¦å¹³è¡¡**å¯è¯»æ€§**å’Œ**ä¸€è‡´æ€§**ã€‚

#### å¤‡é€‰æ–¹æ¡ˆ

| æ–¹æ¡ˆ | è¯­æ³•ç¤ºä¾‹ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|----------|------|------|
| **Aï¼ˆå½“å‰ï¼‰** | `() -> Void @block` | ä¸`spawn`ä½ç½®ä¸€è‡´ | ç±»å‹åç´§è·Ÿæ³¨è§£ï¼Œç¨æ˜¾æ‹¥æŒ¤ |
| **B** | `@block () -> Void` | æ³¨è§£é†’ç›®ã€ä¸€çœ¼å¯è§ | ä¸`spawn`ä¸ä¸€è‡´ |
| **C** | `() @block -> Void` | è§†è§‰åˆ†å‰²æ¸…æ™° | ç ´åç±»å‹è¯­æ³•ç»“æ„ |
| **D** | `fn @block name() -> Void { }` | å…³é”®å­—å¼€å¤´ | å…³é”®å­—+æ³¨è§£ç»„åˆå†—é•¿ |

#### å„æ–¹æ¡ˆåˆ†æ

**æ–¹æ¡ˆAï¼ˆæ¨èï¼‰**ï¼š
- ä¸`spawn`ä¿æŒåŒä¸€ä½ç½®ï¼Œé™ä½å­¦ä¹ æˆæœ¬
- å¯é€šè¿‡IDEé«˜äº®å’Œä»£ç é£æ ¼è§„èŒƒå¼¥è¡¥å¯è¯»æ€§

**æ–¹æ¡ˆB**ï¼š
- æ³¨è§£æ›´é†’ç›®ï¼Œä½†ä¸`spawn`ä½ç½®ä¸ä¸€è‡´

**æ–¹æ¡ˆC**ï¼š
- ç ´å`å‚æ•°åˆ—è¡¨ -> è¿”å›ç±»å‹`çš„ç»“æ„å®Œæ•´æ€§

**æ–¹æ¡ˆD**ï¼š
- å†—é•¿ï¼Œä¸YaoXiangç®€æ´è¯­æ³•é£æ ¼ä¸ç¬¦

#### æ¨èä»£ç é£æ ¼ï¼ˆç¼“è§£æ–¹æ¡ˆAçš„å¯è¯»æ€§é—®é¢˜ï¼‰

```yaoxiang
# å°†æ³¨è§£æ”¾åœ¨å•ç‹¬ä¸€è¡Œ
main:
    () -> Void @block
= () => {
    ...
}
```

#### ç¤¾åŒºè®¨è®ºè®°å½•

- [å¾…æ·»åŠ ]

#### å†³è®®

[å¾…ç¤¾åŒºè®¨è®ºåç¡®å®š]

---

### é™„å½•Bï¼šè®¾è®¡å†³ç­–è®°å½•

> æœ¬é™„å½•è®°å½•RFCä¸­å·²ç¡®å®šçš„è®¾è®¡å†³ç­–åŠå…¶ç†ç”±ã€‚

| å†³ç­– | å†³å®š | æ—¥æœŸ | è®°å½•äºº |
|------|------|------|--------|
| é‡‡ç”¨ä¸‰å±‚å¹¶å‘æ¶æ„ | L1/L2/L3 æ¸è¿›å¼ | 2025-01-05 | @æ™¨ç…¦ |
| @blockä¸spawnä½ç½®ä¸€è‡´ | æ–¹æ¡ˆA | 2025-01-05 | @æ™¨ç…¦ |

---

### é™„å½•Cï¼šæœ¯è¯­è¡¨

| æœ¯è¯­ | å®šä¹‰ |
|------|------|
| å¹¶ä½œæ¨¡å‹ | YaoXiangçš„å¹¶å‘èŒƒå¼ï¼ŒåŒæ­¥è¯­æ³•ã€å¼‚æ­¥æœ¬è´¨ |
| DAG | æœ‰å‘æ— ç¯å›¾ï¼Œæè¿°è®¡ç®—ä¾èµ–å…³ç³» |
| spawn | å¹¶ä½œå‡½æ•°æ ‡è®°ï¼Œè¡¨ç¤ºå¯å¹¶å‘æ‰§è¡Œ |
| @block | åŒæ­¥æ³¨è§£ï¼Œç¦ç”¨å¹¶å‘ä¼˜åŒ– |
| é”™è¯¯å›¾ | å¯è§†åŒ–çš„é”™è¯¯ä¼ æ’­è·¯å¾„ |

## å‚è€ƒæ–‡çŒ®

- [Rust async book](https://rust-lang.github.io/async-book/)
- [Goå¹¶å‘æ¨¡å¼](https://golang.org/doc/effective_go#concurrency)
- [å·¥ä½œçªƒå–è°ƒåº¦](https://en.wikipedia.org/wiki/Work_stealing)
- [ã€Šæ˜“ç»ã€‹å¹¶ä½œæ€æƒ³](https://en.wikipedia.org/wiki/I_Ching)
- [å¹¶ä½œæ¨¡å‹ç™½çš®ä¹¦](../async-whitepaper.md)
- [YaoXiang æŒ‡å—](../YaoXiang-book.md)
- [YaoXiang è¯­è¨€è§„èŒƒ](../language-spec.md)