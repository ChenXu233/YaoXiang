# YaoXiang 架构文档总览

> 版本：v1.0.0
> 状态：正式
> 作者：晨煦
> 日期：2025-01-04

---

## 📚 文档导航

本目录包含 YaoXiang 语言实现的完整架构设计文档。这些文档帮助你理解编译器、运行时和整体系统的设计哲学和实现细节。

### 🏗️ 核心架构文档

#### 1. [项目结构文档](project-structure.md)
**核心内容**：
- 完整的目录结构说明
- 各模块职责划分
- 源代码组织方式
- 开发工作流指南

**适合**：新贡献者、架构理解起点

#### 2. [编译器设计文档](compiler-design.md) 
**核心内容**：
- 完整的编译流程（前端→中端→后端）
- 词法分析、语法分析实现
- Hindley-Milner 类型推断系统
- 中间表示 (IR) 设计
- 优化策略和错误处理

**适合**：编译器开发者、语言设计者

#### 3. [运行时设计文档](runtime-design.md)
**核心内容**：
- 虚拟机执行引擎
- 并作并发模型实现
- 工作窃取调度器
- 内存管理和垃圾回收
- 性能优化策略

**适合**：运行时开发者、并发系统研究者

---

## 🎯 核心设计哲学

### 1. 一切皆类型
```yaoxiang
# 类型是最高抽象层
type Point = Point(x: Float, y: Float)
add: (Point, Point) -> Point = (a, b) => { ... }
```

### 2. 双层处理策略
```
解析层（宽松） → AST
    ↓
类型检查层（严格） → 带类型 AST
```

### 3. 并作并发模型
```yaoxiang
# 同步思维，并发执行
fetch_data() -> JSON spawn = (url) => { ... }
process_data() = {
    user = fetch_user(1)     # 自动并行
    posts = fetch_posts()    # 自动并行
    print(user.name + posts.length)
}
```

### 4. 类型集中约定
```yaoxiang
# ✅ 推荐：类型在声明中
add: (Int, Int) -> Int = (a, b) => a + b

# ❌ 避免：类型在实现中
add = (a: Int, b: Int) => a + b
```

### 5. 优雅的绑定语法
```yaoxiang
# 精确控制参数位置
Point.distance = distance[1]
Point.calc = calculate[1, 2, 3]
```

---

## 🔍 关键技术亮点

### 前端创新
- **Pratt Parser**：优雅处理表达式优先级
- **双层解析**：语法与语义分离
- **位置绑定**：`[n]` 语法实现细粒度柯里化

### 类型系统
- **HM 推断**：完整的类型推断算法
- **泛型单态化**：零成本抽象
- **子类型系统**：支持多态和继承

### 中端优化
- **SSA IR**：静态单赋值形式
- **逃逸分析**：栈/堆分配优化
- **多遍优化**：常量折叠、死代码消除

### 后端设计
- **紧凑字节码**：高效编码格式
- **指令优化**：内联缓存、常量传播
- **可扩展**：易于添加新指令

### 运行时创新
- **并作图 (DAG)**：自动依赖管理
- **工作窃取**：多线程负载均衡
- **惰性求值**：按需执行
- **零拷贝**：最小化数据复制

---

## 📊 性能目标

### 虚拟机性能
- **指令执行**：50+ 亿指令/秒
- **栈操作**：< 5ns
- **函数调用**：< 50ns

### 并发性能
- **任务创建**：< 100ns
- **上下文切换**：< 1μs
- **工作窃取效率**：> 90%

### 内存性能
- **分配吞吐**：> 1GB/s
- **GC 暂停**：< 1ms
- **任务内存**：< 1KB

---

## 🛠️ 开发者指南

### 新贡献者入门路径

1. **第一周**：阅读文档
   - ✅ `project-structure.md` - 了解整体结构
   - ✅ `YaoXiang-book.md` - 理解语言特性

2. **第二周**：深入前端
   - ✅ `compiler-design.md` 前端部分
   - ✅ 阅读 `src/frontend/lex.rs` 和 `src/frontend/parser/`
   - ✅ 运行现有测试

3. **第三周**：理解类型系统
   - ✅ `compiler-design.md` 类型系统部分
   - ✅ 阅读 `src/frontend/typecheck/`
   - ✅ 尝试修改类型规则

4. **第四周**：运行时探索
   - ✅ `runtime-design.md` 
   - ✅ 阅读 `src/vm/` 和 `src/runtime/`

### 常见任务

**添加新语言特性**：
1. 在 `lexer/tokens.rs` 添加 Token
2. 在 `parser/ast.rs` 添加 AST 节点
3. 在 `parser/expr.rs` 或 `parser/stmt.rs` 添加解析
4. 在 `typecheck/` 添加类型规则
5. 在 `codegen/` 生成字节码
6. 在 `vm/instructions.rs` 添加执行逻辑
7. 更新 `YaoXiang-book.md` 文档

**优化性能**：
1. 运行 `cargo bench` 基准测试
2. 使用 `cargo flamegraph` 分析热点
3. 选择优化路径：
   - 前端：优化解析算法
   - 中端：添加新的优化 pass
   - 后端：改进指令选择
   - 运行时：优化调度器或虚拟机

**修复 Bug**：
1. 在 `tests/` 添加失败测试用例
2. 定位问题所在层级
3. 修复并验证
4. 更新相关文档

---

## 🔗 相关资源

### 外部参考
- **编译原理**：龙书、虎书、鲸书
- **类型论**：HM 类型推断、依赖类型
- **并发模型**：CSP、Actor、数据并行
- **虚拟机设计**：Lua、V8、JVM

### 内部文档
- [语言指南](../YaoXiang-book.md) - 完整语言规范
- [实现计划](../YaoXiang-implementation-plan.md) - 开发路线图
- [异步白皮书](../YaoXiang-async-whitepaper.md) - 并作模型详解
- [绑定特性](../guides/bind/YaoXiang-bind-advanced.md) - 绑定系统深度解析

---

## 📝 文档维护原则

### 更新时机
- ✅ 添加新模块时
- ✅ 修改核心架构时
- ✅ 语言语法变更时
- ✅ 性能优化策略变化时

### 质量要求
- ✅ 代码示例必须可运行
- ✅ 保持术语一致性
- ✅ 突出设计决策的原因
- ✅ 提供对比和替代方案

### 文档格式
- ✅ 使用统一的标题结构
- ✅ 关键概念加粗
- ✅ 代码块标注语言
- ✅ 表格用于对比
- ✅ 图示使用 ASCII 艺术

---

## 🚀 快速开始

### 阅读建议

**如果你是开发者**：
```
project-structure.md → compiler-design.md → runtime-design.md
```

**如果你是研究者**：
```
compiler-design.md (类型系统) → YaoXiang-book.md (语言特性)
→ runtime-design.md (并发模型)
```

**如果你是用户**：
```
YaoXiang-book.md → guides/getting-started.md
```

### 实践建议

1. **边读边做**：每读一节，尝试相关代码
2. **运行示例**：使用 `docs/examples/` 中的代码
3. **运行测试**：`cargo test` 验证理解
4. **修改实验**：小范围修改，观察效果

---

## 📞 社区与支持

- **问题讨论**：在相关模块的 GitHub Issue 中讨论
- **文档改进**：欢迎提交 PR 完善文档
- **架构讨论**：在设计文档中添加注释和建议

---

## 🎓 学习路径建议

### 初级（1-2周）
- 了解项目结构
- 掌握语言基础语法
- 能运行和修改示例代码

### 中级（1-2月）
- 理解编译器前端
- 能添加简单语言特性
- 理解并作模型基础

### 高级（3-6月）
- 深入类型系统和 IR
- 能优化虚拟机性能
- 理解调度器和内存管理

### 专家级（6月+）
- 能设计新优化策略
- 深入并发模型研究
- 指导架构演进

---

## 📄 附录

### 术语表
| 术语 | 解释 |
|------|------|
| 并作 (Spawn) | YaoXiang 的异步并发模型 |
| 并作图 (DAG) | 并发任务的依赖关系图 |
| 位置绑定 | `[n]` 语法控制参数绑定位置 |
| 类型集中 | 声明中包含完整类型信息的约定 |
| 双层处理 | 解析层宽松，类型检查层严格 |

### 关键文件映射
```
文档 → 源代码
├── compiler-design.md → src/frontend/, src/middle/
├── runtime-design.md → src/vm/, src/runtime/
├── project-structure.md → 整个项目布局
└── YaoXiang-book.md → 语言语义和语法
```

---

**最后更新**：2025-01-04  
**维护者**：晨煦  
**许可证**：与项目保持一致
