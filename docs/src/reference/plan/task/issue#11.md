# Task: 实现 LSP (Language Server Protocol) 支持

## 概述
为提升 YaoXiang 的开发者体验，需要实现一个符合 Language Server Protocol 的语言服务器。该服务器将嵌入编译器前端，提供实时的代码分析、补全、跳转、诊断等功能，可与主流编辑器（VS Code、Vim、Emacs 等）集成。

## 目标
- 实现 YaoXiang 语言服务器二进制 `yaoxiang-lsp`。
- 支持以下 LSP 请求：
  - `textDocument/didOpen` / `didChange` / `didSave` / `didClose`：同步文件内容。
  - `textDocument/documentSymbol`：列出文档符号（函数、类型、变量等）。
  - `textDocument/completion`：提供代码补全建议（基于作用域内符号）。
  - `textDocument/definition`：跳转到定义位置。
  - `textDocument/hover`：悬停显示类型信息和文档注释。
  - `textDocument/publishDiagnostics`：实时推送语法错误、类型错误等诊断信息。
- 实现与编译器的增量编译/检查能力，避免每次全量解析。

## 具体步骤
1. **设计服务器架构**（1 周）
   - 基于现有的编译器前端库（词法分析、解析、类型检查）构建。
   - 采用异步 I/O（如 Tokio）处理 LSP 请求。
   - 设计文档缓存和增量更新的数据结构。

2. **实现基础 LSP 协议通信**（1 周）
   - 实现 JSON-RPC 消息的收发。
   - 处理初始化请求、关闭请求等生命周期管理。

3. **集成编译器前端**（2 周）
   - 将词法分析、解析、类型检查封装为可重入的库函数。
   - 为每个文档维护一个“编译会话”，支持增量更新（仅重新解析修改的部分）。
   - 实现从 AST 节点到源代码位置的映射，用于跳转和悬停。

4. **实现诊断功能**（1 周）
   - 捕获类型检查过程中的错误和警告，转换为 LSP 诊断消息。
   - 在文件修改后自动推送诊断。

5. **实现补全和符号导航**（2 周）
   - 构建作用域符号表，为补全提供候选列表（包括关键字、内置类型、当前作用域变量等）。
   - 实现跳转到定义：根据光标位置找到符号定义的文件和位置。
   - 实现悬停信息：显示类型签名和关联的文档注释（如果支持）。

6. **测试与集成**（1 周）
   - 编写 VS Code 客户端插件（简单包装）进行测试。
   - 确保所有功能在常见场景下可用，无明显性能问题。

## 验收标准
- 服务器能正确启动，响应初始化请求。
- 打开一个 YaoXiang 文件后，诊断信息（语法错误、类型错误）能实时显示在编辑器中。
- 在变量或函数名上悬停，能显示其类型信息。
- 在标识符上跳转到定义，能打开对应文件并定位到定义行。
- 输入点号后，能补全记录类型的字段（需类型信息）。
- 服务器在大型文件（数千行）上响应时间在可接受范围内（<500ms）。

## 依赖
- 编译器前端库必须稳定，并提供获取 AST、符号表、类型信息的 API。
- 需要实现增量编译能力（至少文档级别的缓存）。