# å˜é‡å‘½åç©ºé—´ä¸é®è”½æœºåˆ¶ä»£ç å®¡æŸ¥æŠ¥å‘Š

## å®¡æŸ¥æ—¶é—´
2026-02-18

## ä¿®å¤æ—¶é—´
2026-02-18

## å®¡æŸ¥èŒƒå›´
- å˜é‡å‘½åç©ºé—´ç®¡ç†ï¼ˆä½œç”¨åŸŸï¼‰
- å˜é‡é®è”½æ£€æµ‹
- For å¾ªç¯å˜é‡è¯­ä¹‰
- `mut` å£°æ˜å¤„ç†

---

## éœ€æ±‚å›é¡¾

æ ¹æ®è®¾è®¡ï¼Œè¯­è¨€çš„å˜é‡é®è”½è§„åˆ™å¦‚ä¸‹ï¼š

1. **ç¦æ­¢é®è”½** - ä»»ä½•è¯•å›¾åœ¨å¤–å±‚ä½œç”¨åŸŸå·²å­˜åœ¨çš„å˜é‡åï¼Œåœ¨å†…å±‚é‡æ–°å£°æ˜éƒ½ä¼šæŠ¥é”™
2. **æ—  let å…³é”®å­—** - é€šè¿‡ `mut` æˆ–éšå¼å£°æ˜åˆ›å»ºå˜é‡
3. **é®è”½å³æŠ¥é”™** - æ— è®ºæ˜¯æ™®é€šå£°æ˜è¿˜æ˜¯ `mut` å£°æ˜ï¼Œé®è”½éƒ½æŠ¥é”™
4. **å±€éƒ¨å˜é‡å‡ºä½œç”¨åŸŸé”€æ¯** - å±€éƒ¨ä½œç”¨åŸŸç»“æŸæ—¶å˜é‡è¢«é”€æ¯
5. **For å¾ªç¯è¯­ä¹‰** - `for i in iter` ä¸­çš„ `i` æ˜¯é‡æ–°ç»‘å®šï¼Œæ¯æ¬¡è¿­ä»£åˆ›å»ºæ–°çš„å±€éƒ¨ç»‘å®š

---

## è¯„åˆ†ï¼šğŸŸ¢ å·²ä¿®å¤

## ä½œç”¨åŸŸå®ç°æƒ…å†µæ€»è§ˆ

### ç±»å‹æ¨æ–­é˜¶æ®µï¼ˆExprInferrerï¼‰

| ä½œç”¨åŸŸç±»å‹ | å®ç°çŠ¶æ€ | ä»£ç ä½ç½® |
|-----------|---------|---------|
| For å¾ªç¯ | âœ… å·²å®ç° | expressions.rsï¼ˆenter_scope/exit_scope + try_add_varï¼‰ |
| å‡½æ•°å®šä¹‰ | âœ… å·²å®ç° | expressions.rsï¼ˆenter_scope/exit_scopeï¼‰ |
| Lambda è¡¨è¾¾å¼ | âœ… å·²å®ç° | expressions.rsï¼ˆenter_scope/exit_scopeï¼‰ |
| åˆ—è¡¨æ¨å¯¼ | âœ… å·²å®ç° | expressions.rsï¼ˆenter_scope/exit_scopeï¼‰ |
| If è¯­å¥åˆ†æ”¯ | âœ… **å·²ä¿®å¤** | expressions.rsï¼ˆæ¯ä¸ªåˆ†æ”¯ enter_scope/exit_scopeï¼‰ |
| While å¾ªç¯ä½“ | âœ… **å·²ä¿®å¤** | expressions.rsï¼ˆenter_scope/exit_scopeï¼‰ |

### ç±»å‹æ£€æŸ¥é˜¶æ®µï¼ˆBodyCheckerï¼‰

| ä½œç”¨åŸŸç±»å‹ | å®ç°çŠ¶æ€ | è¯´æ˜ |
|-----------|---------|------|
| ä½œç”¨åŸŸæ ˆ | âœ… **å·²ä¿®å¤** | `scopes: Vec<HashMap<String, PolyType>>` |
| For å¾ªç¯ä½œç”¨åŸŸ | âœ… **å·²ä¿®å¤** | `check_for_stmt` ä½¿ç”¨ enter/exit_scope |
| å‡½æ•°å‚æ•°ä½œç”¨åŸŸ | âœ… **å·²ä¿®å¤** | `check_fn_def` ä½¿ç”¨ enter/exit_scope |
| If è¯­å¥ä½œç”¨åŸŸ | âœ… **å·²ä¿®å¤** | `check_block` è‡ªåŠ¨åˆ›å»ºä½œç”¨åŸŸ |
| æ™®é€šä»£ç å—ä½œç”¨åŸŸ | âœ… **å·²ä¿®å¤** | `check_block` è‡ªåŠ¨åˆ›å»ºä½œç”¨åŸŸ |
| mut é®è”½æ£€æŸ¥ | âœ… **å·²ä¿®å¤** | `check_var_stmt` æ£€æŸ¥ var_exists_in_any_scope |
| For å¾ªç¯é®è”½æ£€æŸ¥ | âœ… å·²å®ç° | `check_for_stmt` æ£€æŸ¥ var_exists_in_any_scope |
| èµ‹å€¼è¡¨è¾¾å¼é®è”½æ£€æŸ¥ | âœ… **å·²ä¿®å¤** | `check_expr_stmt` åŒºåˆ†å½“å‰/å¤–å±‚ä½œç”¨åŸŸ |

---

## å·²ä¿®å¤é—®é¢˜

### ä¿®å¤ 1ï¼šBodyChecker ä½œç”¨åŸŸæ ˆï¼ˆåŸé—®é¢˜ 2ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `src/frontend/typecheck/checking/mod.rs`

**ä¿®æ”¹å†…å®¹**ï¼šå°† `vars: HashMap<String, PolyType>` æ›¿æ¢ä¸º `scopes: Vec<HashMap<String, PolyType>>`

æ–°å¢æ–¹æ³•ï¼š
- `enter_scope()` - è¿›å…¥æ–°ä½œç”¨åŸŸ
- `exit_scope()` - é€€å‡ºå½“å‰ä½œç”¨åŸŸ
- `var_exists_in_any_scope(name)` - æ£€æŸ¥å˜é‡æ˜¯å¦å­˜åœ¨äºä»»ä½•ä½œç”¨åŸŸ
- `var_exists_in_current_scope(name)` - æ£€æŸ¥å˜é‡æ˜¯å¦å­˜åœ¨äºå½“å‰ä½œç”¨åŸŸ
- `update_var(name, poly)` - åœ¨ç°æœ‰ä½œç”¨åŸŸä¸­æ›´æ–°å˜é‡

`add_var` æ”¹ä¸ºæ·»åŠ åˆ°å½“å‰ä½œç”¨åŸŸï¼ˆ`scopes.last_mut()`ï¼‰ï¼Œ`get_var` æ”¹ä¸ºä»å†…å±‚åˆ°å¤–å±‚æœç´¢ã€‚

---

### ä¿®å¤ 2ï¼šmut å£°æ˜é®è”½æ£€æŸ¥ï¼ˆåŸé—®é¢˜ 1ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `src/frontend/typecheck/checking/mod.rs` - `check_var_stmt`

**ä¿®æ”¹å‰**ï¼š
```rust
// å¦‚æœå˜é‡å·²å­˜åœ¨ï¼Œç»Ÿä¸€ç±»å‹  â† é”™è¯¯ï¼å…è®¸äº†é®è”½
if let Some(existing_poly) = self.vars.get(name) {
    let _ = self.solver.unify(&existing_poly.body, &ty);
}
self.vars.insert(name.to_string(), PolyType::mono(ty));
```

**ä¿®æ”¹å**ï¼š
```rust
// é®è”½æ£€æŸ¥ï¼šå¦‚æœå˜é‡å·²å­˜åœ¨äºä»»ä½•ä½œç”¨åŸŸä¸­ï¼ŒæŠ¥é”™
if self.var_exists_in_any_scope(name) {
    return Err(Box::new(
        ErrorCodeDefinition::variable_shadowing(name).build(),
    ));
}
self.add_var(name.to_string(), PolyType::mono(ty));
```

---

### ä¿®å¤ 3ï¼šFor å¾ªç¯ä½œç”¨åŸŸï¼ˆåŸé—®é¢˜ 3ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `src/frontend/typecheck/checking/mod.rs` - `check_for_stmt`

**ä¿®æ”¹å†…å®¹**ï¼šåœ¨å¾ªç¯å˜é‡æ£€æŸ¥å’Œå¾ªç¯ä½“æ£€æŸ¥å‰åæ·»åŠ  `enter_scope()` / `exit_scope()`ï¼Œç¡®ä¿å¾ªç¯å˜é‡åœ¨å¾ªç¯ç»“æŸåè¢«é”€æ¯ã€‚

---

### ä¿®å¤ 4ï¼šèµ‹å€¼è¡¨è¾¾å¼é®è”½æ£€æŸ¥ï¼ˆæ–°å¢ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `src/frontend/typecheck/checking/mod.rs` - `check_expr_stmt`

**ä¿®æ”¹å†…å®¹**ï¼šå¯¹ `BinOp::Assign` çš„å¤„ç†å¢åŠ äº†ä¸‰ç§æƒ…å†µåŒºåˆ†ï¼š
1. **å½“å‰ä½œç”¨åŸŸå­˜åœ¨** â†’ èµ‹å€¼æ“ä½œï¼ˆç»Ÿä¸€ç±»å‹ï¼‰
2. **ä»…å¤–å±‚ä½œç”¨åŸŸå­˜åœ¨** â†’ é®è”½é”™è¯¯
3. **ä¸å­˜åœ¨** â†’ åˆ›å»ºæ–°å˜é‡

---

### ä¿®å¤ 5ï¼šå‡½æ•°å®šä¹‰ä½œç”¨åŸŸï¼ˆæ–°å¢ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `src/frontend/typecheck/checking/mod.rs` - `check_fn_def`

**ä¿®æ”¹å†…å®¹**ï¼šå‡½æ•°å®šä¹‰æ£€æŸ¥ç°åœ¨åˆ›å»ºç‹¬ç«‹çš„å‡½æ•°ä½œç”¨åŸŸï¼Œå‡½æ•°å‚æ•°å’Œå±€éƒ¨å˜é‡åœ¨å‡½æ•°ç»“æŸåè¢«é”€æ¯ã€‚

åŒæ—¶ä» `check_fn_stmt` ä¸­ç§»é™¤äº†é‡å¤çš„å‚æ•°æ·»åŠ é€»è¾‘ï¼Œå‚æ•°ç”± `check_fn_def` åœ¨å‡½æ•°ä½œç”¨åŸŸå†…ç»Ÿä¸€ç®¡ç†ã€‚

---

### ä¿®å¤ 6ï¼šIf/ä»£ç å—ä½œç”¨åŸŸï¼ˆæ–°å¢ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `src/frontend/typecheck/checking/mod.rs` - `check_block`

**ä¿®æ”¹å†…å®¹**ï¼š`check_block` ç°åœ¨è‡ªåŠ¨åˆ›å»ºå’Œé€€å‡ºä½œç”¨åŸŸï¼Œç”¨äº If è¯­å¥çš„ then/elif/else åˆ†æ”¯ã€‚

---

### ä¿®å¤ 7ï¼šExprInferrer If/While ä½œç”¨åŸŸï¼ˆæ–°å¢ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `src/frontend/typecheck/inference/expressions.rs`

**ä¿®æ”¹å†…å®¹**ï¼š
- If è¡¨è¾¾å¼ï¼šæ¯ä¸ªåˆ†æ”¯ï¼ˆthen/elif/elseï¼‰ä½¿ç”¨ç‹¬ç«‹ä½œç”¨åŸŸ
- While è¡¨è¾¾å¼ï¼šå¾ªç¯ä½“ä½¿ç”¨ç‹¬ç«‹ä½œç”¨åŸŸ
- For å¾ªç¯ï¼šä¿®å¤äº† `try_add_var` å¤±è´¥æ—¶æœªé€€å‡ºä½œç”¨åŸŸçš„ bug

---

## æµ‹è¯•è¦†ç›–

æ–°å¢æµ‹è¯•æ–‡ä»¶ï¼š`src/frontend/typecheck/tests/shadowing.rs`ï¼ˆ14 ä¸ªæµ‹è¯•ï¼‰

| æµ‹è¯•åç§° | æµ‹è¯•å†…å®¹ |
|---------|---------|
| `test_body_checker_scope_basic` | åŸºç¡€ä½œç”¨åŸŸè¿›å…¥/é€€å‡º |
| `test_body_checker_nested_scopes` | åµŒå¥—ä½œç”¨åŸŸå˜é‡å¯è§æ€§å’Œé”€æ¯ |
| `test_body_checker_get_var_finds_innermost` | get_var ä¼˜å…ˆè¿”å›å†…å±‚å˜é‡ |
| `test_body_checker_vars_returns_all` | vars() è¿”å›æ‰€æœ‰ä½œç”¨åŸŸå˜é‡ |
| `test_mut_shadowing_error` | mut é‡å¤å£°æ˜æŠ¥é®è”½é”™è¯¯ |
| `test_for_loop_shadowing_error` | for å¾ªç¯ä½¿ç”¨å·²å­˜åœ¨å˜é‡åæŠ¥é”™ |
| `test_for_loop_variable_scoped` | for å¾ªç¯å˜é‡åœ¨å¾ªç¯ç»“æŸåè¢«é”€æ¯ |
| `test_for_loop_no_conflict_with_unique_var` | æ— å†²çªçš„ for å¾ªç¯æ­£å¸¸å·¥ä½œ |
| `test_if_block_creates_scope` | if å—å†…å˜é‡ä¸æ³„æ¼åˆ°å¤–å±‚ |
| `test_assignment_shadowing_in_block` | if å—å†…èµ‹å€¼å¤–å±‚å˜é‡æŠ¥é®è”½é”™è¯¯ |
| `test_assignment_in_same_scope_ok` | åŒä¸€ä½œç”¨åŸŸå†…é‡å¤èµ‹å€¼æ­£å¸¸ |
| `test_inferrer_try_add_var_shadowing` | ExprInferrer é®è”½æ£€æµ‹ |
| `test_inferrer_scope_destroyed_on_exit` | ExprInferrer é€€å‡ºä½œç”¨åŸŸåå˜é‡é”€æ¯ |
| `test_fn_def_creates_scope` | å‡½æ•°å‚æ•°åœ¨å‡½æ•°ç»“æŸåè¢«é”€æ¯ |

---

## æ€»ç»“

### æ¨æ–­é˜¶æ®µï¼ˆExprInferrerï¼‰

| åŠŸèƒ½ | çŠ¶æ€ |
|------|------|
| For å¾ªç¯ä½œç”¨åŸŸ | âœ… å·²å®ç° |
| å‡½æ•°å®šä¹‰ä½œç”¨åŸŸ | âœ… å·²å®ç° |
| Lambda ä½œç”¨åŸŸ | âœ… å·²å®ç° |
| åˆ—è¡¨æ¨å¯¼ä½œç”¨åŸŸ | âœ… å·²å®ç° |
| If è¯­å¥ä½œç”¨åŸŸ | âœ… **å·²ä¿®å¤** |
| While å¾ªç¯ä½“ä½œç”¨åŸŸ | âœ… **å·²ä¿®å¤** |

### æ£€æŸ¥é˜¶æ®µï¼ˆBodyCheckerï¼‰

| åŠŸèƒ½ | çŠ¶æ€ |
|------|------|
| ä½œç”¨åŸŸæ ˆ | âœ… **å·²ä¿®å¤** |
| For å¾ªç¯ä½œç”¨åŸŸ | âœ… **å·²ä¿®å¤** |
| å‡½æ•°å‚æ•°ä½œç”¨åŸŸ | âœ… **å·²ä¿®å¤** |
| If è¯­å¥ä½œç”¨åŸŸ | âœ… **å·²ä¿®å¤** |
| æ™®é€šä»£ç å—ä½œç”¨åŸŸ | âœ… **å·²ä¿®å¤** |
| mut é®è”½æ£€æŸ¥ | âœ… **å·²ä¿®å¤** |
| For å¾ªç¯é®è”½æ£€æŸ¥ | âœ… å·²å®ç° |
| èµ‹å€¼è¡¨è¾¾å¼é®è”½æ£€æŸ¥ | âœ… **å·²ä¿®å¤** |

---

## é—ç•™è¯´æ˜

### For å¾ªç¯"é‡æ–°ç»‘å®š"è¯­ä¹‰

For å¾ªç¯çš„ `i` è¯­ä¹‰ï¼ˆæ¯æ¬¡è¿­ä»£åˆ›å»ºæ–°ç»‘å®šï¼‰åœ¨ IR ç”Ÿæˆå’Œè§£é‡Šå™¨å±‚é¢å¤„ç†ï¼Œç±»å‹æ£€æŸ¥é˜¶æ®µåªéœ€ç¡®ä¿å˜é‡åœ¨ä½œç”¨åŸŸå†…å³å¯ã€‚å½“å‰å®ç°å¯ä»¥æ¥å—ã€‚
