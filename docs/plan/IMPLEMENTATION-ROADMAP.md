# YaoXiang 实现路线图：Phase 4 - 字节码生成器进行中

> **状态**: P4 进行中
> **作者**: 沫郁酱
> **日期**: 2025-01-05
> **最后更新**: 2025-01-06

---

## 一、核心设计原则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        YaoXiang 核心设计原则                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1️⃣  所有内容默认【惰性求值】                                                │
│      ├── 表达式不立即求值，直到被使用时才计算                               │
│      ├── DAG 表示依赖关系，天然支持并行                                      │
│      └── 同步执行只是 DAG 单线程特例                                         │
│                                                                             │
│  2️⃣  默认【异步+并发】                                                      │
│      ├── 所有计算都是 Future/Task                                           │
│      ├── 调度器管理任务执行                                                  │
│      └── 单线程模式 = 1 个 Worker 的调度器                                   │
│                                                                             │
│  3️⃣  【没有 GC】                                                           │
│      ├── 所有权模型 + 借用检查保证内存安全                                   │
│      ├── 栈分配（不逃逸的值）                                               │
│      ├── 区域分配（批量释放）                                               │
│      └── ARC（原子引用计数，可选）                                          │
│                                                                             │
│  4️⃣  DAG 是核心-runtime，不是可选！                                         │
│      ├── 惰性求值依赖 DAG                                                   │
│      ├── 并发执行依赖 DAG                                                   │
│      └── 单线程同步只是 DAG 的特例                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、运行时分层架构（编译型语言）

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           YaoXiang 运行时分层架构                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐   │
│  │                           📦 编译阶段（所有模式相同）                              │   │
│  │                                                                                  │   │
│  │   Source Code                                                                    │   │
│  │       │                                                                          │   │
│  │       ▼                                                                          │   │
│  │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────────┐  │   │
│  │   │  Lexer  │─▶│ Parser  │─▶│TypeCheck│─▶│ Codegen │─▶│  IR / Bytecode      │  │   │
│  │   └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────────────────┘  │   │
│  │                                                                                  │   │
│  │   ⚠️ 重要：编译阶段完全相同！共享同一套代码                                       │   │
│  └──────────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                              │
│                    ┌────────────────────┼────────────────────┐                        │
│                    ▼                    ▼                    ▼                        │
│  ┌──────────────────┐   ┌───────────────┐   ┌──────────────────┐                     │
│  │ 🟢 Embedded      │   │ 🔵 Standard   │   │ 🟣 Full          │                     │
│  │                  │   │               │   │                  │                     │
│  │ 即时执行器        │   │ DAG 调度器    │   │ Full 调度器      │                     │
│  │ 同步执行         │   │ 惰性求值      │   │ 并行优化         │                     │
│  │ 无调度器         │   │ 自动并发      │   │ 工作窃取         │                     │
│  │ 无 DAG 调度      │   │               │   │                  │                     │
│  │                  │   │               │   │                  │                     │
│  └──────────────────┘   └───────────────┘   └──────────────────┘                     │
│                                                                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                              各运行时特性对比                                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  特性              │ Embedded   │ Standard   │ Full                                    │
│  ──────────────────┼────────────┼────────────┼──────────────────                       │
│  编译              │   相同     │   相同     │   相同                                  │
│  语法解析          │   相同     │   相同     │   相同                                  │
│  类型检查          │   相同     │   相同     │   相同                                  │
│  ──────────────────┼────────────┼────────────┼──────────────────                       │
│  运行时            │ 即时执行   │ DAG 调度   │ Full 调度                               │
│  执行模式          │ 同步       │ 惰性+并发   │ 并行                                    │
│  内存占用          │ 低         │ 中         │ 高                                      │
│  启动速度          │ 快         │ 中         │ 中                                      │
│  并发能力          │ 无         │ 自动       │ 自动+并行                               │
│  DAG 惰性求值      │ 无         │ ✅         │ ✅                                      │
│  WorkStealer       │ 无         │ 无         │ ✅                                      │
│  @block         │ 无         │ 无         │ ✅                                      │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 关键理解

| 组件 | 误解 | 正确理解 |
|------|------|----------|
| **编译阶段** | 各运行时不同 | ❌ 完全相同，共享同一套前端 |
| **Embedded** | 需要 DAG 调度 | ❌ 即时执行，无调度开销，高性能 |
| **Standard** | 需要禁用 DAG 才能同步 | ❌ DAG 是核心，单线程=1 worker |
| **Full** | 必须启用所有特性 | ❌ 可选，WorkStealer 是高级特性 |
| **GC** | 需要（可开关） | ❌ 不需要，使用所有权模型 |

---

## 三、MVP 实现依赖图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              YaoXiang MVP 实现依赖图                                  │
│                        (P0=必须, P1=重要, P2=可选, E=嵌入式)                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │                        P0 - 编译期前端（所有运行时共享）                        │ │
│  │                                                                                  │ │
│  │    Lexer ──▶ Parser ──▶ TypeCheck ──▶ Codegen                                  │ │
│  │      │           │            │            │                                     │ │
│  │      ▼           ▼            ▼            ▼                                     │ │
│  │   Tokens      AST         TypedAST    IR/Bytecode                               │ │
│  │                                                                                  │ │
│  │   ⚠️ 重要：编译阶段完全相同！嵌入式/Standard/Full 共享同一套前端                │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                            │
│                    ┌────────────────────┼────────────────────┐                        │
│                    ▼                    ▼                    ▼                        │
│  ┌──────────────────┐   ┌───────────────┐   ┌──────────────────┐                     │
│  │ E - Embedded     │   │ P0 - Standard │   │ P2 - Full        │                     │
│  │                  │   │               │   │                  │                     │
│  │ 即时执行器        │   │ Value         │   │ Standard +       │                     │
│  │ 同步执行         │   │ Allocator     │   │ WorkStealer      │                     │
│  │ 无 DAG 调度      │   │ Ownership     │   │ @block            │                     │ 
│  │                  │   │ DAG           │   │                  │                     │
│  │                  │   │ Scheduler     │   │                  │                     │
│  │                  │   │               │   │                  │                     │
│  │ 目标：           │   │ 目标：         │   │ 目标：           │                     │
│  │ WASM/游戏脚本    │   │ Web服务/数据流 │   │ 科学计算/并行    │                     │
│  └──────────────────┘   └───────────────┘   └──────────────────┘                     │
│                                                                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                              P0 - Standard Runtime（必须）                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                     Core 组件（所有运行时共享）                                │  │
│  │                                                                               │  │
│  │  ┌─────────────────┐                                                          │  │
│  │  │ Value           │ ◀── 运行时值的统一表示                                   │  │
│  │  └────────┬────────┘                                                          │  │
│  │           │                                                                    │  │
│  │  ┌────────┴────────┐  ┌──────────────────────────────────────────────────────┐││
│  │  │                 │  │ Ownership（无此无法保证内存安全）                    │││
│  │  │  Allocator      │  │  ├── BorrowChecker  - 借用检查                      │││
│  │  │  ├─ Stack       │  │  ├── LifetimeTracker - 生命周期跟踪                 │││
│  │  │  ├─ Region      │  │  └── MoveSemantics   - 移动语义                     │││
│  │  │  └─ Pool        │  └──────────────────────────────────────────────────────┘││
│  │  └────────┬────────┘                                                           ││
│  │           │                                                                     ││
│  └───────────┼─────────────────────────────────────────────────────────────────────┘│
│               │                                                                      │
│               ▼ P0                                                                    │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                          DAG ★ 核心（Standard+Full）                         │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                        │  │
│  │  │ NodeId       │  │ DAGNode      │  │ ComputationD │                        │  │
│  │  │ 节点ID生成   │  │ 节点定义     │  │ 图结构       │                        │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                        │  │
│  │                                                                               │  │
│  │  ⚠️ 重要：DAG 是 Standard Runtime 的核心，Embedded 使用即时执行              │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
│                                       │                                              │
│                                       ▼ P0                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                     Scheduler（Standard Runtime 必须）                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                        │  │
│  │  │ Scheduler    │  │ TaskQueue    │  │ Task         │                        │  │
│  │  │ 调度器主逻辑 │  │ 任务队列     │  │ 任务定义     │                        │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                        │  │
│  │                                                                               │  │
│  │  配置：                                                                        │  │
│  │  • num_workers=1 → 单线程异步调度                                             │  │
│  │  • num_workers>1 → 多线程并行调度                                             │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
│                                       │                                              │
│                                       ▼ P0                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                     VM（字节码解释器）                                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                        │  │
│  │  │ Executor     │  │ Frames       │  │ Opcodes      │                        │  │
│  │  │ 执行循环     │  │ 栈帧管理     │  │ 指令定义     │                        │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                        │  │
│  │                                                                               │  │
│  │  VM ◀─── 使用 ───── Standard Runtime 组件                                     │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                              E - Embedded Runtime（可选）                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                     Embedded 即时执行器                                        │  │
│  │  ┌──────────────┐  ┌──────────────┐                                           │  │
│  │  │ Immediate    │  │ SyncExecutor │                                           │  │
│  │  │ Executor     │  │ 同步执行器   │                                           │  │
│  │  │ 即时执行器   │  │              │                                           │  │
│  │  └──────────────┘  └──────────────┘                                           │  │
│  │                                                                               │  │
│  │  特点：                                                                        │  │
│  │  • 无 DAG 内存占用                                                             │  │
│  │  • 无调度开销                                                                  │  │
│  │  • 按顺序同步执行                                                              │  │
│  │  • 编译产物相同，但即时执行                                                    │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                              P1 - 可延后实现                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  P1: 标准库（std）    ┌──────────────────────────────────────────────────────────┐  │
│                       │ core │ collections │ io │ string │ time │ net            │  │
│                       └──────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  P1: 单态化           ┌──────────────────────────────────────────────────────────┐  │
│  (Middle 优化)        │ Monomorphize - 泛型代码特化                               │  │
│                       └──────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  P1: 逃逸分析         ┌──────────────────────────────────────────────────────────┐  │
│  (Middle 优化)        │ EscapeAnalysis - 优化内存分配策略                         │  │
│                       └──────────────────────────────────────────────────────────┘  │
│                                                                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                              P2 - Full Runtime（可选）                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  P2: WorkStealer     ┌──────────────────────────────────────────────────────────┐  │
│                      │ 工作窃取 - 多线程负载均衡                                  │  │
│                      └──────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  P2: @block       ┌──────────────────────────────────────────────────────────┐  │
│                      │ 标准库 - 强制急切求值                                     │  │
│                      └──────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  P2: JIT 编译器       ┌──────────────────────────────────────────────────────────┐  │
│                       │ JIT - 热点代码编译为机器码                                │  │
│                       └──────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  P2: 调试器           ┌──────────────────────────────────────────────────────────┐  │
│                       │ Debugger - 断点、单步执行、变量检查                       │  │
│                       └──────────────────────────────────────────────────────────┘  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、MVP 实现优先级

### P0 - 必须实现（Standard Runtime 核心）

| Phase | 模块 | 文件 | 状态 | 说明 |
|-------|------|------|------|------|
| P1 | Lexer | `src/frontend/lexer/` | ✅ 完成 | Token 完整 |
| P2 | Parser | `src/frontend/parser/` | ✅ 完成 | Pratt Parser 完整 |
| P3 | TypeCheck | `src/frontend/typecheck/` | ✅ 完成 | 类型推断、单态化 |
| P4 | Codegen | `src/middle/codegen/` | 🔶 进行中 | 表达式/语句生成 |
| P5 | Ownership System | `src/middle/ownership/` | ⏳ 待实现 | 所有权/借用/生命周期/SendSync |
| P6 | Lifetime | `src/middle/lifetime/` | ⏳ 待实现 | 生命周期分析 |
| P7 | Monomorphize | `src/middle/monomorphize/` | ✅ 已完成 | 泛型特化 |
| P8 | Core Runtime | `src/runtime/` | ⏳ 待实现 | Value/Allocator/Ownership |
| P9 | DAG | `src/runtime/dag/` | ✅ 已存在 | 惰性计算图 |
| P10 | Scheduler | `src/runtime/scheduler/` | ✅ 已存在 | 任务调度 |
| P11 | VM | `src/vm/` | ⏳ 待实现 | 字节码解释执行 |
| P12-19 | 高级特性 | `src/runtime/` | ⏳ 待实现 | WorkStealer/JIT/Debugger |

### E - Embedded Runtime（可选，嵌入式场景）

| 模块 | 文件 | 说明 |
|------|------|------|
| 即时执行器 | `src/embedded/executor.rs` | 🔶 新建，按顺序同步执行 |
| 嵌入式 API | `src/embedded/mod.rs` | 🔶 新建，WASM/脚本集成 |
| 配置开关 | CLI / feature flag | 🔶 新建，`--embedded` 模式 |

### P1 - 重要（可延后）

| 模块 | 说明 |
|------|------|
| 标准库 | `std::core`, `std::collections`, `std::io` |
| 单态化 | 泛型代码特化 |
| 逃逸分析 | 内存分配优化 |

### P2 - 可选（Full Runtime 高级特性）

| 模块 | 说明 |
|------|------|
| WorkStealer | 工作窃取，多线程负载均衡 |
| @block | 标准库，强制急切求值 |
| JIT 编译器 | 热点代码编译 |
| 调试器 | 断点、单步执行 |

---

## 五、解耦设计：无并发特性时如何运行

```
问题：如何在不启用并发功能时运行解释器？

答案：同步执行只是 DAG 调度的【特殊情况】

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           调度模式配置                                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   模式              │ num_workers │ work_stealing │ 说明                          │
│   ─────────────────┼─────────────┼───────────────┼────────────────────────────────│
│   单线程同步        │      1      │    false      │ 顺序执行，无并行              │
│   多线程并发        │     N>1     │    true       │ 并行执行，负载均衡            │
│   异步调度          │      1      │    true       │ 单线程，事件驱动              │
│                                                                                      │
│   ⚠️ 关键：DAG 和 Scheduler 始终存在，只是配置不同！                               │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 单线程模式示例

```rust
// 单线程配置
let config = SchedulerConfig {
    num_workers: 1,           // 只有一个 worker
    use_work_stealing: false, // 无需窃取
    ..Default::default()
};

let scheduler = FlowScheduler::with_config(config);
// DAG 仍用于惰性求值
// Scheduler 仍用于任务调度
// 只是没有并行执行
```

---

## 六、无 GC 的内存管理

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           内存管理策略（无 GC）                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                         内存来源优先级                                        │  │
│  │                                                                               │  │
│  │  1️⃣ 栈分配（Stack）                                                           │  │
│  │      ├── 场景：编译器确定不逃逸的值                                           │  │
│  │      ├── 特点：分配/释放 O(1)，无 GC 停顿                                     │  │
│  │      └── 由 Ownership 分析确定                                                │  │
│  │                                                                               │  │
│  │  2️⃣ 区域分配（Region/Arena）                                                  │  │
│  │      ├── 场景：批量分配，批量释放                                             │  │
│  │      ├── 特点：适合临时对象                                                   │  │
│  │      └── 例：函数内的临时计算结果                                             │  │
│  │                                                                               │  │
│  │  3️⃣ 堆分配（Heap）+ ARC（可选）                                               │  │
│  │      ├── 场景：跨线程共享或生命周期不确定                                     │  │
│  │      ├── 特点：原子引用计数，无 STW 停顿                                      │  │
│  │      └── 例：spawn 的闭包捕获                                                 │  │
│  │                                                                               │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                         所有权模型保证                                        │  │
│  │                                                                               │  │
│  │  ├── 借用检查：在编译期捕获悬垂引用                                           │  │
│  │  ├── 生命周期跟踪：确保值在其有效范围内使用                                   │  │
│  │  └── 移动语义：避免不必要拷贝                                                 │  │
│  │                                                                               │  │
│  │  结果：无 GC停顿，无内存泄漏，无悬垂指针                                      │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、文件迁移计划

```
当前状态 → 目标状态

src/
├── vm/
│   ├── executor.rs     ──▶ 移除 Value 定义
│   └── mod.rs          ──▶ 简化，只保留 VM 相关
├── runtime/
│   ├── dag/            ✅ 保留，移到 Core Runtime
│   ├── scheduler/      ✅ 保留，移到 Core Runtime
│   └── memory/         ──▶ 整合到 core/allocator.rs
│
└── core/               🔶 新建
    ├── mod.rs
    ├── value.rs        🔶 从 vm/mod.rs 迁移
    ├── allocator.rs    🔶 从 runtime/memory/ 重构
    └── ownership.rs    🔶 新建
```

---

## 八、运行模式总结

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              YaoXiang 运行模式对比                                    │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  模式          │ 编译阶段      │ 运行时          │ 并发能力   │ 目标场景            │
│  ──────────────┼───────────────┼─────────────────┼────────────┼────────────────     │
│  Embedded      │ 相同          │ 即时执行        │ 无         │ WASM/游戏脚本       │
│  Standard      │ 相同          │ DAG + 调度器    │ 自动       │ Web服务/数据流      │
│  Full          │ 相同          │ Standard + WS   │ 自动+并行  │ 科学计算/并行       │
│                                                                                      │
│  ⚠️ 关键：编译阶段完全相同，区别仅在运行时执行方式                                    │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

| 问题 | 解答 |
|------|------|
| 编译阶段是否相同？ | ✅ 完全相同！共享同一套前端代码 |
| Embedded 需要 DAG 吗？ | ❌ 不需要！即时执行，高性能 + 低占用 |
| Standard 需要 DAG 吗？ | ✅ 需要！DAG 是惰性求值的核心 |
| 同步执行怎么办？ | ✅ Embedded 模式即时执行；Standard 单线程（num_workers=1） |
| 没有 GC 怎么办？ | ✅ 所有权模型 + 栈分配 + 区域分配 |
| 解耦怎么实现？ | ✅ Trait + 注入；Embedded/Standard/Full 三层切换 |

---

## 附录：相关 RFC

- [RFC 003: 版本规划](../rfc/003-version-planning.md)
- [RFC 008: Runtime 并发模型与调度器脱耦设计](../rfc/008-runtime-concurrency-model.md)
- [RFC 009: 所有权模型设计](../rfc/009-ownership-model.md)
