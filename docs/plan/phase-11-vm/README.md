# Phase 11: 虚拟机

> **模块路径**: `src/vm/`
> **状态**: ✅ 已重构

## 概述

虚拟机执行字节码指令，实现 YaoXiang 程序的运行时解释。

## 文件结构

```
phase-11-vm/
├── README.md              # 本文档
├── task-12-01-executor.md # 执行器
├── task-12-02-frames.md   # 栈帧管理
├── task-12-03-opcodes.md  # 指令集
├── task-12-04-interrupt.md # 中断处理
└── task-12-05-vm-completeness.md # 指令完整性与栈操作修复
```

## 完成状态

| Task | 名称 | 状态 |
|------|------|------|
| task-12-01 | 执行器 | ✅ 已重构 |
| task-12-02 | 栈帧管理 | ✅ 已重构 |
| task-12-03 | 指令集 | ✅ 已实现 |
| task-12-04 | 中断处理 | ✅ 已实现 |
| task-12-05 | 指令完整性与栈操作修复 | ⏳ 待实施 |

## 架构说明

### 与 Runtime 的关系

```
┌─────────────────────────────────────────────────────┐
│                      VM                              │
│  ┌───────────────────────────────────────────────┐  │
│  │ executor.rs - 执行器                           │  │
│  │ frames.rs    - 调用帧                          │  │
│  │ opcode.rs    - 字节码操作码                    │  │
│  └───────────────────────────────────────────────┘  │
│                         ↓                            │
│              使用 Runtime 提供的类型                 │
│  ┌───────────────────────────────────────────────┐  │
│  │              Runtime (独立模块)                │  │
│  │  value/       - RuntimeValue 类型             │  │
│  │  extfunc/     - 外部函数（print等）           │  │
│  │  memory/      - 内存管理                      │  │
│  │  scheduler/   - 任务调度                      │  │
│  │  dag/         - DAG 支持                      │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

### 设计原则

1. **VM 是解释器**：只负责字节码解释执行
2. **Runtime 是核心**：提供值类型、内置函数、内存管理
3. **extfunc 属于 Runtime**：AOT 打包时静态链接

## 相关文件

- `src/vm/mod.rs` - VM 模块入口
- `src/vm/executor.rs` - 执行器实现
- `src/vm/frames.rs` - 栈帧实现
- `src/vm/opcode.rs` - 操作码定义
- `src/runtime/` - Runtime 模块
