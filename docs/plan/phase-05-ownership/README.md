# Phase 5: æ‰€æœ‰æƒç³»ç»Ÿ

> **æ¨¡å—è·¯å¾„**: `src/core/ownership/`
> **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­
> **è®¾è®¡ä¾æ®**: [RFC-009 æ‰€æœ‰æƒæ¨¡å‹](../../design/rfc/009-ownership-model.md)

## æ¦‚è¿°

æ‰€æœ‰æƒç³»ç»Ÿæ˜¯ YaoXiang è¯­è¨€çš„æ ¸å¿ƒå®‰å…¨æœºåˆ¶ï¼Œç¡®ä¿å†…å­˜å®‰å…¨å’Œå¹¶å‘å®‰å…¨ï¼š

> **æ ¸å¿ƒè®¾è®¡å†³ç­–**ï¼šYaoXiang **ä¸å®ç°ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ `'a`**
> - ç¦æ­¢è¿”å›å€Ÿç”¨å¼•ç”¨ï¼ˆè¿”å›æ•´ä¸ªå€¼ï¼‰
> - ç¦æ­¢ç»“æ„ä½“åŒ…å«å€Ÿç”¨å­—æ®µ
> - å°å¯¹è±¡ç›´æ¥å¤åˆ¶ï¼ˆå¼€é”€å¯å¿½ç•¥ï¼‰
> - å¤§å¯¹è±¡ç”¨ç§»åŠ¨è¯­ä¹‰ï¼ˆé›¶æ‹·è´ï¼‰
> - å…±äº«è®¿é—®ç”¨ Arcï¼ˆé›¶æ‹·è´ï¼‰

- **æ‰€æœ‰æƒ**ï¼šæ¯ä¸ªå€¼æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ‰€æœ‰è€…
- **å€Ÿç”¨**ï¼šé€šè¿‡ `ref`/`mut` ä¸´æ—¶è®¿é—®å€¼
- **æ™ºèƒ½æŒ‡é’ˆ**ï¼šBoxã€Rcã€Arcã€RefCellã€Mutex
- **Send/Sync**ï¼šå¹¶å‘å®‰å…¨çš„ç±»å‹çº¦æŸ

## æ‰€æœ‰æƒè§„åˆ™

### 1. æ‰€æœ‰æƒæ³•åˆ™

```yaoxiang
# æ¯ä¸ªå€¼æœ‰ä¸€ä¸ªæ‰€æœ‰è€…
data: List[Int] = [1, 2, 3]  # data æ˜¯æ‰€æœ‰è€…

# å½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸï¼Œå€¼è¢«é‡Šæ”¾
# ï¼ˆRAII + GC æ··åˆæ¨¡å¼ï¼‰

# æ‰€æœ‰æƒå¯ä»¥è½¬ç§»
new_owner = data  # data ä¸å†å¯ç”¨
```

### 2. å€Ÿç”¨è§„åˆ™

```yaoxiang
# ä¸å¯å˜å€Ÿç”¨ï¼ˆå¤šä¸ª ref T åŒæ—¶å­˜åœ¨ï¼‰
data: List[Int] = [1, 2, 3]
ref1: ref List[Int] = ref data
ref2: ref List[Int] = ref data  # âœ… å…è®¸

# å¯å˜å€Ÿç”¨ï¼ˆåªèƒ½ä¸€ä¸ª mut Tï¼‰
mut data: List[Int] = [1, 2, 3]
ref1: mut List[Int] = mut data  # âœ… åªæœ‰ä¸€ä¸ª
# ref2: mut List[Int] = mut data  # âŒ ä¸å…è®¸

# å€Ÿç”¨ä¸èƒ½è¶…è¿‡æ‰€æœ‰è€…ç”Ÿå‘½å‘¨æœŸ
```

### 3. Send/Sync çº¦æŸ

```yaoxiang
# Sendï¼šå¯ä»¥è·¨çº¿ç¨‹ä¼ è¾“
type Point = Point(x: Int, y: Int)  # âœ… Sendï¼ˆInt æ˜¯ Sendï¼‰

spawn do_work(data: Point)          # âœ… Point å¯ä»¥ä¼ ç»™æ–°çº¿ç¨‹

# Syncï¼šå¯ä»¥è·¨çº¿ç¨‹å…±äº«
shared: ref Point = ref data          # âœ… ref Point æ˜¯ Sync

# Rc ä¸æ˜¯ Sendï¼ˆå¼•ç”¨è®¡æ•°éåŸå­ï¼‰
type NonSend = NonSend(rc: Rc[Int])  # âŒ ä¸èƒ½ spawn
```

## ä»»åŠ¡åˆ—è¡¨

æ ¹æ® RFC-009 è®¾è®¡ï¼Œå®ç°åˆ†ä¸ºä»¥ä¸‹é˜¶æ®µï¼š

| é˜¶æ®µ | ä»»åŠ¡ | åç§° | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| **P1** | task-05-01 | å€Ÿç”¨æ£€æŸ¥ | â³ å¾…å®ç° | P0 |
| **P1** | task-05-02 | æ‰€æœ‰æƒè½¬ç§» | â³ å¾…å®ç° | P0 |
| **P2** | task-05-03 | æ™ºèƒ½æŒ‡é’ˆ Box | â³ å¾…å®ç° | P1 |
| **P2** | task-05-04 | æ™ºèƒ½æŒ‡é’ˆ Rc | â³ å¾…å®ç° | P1 |
| **P2** | task-05-05 | æ™ºèƒ½æŒ‡é’ˆ Arc | â³ å¾…å®ç° | P1 |
| **P3** | task-05-06 | Send çº¦æŸæ£€æŸ¥ | â³ å¾…å®ç° | P1 |
| **P3** | task-05-07 | Sync çº¦æŸæ£€æŸ¥ | â³ å¾…å®ç° | P1 |
| **P4** | task-05-08 | RefCell è¿è¡Œæ—¶å€Ÿç”¨ | â³ å¾…å®ç° | P2 |
| **P4** | task-05-09 | Mutex çº¿ç¨‹å®‰å…¨ | â³ å¾…å®ç° | P2 |

> **è¯´æ˜**ï¼šæ ¹æ® RFC-009 å†³ç­–ï¼ŒYaoXiang ä¸å®ç°æ˜¾å¼ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ `'a`ï¼Œå› æ­¤åŸ task-05-02-lifetime.md å·²ç§»é™¤ã€‚

### ä»»åŠ¡è¯´æ˜

#### P1 é˜¶æ®µï¼šåŸºç¡€æ‰€æœ‰æƒ

**task-05-01 å€Ÿç”¨æ£€æŸ¥**
- `ref T` ä¸å¯å˜å€Ÿç”¨è§„åˆ™ï¼ˆå¯å…±å­˜ï¼‰
- `mut T` å¯å˜å€Ÿç”¨è§„åˆ™ï¼ˆå”¯ä¸€ï¼‰
- å€Ÿç”¨ä¸æ‰€æœ‰è€…çš„ç”Ÿå‘½å‘¨æœŸæ£€æŸ¥
- å®ç°ï¼š`src/core/ownership/borrow.rs`

**task-05-02 æ‰€æœ‰æƒè½¬ç§»**
- Move è¯­ä¹‰ï¼ˆè½¬ç§»ååŸæ‰€æœ‰è€…å¤±æ•ˆï¼‰
- Copy è¯­ä¹‰ï¼ˆå°å¯¹è±¡è‡ªåŠ¨å¤åˆ¶ï¼‰
- Drop è§„åˆ™ï¼ˆRAII èµ„æºé‡Šæ”¾ï¼‰
- å®ç°ï¼š`src/core/ownership/move.rs`

#### P2 é˜¶æ®µï¼šæ™ºèƒ½æŒ‡é’ˆ

**task-05-03 Box[T] å †åˆ†é…**
- å †åˆ†é…ä¸è§£å¼•ç”¨
- é€’å½’ç±»å‹æ”¯æŒ
- å¤§å°ä¸ç¡®å®šç±»å‹æ”¯æŒ

**task-05-04 Rc[T] å¼•ç”¨è®¡æ•°**
- å•çº¿ç¨‹å…±äº«æ‰€æœ‰æƒ
- å¼•ç”¨è®¡æ•°ç®¡ç†
- **é Send/é Sync**

**task-05-05 Arc[T] åŸå­å¼•ç”¨**
- å¤šçº¿ç¨‹å…±äº«æ‰€æœ‰æƒ
- åŸå­å¼•ç”¨è®¡æ•°
- **Send + Sync**

#### P3 é˜¶æ®µï¼šSend/Sync

**task-05-06 Send çº¦æŸæ£€æŸ¥**
- è·¨çº¿ç¨‹æ‰€æœ‰æƒè½¬ç§»å®‰å…¨
- spawn å‚æ•°/è¿”å›å€¼æ£€æŸ¥

**task-05-07 Sync çº¦æŸæ£€æŸ¥**
- è·¨çº¿ç¨‹å…±äº«å¼•ç”¨å®‰å…¨
- ref T åœ¨å¤šçº¿ç¨‹ä¸­çš„å®‰å…¨æ€§

#### P4 é˜¶æ®µï¼šå†…éƒ¨å¯å˜æ€§

**task-05-08 RefCell[T]**
- è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥
- panic on å€Ÿç”¨å†²çª

**task-05-09 Mutex[T]**
- çº¿ç¨‹å®‰å…¨äº’æ–¥é”
- Guard è‡ªåŠ¨é‡Šæ”¾

## ç›¸å…³æ–‡ä»¶

- **src/core/ownership/mod.rs**: æ‰€æœ‰æƒæ£€æŸ¥å™¨ä¸»å®ç°
- **src/core/ownership/borrow.rs**: å€Ÿç”¨æ£€æŸ¥å™¨
- **src/core/ownership/move.rs**: æ‰€æœ‰æƒè½¬ç§»
- **src/core/ownership/send_sync.rs**: Send/Sync æ£€æŸ¥
- **src/middle/escape_analysis/mod.rs**: é€ƒé€¸åˆ†æï¼ˆå‚è€ƒï¼‰

## å‚è€ƒæ–‡æ¡£

- [RFC-009 æ‰€æœ‰æƒæ¨¡å‹](../../design/rfc/009-ownership-model.md)
- [YaoXiang è¯­è¨€è§„èŒƒ](../../design/language-spec.md)
- [RFC-001 å¹¶å‘æ¨¡å‹ä¸é”™è¯¯å¤„ç†](../../design/rfc/001-concurrent-model-error-handling.md)
