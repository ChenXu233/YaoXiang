# Phase 5: æ‰€æœ‰æƒç³»ç»Ÿ

> **æ¨¡å—è·¯å¾„**: `src/core/ownership/`
> **çŠ¶æ€**: ğŸ”„ å¾…å®ç°
> **è®¾è®¡ä¾æ®**: [RFC-009 æ‰€æœ‰æƒæ¨¡å‹](../../design/rfc/009-ownership-model.md)

## æ¦‚è¿°

æ‰€æœ‰æƒç³»ç»Ÿæ˜¯ YaoXiang è¯­è¨€çš„æ ¸å¿ƒå®‰å…¨æœºåˆ¶ï¼Œç¡®ä¿å†…å­˜å®‰å…¨å’Œå¹¶å‘å®‰å…¨ã€‚

> **æ ¸å¿ƒè®¾è®¡å†³ç­–**ï¼šYaoXiang **ä¸å®ç°ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ `'a`**
> - ç¦æ­¢è¿”å›å€Ÿç”¨å¼•ç”¨ï¼ˆè¿”å›æ•´ä¸ªå€¼ï¼‰
> - ç¦æ­¢ç»“æ„ä½“åŒ…å«å€Ÿç”¨å­—æ®µ
> - å°å¯¹è±¡ç›´æ¥å¤åˆ¶ï¼ˆ< 1KBï¼Œå¼€é”€å¯å¿½ç•¥ï¼‰
> - å¤§å¯¹è±¡ç”¨ç§»åŠ¨è¯­ä¹‰ï¼ˆé›¶æ‹·è´ï¼‰
> - **å¼•ç”¨è·¨è¾¹ç•Œè§„åˆ™**ï¼šref/mut **ä¸èƒ½è·¨ä»£ç å—è¾¹ç•Œ**
> - å…±äº«è®¿é—®ç”¨å€¼ä¼ é€’ + Send/DAGï¼ˆArc æ˜¯æ ‡å‡†åº“å…œåº•æ–¹æ¡ˆï¼‰

## æ‰€æœ‰æƒè§„åˆ™

### 1. æ‰€æœ‰æƒæ³•åˆ™

```yaoxiang
# æ¯ä¸ªå€¼æœ‰ä¸€ä¸ªæ‰€æœ‰è€…
data: List[Int] = [1, 2, 3]  # data æ˜¯æ‰€æœ‰è€…

# å½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸï¼Œå€¼è¢«é‡Šæ”¾ï¼ˆRAIIï¼‰

# æ‰€æœ‰æƒå¯ä»¥è½¬ç§»ï¼ˆMoveï¼‰
new_owner = data  # data ä¸å†å¯ç”¨
```

### 2. å¼•ç”¨ç±»å‹

```yaoxiang
# ref T - ä¸å¯å˜å€Ÿç”¨ï¼ˆå¯å…±å­˜ï¼‰
data: List[Int] = [1, 2, 3]
ref1: ref List[Int] = ref data
ref2: ref List[Int] = ref data  # âœ… å…è®¸

# mut T - å¯å˜å€Ÿç”¨ï¼ˆå”¯ä¸€ï¼‰
mut data: List[Int] = [1, 2, 3]
ref1: mut List[Int] = mut data  # âœ… åªæœ‰ä¸€ä¸ª
# ref2: mut List[Int] = mut data  # âŒ ä¸å…è®¸
```

### 3. å¼•ç”¨è·¨è¾¹ç•Œè§„åˆ™ï¼ˆRFC-009 æ ¸å¿ƒè§„åˆ™ï¼‰

> **å¼•ç”¨ä¸èƒ½è·¨ä»£ç å—è¾¹ç•Œ**ã€‚è·¨è¶Šè¾¹ç•Œæ—¶ï¼Œé»˜è®¤å¤±å»æ‰€æœ‰æƒï¼Œéœ€è¦é‡æ–°è·å–æˆ–ä¼ é€’å€¼ã€‚

```yaoxiang
# âŒ é”™è¯¯ï¼šå¼•ç”¨ä¸èƒ½è·¨ spawn è¾¹ç•Œ
bad_example: () -> Void = () => {
    data = Data(42)
    ref_data = ref data
    spawn(() => {
        print(ref_data.value)  # âŒ ref ä¸èƒ½è·¨ä»£ç å—
    })
}

# âœ… æ­£ç¡®ï¼šè·¨è¾¹ç•Œä¼ é€’å€¼ï¼ˆå¤åˆ¶æˆ–ç§»åŠ¨ï¼‰
good_example: () -> Void = () => {
    data = Data(42)
    spawn(() => {
        print(data.value)  # data è‡ªåŠ¨å¤åˆ¶æˆ–ç§»åŠ¨
    })
}
```

### 4. å¤åˆ¶ vs ç§»åŠ¨

```yaoxiang
# å°å¯¹è±¡ï¼ˆ< 1KBï¼‰ï¼šè‡ªåŠ¨å¤åˆ¶ï¼Œå¼€é”€å¯å¿½ç•¥
x: Int = 42
y = x  # å¤åˆ¶ï¼Œx ä»ç„¶å¯ç”¨

# å¤§å¯¹è±¡ï¼šç§»åŠ¨è¯­ä¹‰ï¼ˆé›¶æ‹·è´ï¼‰
type BigData = BigData(buffer: Bytes)  # > 1KB
data = BigData(...)
new_owner = data  # ç§»åŠ¨ï¼Œdata ä¸å†å¯ç”¨
```

### 5. Send/Sync çº¦æŸ

```yaoxiang
# Sendï¼šå¯ä»¥è·¨çº¿ç¨‹ä¼ è¾“
type Point = Point(x: Int, y: Int)  # âœ… Send
spawn do_work(Point(1, 2))

# Syncï¼šå¯ä»¥è·¨çº¿ç¨‹å…±äº«å¼•ç”¨
data: Point = Point(1, 2)
shared: ref Point = ref data  # âœ… ref Point æ˜¯ Sync
```

## ä»»åŠ¡åˆ—è¡¨ï¼ˆæŒ‰å®ç°é¡ºåºï¼‰

æ ¹æ® RFC-009 è®¾è®¡ï¼Œ**ä¸å®ç°ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨**ï¼Œå®ç°é¡ºåºå¦‚ä¸‹ï¼š

| é¡ºåº | ä»»åŠ¡ | åç§° | ä¾èµ– | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| 1 | task-05-01 | æ‰€æœ‰æƒè½¬ç§»ï¼ˆMove/Copy/Dropï¼‰ | æ—  | P0 |
| 2 | task-05-02 | å€Ÿç”¨æ£€æŸ¥ | task-05-01 | P0 |
| 3 | task-05-03 | è·¨è¾¹ç•Œè§„åˆ™æ£€æŸ¥ | task-05-02 | P0 |
| 4 | task-05-04 | å€¼ä¼ é€’æœºåˆ¶ | task-05-03 | P0 |
| 5 | task-05-05 | Send/Sync çº¦æŸæ£€æŸ¥ | task-05-04 | P1 |
| - | - | æ™ºèƒ½æŒ‡é’ˆï¼ˆæ ‡å‡†åº“ï¼‰ | åç»­ | P2 |

> **è¯´æ˜**ï¼šRFC-009 æ˜ç¡®**ä¸å®ç°ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨**ï¼Œ`'a` è¯­æ³•ä¸å­˜åœ¨ã€‚

### ä»»åŠ¡è¯´æ˜

#### Task 5.1: æ‰€æœ‰æƒè½¬ç§»ï¼ˆåŸºç¡€æ¨¡å—ï¼‰

- Move è¯­ä¹‰ï¼ˆè½¬ç§»ååŸæ‰€æœ‰è€…å¤±æ•ˆï¼‰
- Copy è¯­ä¹‰ï¼ˆå°å¯¹è±¡ < 1KB è‡ªåŠ¨å¤åˆ¶ï¼‰
- Drop è§„åˆ™ï¼ˆRAII èµ„æºé‡Šæ”¾ï¼‰
- å®ç°ï¼š`src/core/ownership/move.rs`

> **ä¾èµ–**ï¼šæ— ï¼ˆæ­¤ä»»åŠ¡æ˜¯æ‰€æœ‰æƒç³»ç»Ÿçš„**åŸºç¡€æ¨¡å—**ï¼‰

#### Task 5.2: å€Ÿç”¨æ£€æŸ¥

- `ref T` ä¸å¯å˜å€Ÿç”¨è§„åˆ™ï¼ˆå¯å…±å­˜ï¼‰
- `mut T` å¯å˜å€Ÿç”¨è§„åˆ™ï¼ˆå”¯ä¸€ï¼‰
- å€Ÿç”¨ä¸æ‰€æœ‰è€…çš„ç”Ÿå‘½å‘¨æœŸæ£€æŸ¥ï¼ˆæ— æ˜¾å¼ `'a`ï¼Œè‡ªåŠ¨æ¨æ–­ï¼‰
- å®ç°ï¼š`src/core/ownership/borrow.rs`

> **ä¾èµ–**ï¼štask-05-01ï¼ˆéœ€è¦æ‰€æœ‰æƒçŠ¶æ€ä¿¡æ¯ï¼‰

#### Task 5.3: è·¨è¾¹ç•Œè§„åˆ™æ£€æŸ¥

- ref/mut è·¨ spawn è¾¹ç•Œæ£€æŸ¥
- ref/mut è·¨ channel è¾¹ç•Œæ£€æŸ¥
- è·¨è¾¹ç•Œæ—¶å€¼ä¼ é€’è¯­ä¹‰
- å®ç°ï¼š`src/core/ownership/cross_boundary.rs`

> **ä¾èµ–**ï¼štask-05-02ï¼ˆéœ€è¦å€Ÿç”¨çŠ¶æ€ä¿¡æ¯ï¼‰

#### Task 5.4: å€¼ä¼ é€’æœºåˆ¶

- spawn é—­åŒ…æ•è·å˜é‡æ£€æŸ¥
- å°å¯¹è±¡å¤åˆ¶ï¼ˆ< 1KBï¼‰
- å¤§å¯¹è±¡ç§»åŠ¨ï¼ˆé›¶æ‹·è´ï¼‰
- å€¼ä¼ é€’è¯­ä¹‰éªŒè¯
- å®ç°ï¼š`src/core/ownership/value_pass.rs`

> **ä¾èµ–**ï¼štask-05-03ï¼ˆéœ€è¦è·¨è¾¹ç•Œè§„åˆ™ä¿¡æ¯ï¼‰

#### Task 5.5: Send/Sync çº¦æŸæ£€æŸ¥

- è·¨çº¿ç¨‹æ‰€æœ‰æƒè½¬ç§»å®‰å…¨
- spawn å‚æ•°/è¿”å›å€¼æ£€æŸ¥
- é—­åŒ…æ•è·å˜é‡ Send/Sync æ£€æŸ¥
- å®ç°ï¼š`src/core/ownership/send_sync.rs`

> **ä¾èµ–**ï¼štask-05-04ï¼ˆéœ€è¦å€¼ä¼ é€’ä¿¡æ¯ï¼‰

#### æ ‡å‡†åº“ï¼šæ™ºèƒ½æŒ‡é’ˆï¼ˆåç»­ï¼‰

> æ ‡å‡†åº“æä¾›æç«¯åœºæ™¯å…œåº•ï¼Œéè¯­è¨€æ ¸å¿ƒ

- `Box[T]` - å †åˆ†é…
- `Rc[T]` - å•çº¿ç¨‹å¼•ç”¨è®¡æ•°ï¼ˆ!Send/!Syncï¼‰
- `Arc[T]` - å¤šçº¿ç¨‹åŸå­å¼•ç”¨è®¡æ•°ï¼ˆSend+Syncï¼‰
- `RefCell[T]` - å†…éƒ¨å¯å˜æ€§ï¼ˆè¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥ï¼‰
- `Mutex[T]` - çº¿ç¨‹å®‰å…¨äº’æ–¥
- `std.memory.View` - é›¶æ‹·è´è§†å›¾ï¼ˆæç«¯æ€§èƒ½åœºæ™¯ï¼‰
- å®ç°ï¼š`src/std/sync/`, `src/std/memory/`

> **æ³¨æ„**ï¼šæ ¹æ® RFC-009 è®¾è®¡å†³ç­–ï¼Œæ™ºèƒ½æŒ‡é’ˆæ˜¯**æç«¯åœºæ™¯çš„å…œåº•æ–¹æ¡ˆ**ï¼Œä¸æ˜¯æ—¥å¸¸å·¥å…·ã€‚å¤§å¤šæ•°åœºæ™¯åº”è¯¥ç”¨å€¼ä¼ é€’ + å¤åˆ¶è¯­ä¹‰ã€‚

## ç›¸å…³æ–‡ä»¶

- **src/core/ownership/mod.rs**: æ‰€æœ‰æƒæ£€æŸ¥å™¨ä¸»å®ç°
- **src/core/ownership/move.rs**: æ‰€æœ‰æƒè½¬ç§»ï¼ˆMove/Copy/Dropï¼‰
- **src/core/ownership/borrow.rs**: å€Ÿç”¨æ£€æŸ¥å™¨
- **src/core/ownership/cross_boundary.rs**: è·¨è¾¹ç•Œè§„åˆ™æ£€æŸ¥
- **src/core/ownership/value_pass.rs**: å€¼ä¼ é€’æœºåˆ¶
- **src/core/ownership/send_sync.rs**: Send/Sync æ£€æŸ¥
- **src/middle/escape_analysis/mod.rs**: é€ƒé€¸åˆ†æï¼ˆå‚è€ƒï¼‰

## å‚è€ƒæ–‡æ¡£

- [RFC-009 æ‰€æœ‰æƒæ¨¡å‹](../../design/rfc/009-ownership-model.md)
- [YaoXiang è¯­è¨€è§„èŒƒ](../../design/language-spec.md)
- [RFC-001 å¹¶å‘æ¨¡å‹ä¸é”™è¯¯å¤„ç†](../../design/rfc/001-concurrent-model-error-handling.md)
- [RFC-008 è¿è¡Œæ—¶å¹¶å‘æ¨¡å‹](../../design/rfc/008-runtime-concurrency-model.md)
