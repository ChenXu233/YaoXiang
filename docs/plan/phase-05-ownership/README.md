# Phase 5: æ‰€æœ‰æƒç³»ç»Ÿ

> **æ¨¡å—è·¯å¾„**: `src/core/ownership/`
> **çŠ¶æ€**: ğŸ”„ å¾…å®ç°
> **è®¾è®¡ä¾æ®**: [RFC-009 æ‰€æœ‰æƒæ¨¡å‹ v7](../../design/rfc/009-ownership-model.md)

## æ¦‚è¿°

æ‰€æœ‰æƒç³»ç»Ÿæ˜¯ YaoXiang è¯­è¨€çš„æ ¸å¿ƒå®‰å…¨æœºåˆ¶ï¼Œç¡®ä¿å†…å­˜å®‰å…¨å’Œå¹¶å‘å®‰å…¨ã€‚

> **æ ¸å¿ƒè®¾è®¡å†³ç­–**ï¼šYaoXiang **ä¸å®ç°ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ `'a`** å’Œ**å€Ÿç”¨æ£€æŸ¥å™¨**
> - é»˜è®¤ Moveï¼ˆå€¼ä¼ é€’ï¼‰ï¼Œé›¶æ‹·è´
> - å…±äº«ç”¨ `ref` å…³é”®å­—ï¼ˆArc å¼•ç”¨è®¡æ•°ï¼‰
> - å‰¯æœ¬ç”¨ `clone()` æ˜¾å¼å¤åˆ¶
> - å¾ªç¯å¼•ç”¨ï¼šä»»åŠ¡å†…å…è®¸ï¼Œè·¨ä»»åŠ¡æ£€æµ‹
> - ç³»ç»Ÿçº§ç”¨ `unsafe` + `*T` è£¸æŒ‡é’ˆï¼ˆPhase 6ï¼‰

## æ‰€æœ‰æƒè§„åˆ™

### 1. é»˜è®¤ Moveï¼ˆé›¶æ‹·è´ï¼‰

```yaoxiang
# æ¯ä¸ªå€¼æœ‰ä¸€ä¸ªæ‰€æœ‰è€…
data: List[Int] = [1, 2, 3]  # data æ˜¯æ‰€æœ‰è€…

# å½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸï¼Œå€¼è¢«é‡Šæ”¾ï¼ˆRAIIï¼‰

# æ‰€æœ‰æƒå¯ä»¥è½¬ç§»ï¼ˆMoveï¼‰
new_owner = data  # data ä¸å†å¯ç”¨ï¼Œé›¶æ‹·è´
```

### 2. ref = Arcï¼ˆå®‰å…¨å…±äº«ï¼‰

```yaoxiang
# ref å…³é”®å­—åˆ›å»º Arcï¼ˆå¼•ç”¨è®¡æ•°ï¼‰
p: Point = Point(1.0, 2.0)
shared = ref p    # Arcï¼Œçº¿ç¨‹å®‰å…¨

spawn(() => print(shared.x))   # âœ… å®‰å…¨
# spawn è‡ªåŠ¨æ£€æŸ¥ Send çº¦æŸ
```

**å¾ªç¯å¼•ç”¨è§„åˆ™**ï¼š
- ä»»åŠ¡å†…å¾ªç¯ï¼šå…è®¸ï¼ˆæ³„æ¼å¯æ§ï¼Œä»»åŠ¡ç»“æŸåé‡Šæ”¾ï¼‰
- è·¨ä»»åŠ¡å¾ªç¯ï¼šç¼–è¯‘å™¨æ£€æµ‹å¹¶æŠ¥é”™

### 3. clone() æ˜¾å¼å¤åˆ¶

```yaoxiang
# éœ€è¦ä¿ç•™åŸå€¼æ—¶ä½¿ç”¨ clone()
p: Point = Point(1.0, 2.0)
p2 = p.clone()   # p å’Œ p2 ç‹¬ç«‹

p.x = 0.0        # âœ…
p2.x = 0.0       # âœ… äº’ä¸å½±å“
```

### 4. æ ‡å‡†åº“ï¼šRc / Arc / Weak

```yaoxiang
use std::rc.{Rc, Weak}
use std::sync::Arc

# Rcï¼šéçº¿ç¨‹å®‰å…¨å¼•ç”¨è®¡æ•°
rc: Rc[Node] = Rc::new(node)

# Arcï¼šçº¿ç¨‹å®‰å…¨å¼•ç”¨è®¡æ•°
arc: Arc[Node] = Arc::new(node)

# Weakï¼šæ‰“ç ´å¾ªç¯ï¼ˆä¸å¢åŠ è®¡æ•°ï¼‰
weak: Weak[Node] = Weak::new(arc)
```

## ä»»åŠ¡åˆ—è¡¨

æ ¹æ® RFC-009 v7 è®¾è®¡ï¼Œå®ç°é¡ºåºå¦‚ä¸‹ï¼š

| é¡ºåº | ä»»åŠ¡ | åç§° | ä¾èµ– | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| 1 | task-05-01 | Move è¯­ä¹‰ï¼ˆè½¬ç§»/é‡Šæ”¾ï¼‰ | æ—  | P0 |
| 2 | task-05-02 | mut æ£€æŸ¥ | task-05-01 | P0 |
| 3 | task-05-03 | ref å…³é”®å­—ï¼ˆArcï¼‰ | task-05-01 | P0 |
| 4 | task-05-04 | clone() æ˜¾å¼å¤åˆ¶ | task-05-01 | P0 |
| 5 | task-05-05 | Send/Sync çº¦æŸ | task-05-03 | P1 |
| 6 | task-05-06 | è·¨ä»»åŠ¡å¾ªç¯å¼•ç”¨æ£€æµ‹ | task-05-03, phase-09 | P1 |

> **è¯´æ˜**ï¼šRFC-009 v7 æ˜ç¡®**ä¸å®ç°ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨**å’Œ**å€Ÿç”¨æ£€æŸ¥å™¨**ã€‚

### ä»»åŠ¡è¯´æ˜

#### Task 5.1: Move è¯­ä¹‰ï¼ˆåŸºç¡€æ¨¡å—ï¼‰

- Move è¯­ä¹‰ï¼ˆè½¬ç§»ååŸæ‰€æœ‰è€…å¤±æ•ˆï¼‰
- Drop è§„åˆ™ï¼ˆRAII èµ„æºé‡Šæ”¾ï¼‰
- å€¼ä¼ é€’è¯­ä¹‰
- å®ç°ï¼š`src/core/ownership/move.rs`

> **ä¾èµ–**ï¼šæ— ï¼ˆæ­¤ä»»åŠ¡æ˜¯æ‰€æœ‰æƒç³»ç»Ÿçš„**åŸºç¡€æ¨¡å—**ï¼‰

#### Task 5.2: mut æ£€æŸ¥

- å˜é‡å¯å˜æ€§å£°æ˜
- mut å­—æ®µè®¿é—®è§„åˆ™
- å®ç°ï¼š`src/core/ownership/mut_check.rs`

> **ä¾èµ–**ï¼štask-05-01ï¼ˆéœ€è¦æ‰€æœ‰æƒçŠ¶æ€ä¿¡æ¯ï¼‰

#### Task 5.3: ref å…³é”®å­—ï¼ˆArcï¼‰

- `ref` å…³é”®å­—è§£æä¸º Arc
- å¼•ç”¨è®¡æ•°ç®¡ç†
- è·¨ spawn è¾¹ç•Œå®‰å…¨
- å®ç°ï¼š`src/core/ownership/ref.rs`

> **ä¾èµ–**ï¼štask-05-01ï¼ˆéœ€è¦æ‰€æœ‰æƒçŠ¶æ€ä¿¡æ¯ï¼‰

#### Task 5.4: clone() è¯­ä¹‰

- `clone()` æ–¹æ³•è°ƒç”¨
- å€¼å¤åˆ¶è¯­ä¹‰
- å®ç°ï¼š`src/core/ownership/clone.rs`

> **ä¾èµ–**ï¼štask-05-01ï¼ˆéœ€è¦æ‰€æœ‰æƒçŠ¶æ€ä¿¡æ¯ï¼‰

#### Task 5.5: Send/Sync çº¦æŸæ£€æŸ¥

- è·¨çº¿ç¨‹æ‰€æœ‰æƒè½¬ç§»å®‰å…¨
- spawn å‚æ•°/è¿”å›å€¼æ£€æŸ¥
- ref Arc çš„ Send/Sync è‡ªåŠ¨æ»¡è¶³
- å®ç°ï¼š`src/core/ownership/send_sync.rs`

> **ä¾èµ–**ï¼štask-05-03ï¼ˆéœ€è¦ ref Arc ä¿¡æ¯ï¼‰

#### Task 5.6: è·¨ä»»åŠ¡å¾ªç¯å¼•ç”¨æ£€æµ‹

- åŸºäº DAG åˆ†ææ„å»ºä»»åŠ¡æ ‘
- è¿½è¸ªæ‰€æœ‰ `ref` çš„æºå’Œç›®æ ‡
- æ£€æµ‹è·¨ä»»åŠ¡è¾¹æ˜¯å¦å½¢æˆç¯
- ä»»åŠ¡å†…å¾ªç¯ä¸æ£€æµ‹ï¼ˆæ³„æ¼å¯æ§ï¼‰
- å®ç°ï¼š`src/core/ownership/cycle_check.rs`

> **ä¾èµ–**ï¼štask-05-03ï¼ˆéœ€è¦ ref Arc ä¿¡æ¯ï¼‰ï¼Œphase-09ï¼ˆDAG åˆ†æï¼‰

## ä¸å®ç°

| ç‰¹æ€§ | åŸå›  |
|------|------|
| ç”Ÿå‘½å‘¨æœŸ `'a` | æ— å¼•ç”¨æ¦‚å¿µï¼Œæ— éœ€ç”Ÿå‘½å‘¨æœŸ |
| å€Ÿç”¨æ£€æŸ¥å™¨ | ref = Arc æ›¿ä»£ |
| `&T` å€Ÿç”¨è¯­æ³• | ä½¿ç”¨ Move è¯­ä¹‰ |

## ç›¸å…³æ–‡ä»¶

### ä»»åŠ¡æ–‡ä»¶

| ä»»åŠ¡ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| task-05-01 | [task-05-01-move-transfer.md](task-05-01-move-transfer.md) | Move è¯­ä¹‰ï¼ˆè½¬ç§»/é‡Šæ”¾ï¼‰ |
| task-05-02 | [task-05-02-mut-check.md](task-05-02-mut-check.md) | mut æ£€æŸ¥ |
| task-05-03 | [task-05-03-ref-arc.md](task-05-03-ref-arc.md) | ref å…³é”®å­—ï¼ˆArcï¼‰ |
| task-05-04 | [task-05-04-clone.md](task-05-04-clone.md) | clone() æ˜¾å¼å¤åˆ¶ |
| task-05-05 | [task-05-05-send-sync.md](task-05-05-send-sync.md) | Send/Sync çº¦æŸ |
| task-05-06 | [task-05-06-cycle-detection.md](task-05-06-cycle-detection.md) | è·¨ä»»åŠ¡å¾ªç¯å¼•ç”¨æ£€æµ‹ |

### æºç æ–‡ä»¶

- **src/core/ownership/mod.rs**: æ‰€æœ‰æƒæ£€æŸ¥å™¨ä¸»å®ç°
- **src/core/ownership/move.rs**: Move è¯­ä¹‰
- **src/core/ownership/mut_check.rs**: mut æ£€æŸ¥
- **src/core/ownership/ref.rs**: ref å…³é”®å­—ï¼ˆArcï¼‰
- **src/core/ownership/clone.rs**: clone() è¯­ä¹‰
- **src/core/ownership/send_sync.rs**: Send/Sync æ£€æŸ¥
- **src/core/ownership/cycle_check.rs**: å¾ªç¯å¼•ç”¨æ£€æµ‹

## å‚è€ƒæ–‡æ¡£

- [RFC-009 æ‰€æœ‰æƒæ¨¡å‹ v7](../../design/accepted/009-ownership-model.md)
- [YaoXiang è¯­è¨€è§„èŒƒ](../../design/language-spec.md)
- [RFC-001 å¹¶å‘æ¨¡å‹ä¸é”™è¯¯å¤„ç†](../../design/rfc/001-concurrent-model-error-handling.md)
- [RFC-008 è¿è¡Œæ—¶å¹¶å‘æ¨¡å‹](../../design/accepted/008-runtime-concurrency-model.md)
