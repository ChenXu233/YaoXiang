# Phase 6: unsafe ä»£ç å—ä¸è£¸æŒ‡é’ˆ

> **æ¨¡å—è·¯å¾„**: `src/core/unsafe/`
> **çŠ¶æ€**: ğŸ”„ å¾…å®ç°
> **è®¾è®¡ä¾æ®**: [RFC-009 æ‰€æœ‰æƒæ¨¡å‹ v7](../../design/rfc/009-ownership-model.md)

## æ¦‚è¿°

`unsafe` ä»£ç å—å…è®¸åœ¨å—æ§ç¯å¢ƒä¸­ä½¿ç”¨è£¸æŒ‡é’ˆï¼Œç”¨äºç³»ç»Ÿçº§ç¼–ç¨‹ï¼ˆFFIã€å†…å­˜æ“ä½œç­‰ï¼‰ã€‚

> **æ ¸å¿ƒè®¾è®¡å†³ç­–**ï¼š`unsafe` æ˜¯ç”¨æˆ·ä¿è¯å®‰å…¨çš„"é€ƒç”Ÿèˆ±"
> - è£¸æŒ‡é’ˆ `*T` åªèƒ½åœ¨ `unsafe` å—ä¸­ä½¿ç”¨
> - è£¸æŒ‡é’ˆä¸æ»¡è¶³ Send/Syncï¼ˆå•çº¿ç¨‹ä½¿ç”¨ï¼‰
> - å¯ç»•è¿‡å¾ªç¯å¼•ç”¨æ£€æµ‹ï¼ˆç”¨æˆ·è´Ÿè´£ï¼‰

## unsafe è§„åˆ™

### è£¸æŒ‡é’ˆè¯­æ³•

```yaoxiang
# è£¸æŒ‡é’ˆç±»å‹
PtrType ::= '*' TypeExpr

# è·å–è£¸æŒ‡é’ˆ
p: Point = Point(1.0, 2.0)
ptr: *Point = &p     # è·å–åœ°å€

# è§£å¼•ç”¨ï¼ˆç”¨æˆ·ä¿è¯æœ‰æ•ˆï¼‰
(*ptr).x = 0.0

# æŒ‡é’ˆè¿ç®—
ptr2 = ptr + 1
```

### unsafe ä»£ç å—

```yaoxiang
# unsafe ä»£ç å—è¯­æ³•
UnsafeBlock ::= 'unsafe' '{' Stmt* '}'

# ç¤ºä¾‹
p: Point = Point(1.0, 2.0)

unsafe {
    ptr: *Point = &p     # è£¸æŒ‡é’ˆ
    (*ptr).x = 0.0       # è§£å¼•ç”¨
    # æŒ‡é’ˆè¿ç®—ç­‰...
}

# outside unsafe, raw pointers cannot exist
```

### ç»•è¿‡å¾ªç¯æ£€æµ‹

```yaoxiang
# unsafe é€ƒç”Ÿèˆ±ï¼šå…è®¸è·¨ä»»åŠ¡å¾ªç¯å¼•ç”¨ï¼ˆç”¨æˆ·è´Ÿè´£ï¼‰
unsafe {
    a.child = ref b
    b.child = ref a    # å…è®¸ï¼Œä½†ç”¨æˆ·ä¿è¯ä¸ä¼šå¯¼è‡´é—®é¢˜
}
```

## ä»»åŠ¡åˆ—è¡¨

| é¡ºåº | ä»»åŠ¡ | åç§° | ä¾èµ– | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| 1 | task-06-01 | unsafe å…³é”®å­—è§£æ | æ—  | P0 |
| 2 | task-06-02 | è£¸æŒ‡é’ˆ `*T` ç±»å‹ | task-06-01 | P0 |
| 3 | task-06-03 | unsafe å—ä½œç”¨åŸŸè§„åˆ™ | task-06-01 | P0 |
| 4 | task-06-04 | è£¸æŒ‡é’ˆ Send/Sync çº¦æŸ | task-06-02 | P1 |

### ä»»åŠ¡è¯´æ˜

#### Task 6.1: unsafe å…³é”®å­—è§£æ

- `unsafe` å…³é”®å­—è¯†åˆ«
- `unsafe` å—è¯­æ³•è§£æ
- åµŒå¥— unsafe å—å¤„ç†
- å®ç°ï¼š`src/core/unsafe/parser.rs`

> **ä¾èµ–**ï¼šæ— 

#### Task 6.2: è£¸æŒ‡é’ˆ `*T` ç±»å‹

- è£¸æŒ‡é’ˆç±»å‹è¯­æ³• `*T`
- è£¸æŒ‡é’ˆä¸å…¶ä»–ç±»å‹çš„äº¤äº’
- è£¸æŒ‡é’ˆä¸èƒ½ç¦»å¼€ unsafe å—
- å®ç°ï¼š`src/core/unsafe/types.rs`

> **ä¾èµ–**ï¼štask-06-01

#### Task 6.3: unsafe å—ä½œç”¨åŸŸè§„åˆ™

- è£¸æŒ‡é’ˆçš„ä½œç”¨åŸŸé™åˆ¶
- unsafe å—å†…è¯­å¥ç±»å‹æ£€æŸ¥
- åµŒå¥— unsafe å¤„ç†
- å®ç°ï¼š`src/core/unsafe/checker.rs`

> **ä¾èµ–**ï¼štask-06-01

#### Task 6.4: è£¸æŒ‡é’ˆ Send/Sync çº¦æŸ

- `*T` ä¸æ»¡è¶³ Send
- `*T` ä¸æ»¡è¶³ Sync
- å•çº¿ç¨‹ä½¿ç”¨é™åˆ¶
- å®ç°ï¼š`src/core/unsafe/send_sync.rs`

> **ä¾èµ–**ï¼štask-06-02ï¼Œtask-05-05ï¼ˆSend/Sync çº¦æŸï¼‰

## é™åˆ¶

| é™åˆ¶ | è¯´æ˜ |
|------|------|
| ä½œç”¨åŸŸ | è£¸æŒ‡é’ˆåªèƒ½åœ¨ unsafe å—å†…ä½¿ç”¨ |
| Send/Sync | è£¸æŒ‡é’ˆä¸æ»¡è¶³ Send/Sync |
| ç”Ÿå‘½å‘¨æœŸ | ç”¨æˆ·ä¿è¯ä¸æ‚¬ç©ºã€ä¸é‡Šæ”¾åä½¿ç”¨ |
| å¾ªç¯æ£€æµ‹ | unsafe å†…å¯ç»•è¿‡å¾ªç¯å¼•ç”¨æ£€æµ‹ |

## ç›¸å…³æ–‡ä»¶

- **src/core/unsafe/mod.rs**: unsafe æ£€æŸ¥å™¨ä¸»å®ç°
- **src/core/unsafe/parser.rs**: unsafe è§£æ
- **src/core/unsafe/types.rs**: è£¸æŒ‡é’ˆç±»å‹
- **src/core/unsafe/checker.rs**: ä½œç”¨åŸŸè§„åˆ™æ£€æŸ¥
- **src/core/unsafe/send_sync.rs**: Send/Sync çº¦æŸ

## å‚è€ƒæ–‡æ¡£

- [RFC-009 æ‰€æœ‰æƒæ¨¡å‹ v7](../../design/rfc/009-ownership-model.md)
- [YaoXiang è¯­è¨€è§„èŒƒ](../../design/language-spec.md)
