# YaoXiang Phase 实现方案（RFC-008 对齐版）

> **状态**: 提案中
> **作者**: 晨煦
> **日期**: 2025-01-05
> **依据**: RFC-003（版本规划）、RFC-008（Runtime 并发模型）

---

## 一、核心设计原则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    YaoXiang Phase 实现核心原则                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1️⃣  明确区分「编译期」与「运行时」                                           │
│      ├── 编译期：所有运行时模式共享同一套前端                                │
│      └── 运行时：三层架构（Embedded / Standard / Full）                     │
│                                                                             │
│  2️⃣  运行时依赖顺序（必须按顺序实现）                                        │
│      ├── Core Runtime 基础 → DAG → Scheduler → VM                          │
│      └── Embedded Runtime 可独立实现（无 DAG 依赖）                          │
│                                                                             │
│  3️⃣  版本对应清晰                                                           │
│      ├── 编译期组件 → v0.1-v0.2                                             │
│      ├── Core 运行时 → v0.3                                                 │
│      ├── VM 解释执行 → v0.3                                                 │
│      └── Full Runtime → v0.5+                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、Phase 总览表

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                YaoXiang Phase 总览                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                         📦 编译期阶段（所有模式相同）                                                  │ │
│  │                                                                                                                     │ │
│  │   Phase 1       Phase 2       Phase 3       Phase 4       Phase 5       Phase 6       Phase 7                       │ │
│  │   ────────      ────────      ────────      ────────      ────────      ────────      ────────                      │ │
│  │   Lexer         Parser        TypeCheck     Codegen       Ownership     unsafe       Monomorphize                  │ │
│  │   (词法)        (语法)        (类型)        (IR/Bytecode) (所有权)      (裸指针)     (单态化)                        │ │
│  │                                                                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                            │                                                                │
│                    ┌───────────────────────────────────────┼───────────────────────────────────────┐                   │
│                    ▼                                       ▼                                       ▼                   │
│  ┌───────────────────────────────────────────┐   ┌───────────────────────────────┐   ┌───────────────────────────────┐  │
│  │      🟢 Embedded Runtime（可选）           │   │   🔵 Standard Runtime        │   │      🟣 Full Runtime          │  │
│  │                                             │   │                               │   │                               │  │
│  │   Phase 8: Value + Allocator（共享）        │   │   Phase 9: DAG ★            │   │   Phase 11: WorkStealer       │  │
│  │   Phase 12: Immediate Executor              │   │   Phase 10: Scheduler       │   │   Phase 13: @block            │  │
│  │                                             │   │   Phase 11: VM              │   │                               │  │
│  └───────────────────────────────────────────┘   └───────────────────────────────┘   └───────────────────────────────┘  │
│                                                                                                                             │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                          版本对应                                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                                 │
│  v0.1     v0.2      v0.3      v0.5      v0.7      v0.9      v1.0                                                             │
│    │        │         │         │         │         │         │                                                               │
│    └────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                                                               │
│           编译期前端    Core运行时   Full运行时   优化稳定   自举      AOT                                                     │
│                        + VM解释                                                                                              │
│                                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、详细 Phase 划分

### 第一部分：编译期（所有运行时共享）

| Phase | 组件 | 输入 | 输出 | 依赖 | 版本 | 状态 |
|-------|------|------|------|------|------|------|
| **P1** | Lexer | 源代码 (.yx) | Token 流 | - | v0.1+ | ✅ 完成 |
| **P2** | Parser | Token 流 | AST | P1 | v0.1+ | ✅ 完成 |
| **P3** | TypeCheck | AST | typed AST | P2 | v0.1+ | ⚠️ 有缺陷 |
| **P4** | Codegen | typed AST | IR / Bytecode | P3 | v0.2+ | ⚠️ 基本完成 |
| **P5** | Ownership ★ | 所有权模型（Move/ref/clone/循环检测） | P4 | v0.3+ | 🔶 待开始 |
| **P6** | unsafe | unsafe 代码块 + 裸指针 | P5 | v0.3+ | 🔶 待开始 |
| **P7** | Monomorphize | generic AST → 特化 AST | P3 | v0.4+ | 🔶 待开始 |

### 第二部分：运行时 Core 组件（必须）

| Phase | 组件 | 说明 | 依赖 | 版本 | 状态 |
|-------|------|------|------|------|------|
| **P8** | Value + Allocator | 运行时值表示 + 内存分配 | - | v0.3+ | 🔶 待开始 |
| **P9** | DAG ★ | 惰性求值依赖图（Standard 核心） | P8 | v0.3+ | ⚠️ 基础 |
| **P10** | Scheduler | 任务调度器（单/多线程） | P9 | v0.3+ | ⚠️ 基础 |
| **P11** | VM | 字节码解释器 | P8-P10 | v0.3+ | ⚠️ 基础 |

### 第三部分：Embedded Runtime（可选）

| Phase | 组件 | 说明 | 依赖 | 版本 | 状态 |
|-------|------|------|------|------|------|
| **P12** | Immediate Executor | 即时执行器，无 DAG 调度 | P8 | v0.3+ | 🔶 待开始 |

### 第四部分：Full Runtime（可选）

| Phase | 组件 | 说明 | 依赖 | 版本 | 状态 |
|-------|------|------|------|------|------|
| **P13** | WorkStealer | 工作窃取（负载均衡） | P10 | v0.5+ | 🔶 待开始 |
| **P14** | @block | 标准库强制同步执行 | P11-P13 | v0.5+ | 🔶 待开始 |

### 第五部分：高级特性

| Phase | 组件 | 说明 | 依赖 | 版本 | 状态 |
|-------|------|------|------|------|------|
| **P15** | JIT Compiler | 热点代码编译 | P11 | v0.7+ | 🔶 待开始 |
| **P16** | Debugger | 断点/单步/变量检查 | P11 | v0.7+ | 🔶 待开始 |
| **P17** | Stdlib | 标准库（core/io/net 等） | P11 | v0.5+ | ⚠️ 基础 |
| **P18** | Bootstrap | 自举编译 | P1-P17 | v0.9+ | 🔶 待开始 |
| **P19** | AOT Compiler | AOT 机器码编译 | P18 | v1.0+ | 🔶 待开始 |

---

## 四、RFC-003 编译阶段划分表（修订版）

> **修订说明**：以下划分与 RFC-008 三层运行时架构保持一致

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                           编译阶段详细划分（修订版）                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │  阶段    │  输入              │  输出              │  对应 Phase  │  所有模式      │  版本     │                   │ │
│  ├──────────┼────────────────────┼────────────────────┼──────────────┼────────────────┼───────────┼───────────────────│ │
│  │  1       │  源代码 (.yx)      │  Token 流          │  P1          │  ✅ 相同       │  v0.1+    │  Lexer           │ │
│  │  2       │  Token 流          │  AST               │  P2          │  ✅ 相同       │  v0.1+    │  Parser          │ │
│  │  3       │  AST               │  typed AST         │  P3          │  ✅ 相同       │  v0.1+    │  TypeCheck       │ │
│  │  4       │  typed AST         │  IR / Bytecode     │  P4          │  ✅ 相同       │  v0.2+    │  Codegen         │ │
│  │  ────────────────────────────────────────────────────────────────────────────────────────────────────────────── │ │
│  │  5       │  IR/Bytecode       │  编译期优化        │  P5-P7       │  ✅ 相同       │  v0.3+    │  优化阶段        │ │
│  │  ────────────────────────────────────────────────────────────────────────────────────────────────────────────── │ │
│  │  6a      │  Bytecode          │  即时执行结果      │  P12         │  Embedded     │  v0.3+    │  Embedded 模式   │ │
│  │  6b      │  Bytecode          │  DAG 调度执行      │  P9-P11      │  Standard     │  v0.3+    │  Standard 模式   │ │
│  │  6c      │  Bytecode          │  并行 + WS 执行    │  P9-P14      │  Full         │  v0.5+    │  Full 模式       │ │
│  │  ────────────────────────────────────────────────────────────────────────────────────────────────────────────── │ │
│  │  7       │  源代码            │  即时编译+执行     │  P1-P6       │  ✅ 相同       │  v0.1+    │  REPL            │ │
│  │  ────────────────────────────────────────────────────────────────────────────────────────────────────────────── │ │
│  │  8       │  YaoXiang 源码     │  Bytecode          │  P1-P17      │  ✅ 相同       │  v0.9+    │  Bootstrap       │ │
│  │  9       │  Bytecode/源码     │  机器码            │  P8          │  ✅ 相同       │  v1.0+    │  AOT             │ │
│  └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                                                 │
│  关键说明：                                                                                                                    │
│  • 阶段 1-5 是纯编译期处理，嵌入式/Standard/Full 共享同一套前端代码                                                           │
│  • 阶段 6 区分三种运行时模式（见 RFC-008 三层架构）                                                                             │
│  • 阶段 7 是交互式环境，基于阶段 6 的运行时                                                                                     │
│  • 阶段 8-9 是未来扩展，需要先完成自举和 AOT 基础设施                                                                           │
│                                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                   Phase 依赖关系图                                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                         编译期依赖链（所有模式相同）                                                    │ │
│  │                                                                                                                     │ │
│  │    P1:Lexer ──▶ P2:Parser ──▶ P3:TypeCheck ──▶ P4:Codegen                                                          │ │
│  │                                                        │                                                            │ │
│  │                                                        ▼                                                            │ │
│  │                                           P5:Ownership ──▶ P6:unsafe ──▶ P7:Monomorphize                          │ │
│  │                                                                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                            │                                                                │
│                                                            ▼                                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                        Core 运行时依赖链（必须实现）                                                  │ │
│  │                                                                                                                     │ │
│  │    P8:Value+Allocator ──▶ P9:DAG ★ ──▶ P10:Scheduler ──▶ P11:VM                                                    │ │
│  │                                                                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                           │                                        │                    │                              │
│                           ▼                                        ▼                    ▼                              │
│  ┌──────────────────────────────┐      ┌──────────────────────────────────────────────┐                              │
│  │    🟢 Embedded Runtime       │      │              🟣 Full Runtime                 │                              │
│  │                              │      │                                              │                              │
│  │   P12:Immediate Executor     │      │   P13:WorkStealer ──▶ P14:@block            │                              │
│  │   (无 DAG 依赖)              │      │   (依赖 P10 Scheduler)                       │                              │
│  └──────────────────────────────┘      └──────────────────────────────────────────────┘                              │
│                                                                                                                                 │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                 高级特性依赖                                                                │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                                 │
│  P11:VM ──▶ P15:JIT ──▶ P16:Debugger                                                                                         │
│  P11:VM ──▶ P17:Stdlib                                                                                                        │
│                                                                                                                                 │
│  P1-P17 ──▶ P18:Bootstrap ──▶ P19:AOT                                                                                        │
│                                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、运行时模式与 Phase 对应

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                             运行时模式与 Phase 对应                                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                                 │
│  模式          │ 需要的 Phase              │ 不需要的 Phase        │ 首次支持版本  │ 目标场景                          │
│  ──────────────┼───────────────────────────┼───────────────────────┼───────────────┼────────────────────────────────   │
│  **Embedded**  │ P1-P4, P8, P12            │ P9-P11, P13-P14       │ v0.3          │ WASM / 游戏脚本 / 规则引擎        │
│  **Standard**  │ P1-P4, P8-P11             │ P12-P14               │ v0.3          │ Web 服务 / 数据管道 / 事件驱动    │
│  **Full**      │ P1-P4, P8-P14             │ P12                   │ v0.5          │ 科学计算 / 大规模并行处理         │
│  **REPL**      │ P1-P7 + 任意运行时        │ -                     │ v0.1          │ 交互式开发                        │
│  **AOT**       │ P1-P19 全部               │ -                     │ v1.0          │ 生产部署                          │
│                                                                                                                                 │
│  ⚠️ 关键：                                                                                                                    │
│  • Embedded 模式不需要 DAG、Scheduler、VM，可以独立实现                                                                          │
│  • Standard 模式是默认模式，包含完整的 Core 运行时                                                                               │
│  • Full 模式在 Standard 基础上添加 WorkStealer 和 @block                                                                       │
│                                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、版本路线图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                             YaoXiang 版本路线图                                                              │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                                 │
│  v0.1        v0.2        v0.3        v0.5        v0.7        v0.9        v1.0                                                │
│    │          │           │           │           │           │           │                                                   │
│    │          │           │           │           │           │           │                                                   │
│  ┌────┐    ┌────┐    ┌───────┐    ┌───────┐    ┌───────┐    ┌───────┐    ┌───────┐                                        │
│  │P1-4│    │P1-4 │    │P8-12  │    │P13-14 │    │P15-16 │    │ P18   │    │ P19   │                                        │
│  │    │    │     │    │+P9-11 │    │+P17   │    │+P17   │    │       │    │       │                                        │
│  └────┘    └────┘    └───────┘    └───────┘    └───────┘    └───────┘    └───────┘                                        │
│                                                                                                                             │
│  编译前端    编译前端     Core RT      Full RT      高级特性     自举        AOT                                             │
│  (Lexer→    (完整)      + VM         + Stdlib     + Debugger   编译        编译                                            │
│   Bytecode)            Embedded/     (可选)       JIT                                                                        │
│                        Standard)                                                                                             │
│                                                                                                                             │
│  ✅ REPL      ✅ 完整       ✅ 嵌入式      ✅ 并行        ✅ 优化       ✅ 自举      ✅ 原生                                  │
│               编译         ✅ 标准运行时   ✅ 调试        ✅ 分析       ✅ 验证      ✅ 部署                                   │
│                                                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、与原 RFC-003 的差异

| 差异点 | 原 RFC-003 | 本方案（RFC-008 对齐） |
|--------|-----------|----------------------|
| **阶段划分维度** | 混合（编译流程 + 组件） | 分离（编译期 / 运行时 Core / 运行时模式 / 高级特性） |
| **运行时体现** | 笼统的 "VM 解释执行" | 明确三层架构（Embedded / Standard / Full） |
| **版本对应** | DAG 在阶段 6 才出现 | DAG 在 P9（v0.3），与 VM 同时 |
| **Embedded 模式** | 未提及 | 独立路径（P12），无 DAG 依赖 |
| **依赖关系** | 不清晰 | 明确展示（DAG → Scheduler → VM） |

---

## 九、行动项

- [ ] RFC-003 更新 2.3 编译阶段划分表
- [ ] 更新 IMPLEMENTATION-ROADMAP.md
- [ ] 检查 plan 目录 Phase 文件与本方案的一致性
- [ ] 根据本方案调整 Phase 优先级

---

## 附录：相关 RFC

- [RFC-003: 版本规划与实现建议](../docs/design/rfc/003-version-planning.md)
- [RFC-008: Runtime 并发模型与调度器脱耦设计](../docs/design/rfc/008-runtime-concurrency-model.md)
