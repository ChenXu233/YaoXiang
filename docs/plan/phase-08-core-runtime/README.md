# Phase 08: Core Runtimeï¼ˆæ ¸å¿ƒè¿è¡Œæ—¶ï¼‰

> **é˜¶æ®µç›®æ ‡**ï¼šå®ç°æ‰€æœ‰è¿è¡Œæ—¶å…±äº«çš„æ ¸å¿ƒç»„ä»¶
> **å‰ç½®ä¾èµ–**ï¼šphase-05-ownershipï¼ˆæ‰€æœ‰æƒæ¨¡å‹ï¼‰

## æ–‡ä»¶ç»“æ„

```
src/core/                    # Core ç»„ä»¶ï¼ˆæ‰€æœ‰è¿è¡Œæ—¶å…±äº«ï¼‰
â”œâ”€â”€ mod.rs
â”œâ”€â”€ value.rs                 # å€¼ç±»å‹ï¼ˆtask-08-01ï¼‰
â””â”€â”€ allocator.rs             # å†…å­˜åˆ†é…ï¼ˆtask-08-02ï¼‰

src/embedded/                # ğŸŸ¢ åµŒå…¥å¼ï¼ˆæ—  DAGï¼‰
â”œâ”€â”€ mod.rs
â””â”€â”€ executor.rs              # å³æ—¶æ‰§è¡Œå™¨ï¼ˆtask-08-03ï¼‰

src/runtime/                 # ğŸ”µ æ ‡å‡†è¿è¡Œæ—¶
â”œâ”€â”€ mod.rs
â”œâ”€â”€ standard_runtime.rs      # æ ‡å‡†è¿è¡Œæ—¶å…¥å£ï¼ˆtask-08-07ï¼‰
â””â”€â”€ scheduler/               # è°ƒåº¦å™¨ï¼ˆæ³›å‹çº¦æŸï¼‰
    â”œâ”€â”€ mod.rs
    â”œâ”€â”€ trait.rs             # è°ƒåº¦å™¨æ¥å£ï¼ˆtask-08-04ï¼‰
    â”œâ”€â”€ single_thread.rs     # å•çº¿ç¨‹è°ƒåº¦å™¨ï¼ˆtask-08-05ï¼‰
    â””â”€â”€ multi_thread.rs      # å¤šçº¿ç¨‹è°ƒåº¦å™¨ï¼ˆtask-08-06ï¼‰

src/full/                    # ğŸŸ£ Full Runtimeï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ mod.rs
â””â”€â”€ work_stealer.rs          # å·¥ä½œçªƒå–ï¼ˆtask-08-08ï¼‰
```

## å®ç°é¡ºåºï¼ˆä¾èµ–å…³ç³»ï¼‰

```
é˜¶æ®µ 1: Core ç»„ä»¶ï¼ˆæ— ä¾èµ–ï¼‰
â”œâ”€â”€ task-08-01: value.rs
â””â”€â”€ task-08-02: allocator.rs

é˜¶æ®µ 2: Embedded Runtimeï¼ˆä¾èµ– Coreï¼‰
â””â”€â”€ task-08-03: embedded/executor.rs

é˜¶æ®µ 3: è°ƒåº¦å™¨æ¥å£ï¼ˆä¾èµ– Coreï¼‰
â”œâ”€â”€ task-08-04: scheduler/trait.rs
â”œâ”€â”€ task-08-05: scheduler/single_thread.rs
â””â”€â”€ task-08-06: scheduler/multi_thread.rs

é˜¶æ®µ 4: Standard Runtimeï¼ˆä¾èµ– Core + è°ƒåº¦å™¨ï¼‰
â””â”€â”€ task-08-07: runtime/standard_runtime.rs

é˜¶æ®µ 5: Full Runtimeï¼ˆä¾èµ– Standardï¼Œå¯é€‰ï¼‰
â””â”€â”€ task-08-08: full/work_stealer.rs
```

## å­ä»»åŠ¡åˆ—è¡¨

| ID | ä»»åŠ¡ | ä¼˜å…ˆçº§ | çŠ¶æ€ | æ¨¡å— | ä¾èµ– |
|----|------|--------|------|------|------|
| 8.1 | [å€¼ç±»å‹ç³»ç»Ÿ](./task-08-01-value-type.md) | P0 | â¬œ | `src/core/value.rs` | æ—  |
| 8.2 | [å†…å­˜åˆ†é…å™¨](./task-08-02-allocator-interface.md) | P0 | â¬œ | `src/core/allocator.rs` | 8.1 |
| 8.3 | [åµŒå…¥å¼æ‰§è¡Œå™¨](./task-08-03-embedded-executor.md) | P1 | â¬œ | `src/embedded/executor.rs` | 8.1, 8.2 |
| 8.4 | [è°ƒåº¦å™¨æ¥å£](./task-08-04-scheduler-trait.md) | P1 | â¬œ | `src/runtime/scheduler/trait.rs` | 8.1 |
| 8.5 | [å•çº¿ç¨‹è°ƒåº¦å™¨](./task-08-05-single-thread-scheduler.md) | P1 | â¬œ | `src/runtime/scheduler/single_thread.rs` | 8.4 |
| 8.6 | [å¤šçº¿ç¨‹è°ƒåº¦å™¨](./task-08-06-multi-thread-scheduler.md) | P1 | â¬œ | `src/runtime/scheduler/multi_thread.rs` | 8.5 |
| 8.7 | [æ ‡å‡†è¿è¡Œæ—¶å…¥å£](./task-08-07-standard-runtime.md) | P1 | â¬œ | `src/runtime/standard_runtime.rs` | 8.4, 8.5, 8.6 |
| 8.8 | [å·¥ä½œçªƒå–](./task-08-08-work-stealer.md) | P2 | â¬œ | `src/full/work_stealer.rs` | 8.7 |

## è®¾è®¡ä¾æ®

| æ–‡æ¡£ | å…³é”®å†…å®¹ |
|------|----------|
| **RFC-008** | Runtime å¹¶å‘æ¨¡å‹ä¸è°ƒåº¦å™¨è„±è€¦è®¾è®¡ |
| **RFC-009** | æ‰€æœ‰æƒæ¨¡å‹ï¼ˆMove/ref/cloneï¼‰ |
| **manifesto.md** | é›¶æˆæœ¬æŠ½è±¡ã€é»˜è®¤ä¸å¯å˜ã€æ—  GC |

## æ ¸å¿ƒè®¾è®¡å†³ç­–

### 1. æ—  GCï¼Œä½¿ç”¨æ‰€æœ‰æƒæ¨¡å‹

```
âŒ åƒåœ¾å›æ”¶ï¼ˆGCï¼‰
   - æš‚åœæ—¶é—´é•¿
   - å†…å­˜å ç”¨é«˜
   - æ— æ³•é¢„æµ‹å»¶è¿Ÿ

âœ… æ‰€æœ‰æƒæ¨¡å‹
   - Move è¯­ä¹‰ï¼šé›¶æ‹·è´è½¬ç§»
   - ref å…³é”®å­—ï¼šArc å¼•ç”¨è®¡æ•°
   - clone()ï¼šæ˜¾å¼æ·±æ‹·è´
   - RAIIï¼šå€¼ç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾
```

### 2. è°ƒåº¦å™¨è„±è€¦ï¼ˆæ³›å‹ + æ³¨å…¥ï¼‰

```rust
// RFC-008 æ–¹æ¡ˆ C'ï¼šæ³›å‹ + æ³¨å…¥
struct VM<S: Scheduler> {
    scheduler: Arc<S>,
    // ...
}

impl<S: Scheduler> VM<S> {
    fn spawn(&self, task: Arc<dyn Task>) -> TaskId {
        self.scheduler.spawn(task)
    }
}
```

### 3. åŒæ­¥æ˜¯è°ƒåº¦çš„ç‰¹ä¾‹

```
âŒ ç¦ç”¨è°ƒåº¦å™¨
   scheduler.disabled = true

âœ… åŒæ­¥æ˜¯è°ƒåº¦çš„ç‰¹ä¾‹
   scheduler = SingleThreadScheduler::new()
   num_workers=1 â†’ å¹¶å‘è¡¨ç°ä¸ºå¼‚æ­¥
```

## è¿è¡Œæ—¶å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YaoXiang è¿è¡Œæ—¶ä¸‰å±‚æ¶æ„                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ç¼–è¯‘é˜¶æ®µ                                                        â”‚
â”‚      â”‚                                                         â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     åŒä¸€å¥—å‰ç«¯ï¼ˆLexer/Parser/TypeCheck/Codegenï¼‰        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                                          â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚      â–¼            â–¼            â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚Embeddedâ”‚  â”‚Standard â”‚  â”‚  Full   â”‚                         â”‚
â”‚  â”‚ è¿è¡Œæ—¶  â”‚  â”‚  è¿è¡Œæ—¶  â”‚  â”‚  è¿è¡Œæ—¶  â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚      â”‚            â”‚            â”‚                              â”‚
â”‚      â–¼            â–¼            â–¼                              â”‚
â”‚  å³æ—¶æ‰§è¡Œ    DAG+è°ƒåº¦    DAG+è°ƒåº¦+WorkStealer                 â”‚
â”‚  æ—  DAG      num_workers   num_workers>1                      â”‚
â”‚  æ— å¹¶å‘      1=å¼‚æ­¥        å¹¶è¡Œ+è´Ÿè½½å‡è¡¡                       â”‚
â”‚              >1=å¹¶è¡Œ                                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¾èµ–å…³ç³»å›¾

```
                    phase-05-ownership
                           â”‚
                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Phase 08                          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                     â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
    â”‚  â”‚  task-8.1â”‚â”€â”€â”€â–ºâ”‚  task-8.2â”‚                         â”‚
    â”‚  â”‚ value.rs â”‚    â”‚alloc.rs â”‚                         â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         â”‚
    â”‚                      â”‚                               â”‚
    â”‚                      â–¼                               â”‚
    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
    â”‚              â”‚  task-8.3   â”‚                         â”‚
    â”‚              â”‚embedded.exe â”‚                         â”‚
    â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚
    â”‚                     â”‚                                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                     â”‚                                â”‚
    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                         â”‚
    â”‚              â”‚  task-8.4   â”‚                         â”‚
    â”‚              â”‚scheduler.trâ”‚                         â”‚
    â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚
    â”‚                     â”‚                                â”‚
    â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
    â”‚           â–¼                   â–¼                       â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
    â”‚   â”‚  task-8.5   â”‚      â”‚  task-8.6   â”‚                â”‚
    â”‚   â”‚single_threadâ”‚      â”‚multi_thread â”‚                â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                â”‚
    â”‚          â”‚                     â”‚                       â”‚
    â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
    â”‚                     â”‚                                  â”‚
    â”‚                     â–¼                                  â”‚
    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
    â”‚              â”‚  task-8.7   â”‚                           â”‚
    â”‚              â”‚std_runtime  â”‚                           â”‚
    â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â”‚
    â”‚                     â”‚                                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                     â”‚                                  â”‚
    â”‚                     â–¼                                  â”‚
    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
    â”‚              â”‚  task-8.8   â”‚                           â”‚
    â”‚              â”‚work_stealerâ”‚                           â”‚
    â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
    â”‚                     â”‚                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     phase-09-dag      â”‚
              â”‚   (è°ƒåº¦å™¨ä¾èµ– DAG)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## éªŒæ”¶æ ‡å‡†

| ä»»åŠ¡ | éªŒæ”¶æ ‡å‡† |
|------|----------|
| 8.1 | âœ… `RuntimeValue` èƒ½è¡¨ç¤ºæ‰€æœ‰ YaoXiang ç±»å‹ |
| 8.2 | âœ… åˆ†é…å™¨æ”¯æŒ Move/ref/clone è¯­ä¹‰ |
| 8.3 | âœ… åµŒå…¥å¼è¿è¡Œæ—¶èƒ½æ­£ç¡®æ‰§è¡Œå­—èŠ‚ç ï¼ˆå¿½ç•¥ spawnï¼‰ |
| 8.4 | âœ… è°ƒåº¦å™¨æ¥å£æ”¯æŒä»»æ„è°ƒåº¦å™¨å®ç° |
| 8.5 | âœ… å•çº¿ç¨‹è°ƒåº¦å™¨å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ |
| 8.6 | âœ… å¤šçº¿ç¨‹è°ƒåº¦å™¨å¹¶è¡Œæ‰§è¡Œä»»åŠ¡ |
| 8.7 | âœ… æ ‡å‡†è¿è¡Œæ—¶èƒ½æ­£ç¡®ä½¿ç”¨æ³›å‹è°ƒåº¦å™¨ |
| 8.8 | âœ… å·¥ä½œçªƒå–å®ç°è´Ÿè½½å‡è¡¡ï¼ˆå¯é€‰ï¼‰ |

## RFC å¯¹ç…§è¡¨

### RFC-008 å†³ç­–

| RFC-008 å†³ç­– | å®ç°ä½ç½® |
|-------------|---------|
| è°ƒåº¦å™¨è„±è€¦ï¼ˆæ³›å‹ + æ³¨å…¥ï¼‰ | `VM<S: Scheduler>` (8.7) |
| åŒæ­¥æ˜¯è°ƒåº¦çš„ç‰¹ä¾‹ | SingleThreadScheduler (8.5) |
| DAG å±äº Runtime | phase-09-dag |
| WorkStealer æ˜¯ Full Runtime | task-8.8 |
| @block ç”±æ ‡å‡†åº“æä¾› | stdlib |
| åµŒå…¥å¼å³æ—¶æ‰§è¡Œ | task-8.3 |

### RFC-009 æ‰€æœ‰æƒæ¨¡å‹

| RFC-009 è®¾è®¡ | å®ç°ä½ç½® |
|-------------|---------|
| Move è¯­ä¹‰ | RuntimeValue èµ‹å€¼é›¶æ‹·è´ (8.1) |
| `ref` å…³é”®å­— | RuntimeValue::Arc (8.1) |
| `clone()` | RuntimeValue::clone() (8.1) |
| `*T` è£¸æŒ‡é’ˆ | RuntimeValue::Ptr (8.1) |
| Send/Sync | è‡ªåŠ¨æ»¡è¶³ (8.1) |
| è·¨ä»»åŠ¡å¾ªç¯æ£€æµ‹ | ç¼–è¯‘æœŸå®Œæˆ (phase-05) |
