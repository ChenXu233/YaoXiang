---
title: 第八章：谁拥有数据
---

# 第八章：谁拥有数据

> 本章目标：理解所有权思想，为什么数据要有"主人"，以及空状态的概念


## 8.1 一个问题

假设你有一本书，借给了同学：

```yaoxiang
# 你有本书
book: Book = Book("《三体》")

# 你把书借给了同学
book_given = book    # 书给了别人
```

**问题**：
- 你还能用这本书吗？
- 同学还能用这本书吗？
- 谁负责还书（释放内存）？

这就是**所有权**要解决的问题！


## 8.2 什么是所有权？

**所有权**，就是每份数据都有一个"主人"（所有者）。

| 规则 | 说明 |
|------|------|
| **规则1** | 每个值都有一个所有者 |
| **规则2** | 同一时间只有一个所有者 |
| **规则3** | 当所有者离开作用域，值被自动清除 |

```yaoxiang
# 例子：所有权转移
p: Point = Point(1.0, 2.0)   # p 是 Point 的所有者

p2 = p                         # ⚠️ 所有权转移！p 变空

# print(p.x)  # ❌ 错误！p 已经不再是所有者
# p2.x = 0.0  # ✅ 正确！p2 现在是所有者
```


## 8.3 为什么要所有权？

| 方法 | 优点 | 缺点 |
|------|------|------|
| **手动管理**（C/C++） | 灵活 | 容易忘记释放、重复释放 |
| **垃圾回收**（Java/Python） | 自动 | 有延迟、内存占用高 |
| **所有权**（YaoXiang/Rust） | 自动 + 安全 | 学习曲线陡 |

**YaoXiang 的所有权**：
- ✅ 自动释放内存（不用手动管理）
- ✅ 没有垃圾回收的开销
- ✅ 保证内存安全（不会有悬空指针）


## 8.4 移动（Move）

**移动**，就是所有权的转移：

```yaoxiang
# 移动示例
source: String = "Hello"
target = source              # 移动！source 变空

# source = "Hello"          # ❌ 错误！source 已经变空
print(target)                # ✅ 正确！target 是新所有者
```

**示意图**：

```
移动前：
┌─────────────┐     ┌─────────────────┐
│  source    │ ──▶ │   "Hello"       │
│  "Hello"    │     │   (字符串值)     │
└─────────────┘     └─────────────────┘

移动后：
┌─────────────┐     ┌─────────────────┐
│  source    │     │   (空)           │  ← 变空
│             │     └─────────────────┘
└─────────────┘
┌─────────────┐     ┌─────────────────┐
│  target    │ ──▶ │   "Hello"       │
│  "Hello"    │     │   (字符串值)     │
└─────────────┘     └─────────────────┘
```

## 8.5 空状态（Empty State）

**空状态**，就是变量被移动后的状态：

```yaoxiang
# 空状态示例
counter: Int = 0

# 第一次赋值
counter = 1
counter = 2

# 移动后变空
other = counter    # counter 变空

# 可以重新赋值（复用变量名）
counter = 100       # ✅ counter 被重新赋值
```

**空状态的规则**：
- 被移动后，变量进入空状态
- 空状态可以重新赋值（复用变量名）
- 不能使用空状态的变量


## 8.6 作用域与所有权

```yaoxiang
scope_example: () -> Void = {
    # 创建值
    value: String = "Hello, scope!"

    print(value)   # ✅ 可以使用

    # 函数结束，value 被自动清除
    # 所有者的"生命"结束了
}

# value 在这里已经不存在了
```


## 8.7 为什么要移动而不是复制？

**性能**：移动只需要改指针，不需要复制数据！

```yaoxiang
# 移动大对象
large_list: List[String] = load_very_large_list()
other_list = large_list    # ⚠️ 移动！零拷贝

# 如果是复制，会很慢：
# other_list = large_list.clone()  # ❌ 没必要，性能差
```


## 8.8 三种共享方式

| 方式 | 关键字 | 适用场景 | 性能 |
|------|--------|----------|------|
| **移动** | 默认 | 需要唯一所有者 | 零开销 |
| **引用** | `ref` | 需要共享 | 中等（原子操作） |
| **克隆** | `.clone()` | 需要副本 | 视类型而定 |

```yaoxiang
# 移动（默认）
p: Point = Point(1.0, 2.0)
p2 = p                    # p 变空，p2 是新所有者

# 引用（共享）
p: Point = Point(1.0, 2.0)
shared = ref p           # 共享，Arc 引用计数

# 克隆（复制）
p: Point = Point(1.0, 2.0)
p2 = p.clone()           # p 和 p2 都是独立所有者
```


## 8.9 本章小结

| 概念 | 理解 |
|------|------|
| 所有权 | 每份数据有一个唯一的所有者 |
| 移动（Move） | 所有权的转移 |
| 空状态 | 变量被移动后的状态 |
| 作用域 | 变量的有效范围 |


## 8.10 易经引言

> 「夫唯不争，故天下莫能与之争。」
> —— 《道德经》
>
> 所有权之道，在于"不争"：
> - 每一个值，只有一个主人
> - 转移时，旧主人放手，新主人接手
> - 不多争、不妄争
>
> 如同太极流转，阳动阴随，生生不息。
> 所有权之争息，内存之道生。
