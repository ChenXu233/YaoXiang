# YaoXiang æµ‹è¯•ç»„ç»‡æ”¹è¿›è®¡åˆ’

> æ—¥æœŸï¼š2026-01-03  
> å®¡æ ¸äººï¼šRoo (Architect Mode)  
> æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.1.0 (æ ¹æ®ç”¨æˆ·åé¦ˆæ›´æ–°)

---

## ä¸€ã€ç°çŠ¶åˆ†æ

### 1.1 æµ‹è¯•ç›®å½•ç»“æ„ç°çŠ¶

```
yaoxiang/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ frontend/
â”‚   â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â””â”€â”€ tests/              âœ… æœ‰ tests å­ç›®å½• (5ä¸ªæ–‡ä»¶)
â”‚   â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚       â”œâ”€â”€ basic.rs
â”‚   â”‚   â”‚       â”œâ”€â”€ boundary.rs
â”‚   â”‚   â”‚       â”œâ”€â”€ state.rs
â”‚   â”‚   â”‚       â””â”€â”€ type_parser.rs
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ typecheck/
â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚       â””â”€â”€ tests/              âœ… æœ‰ tests å­ç›®å½• (7ä¸ªæ–‡ä»¶)
â”‚   â”‚           â”œâ”€â”€ mod.rs
â”‚   â”‚           â”œâ”€â”€ basic.rs
â”‚   â”‚           â”œâ”€â”€ check.rs
â”‚   â”‚           â”œâ”€â”€ error.rs
â”‚   â”‚           â”œâ”€â”€ generic.rs
â”‚   â”‚           â”œâ”€â”€ infer.rs
â”‚   â”‚           â””â”€â”€ types.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ middle/
â”‚   â”‚   â”œâ”€â”€ codegen/                âŒ æ²¡æœ‰ tests å­ç›®å½•
â”‚   â”‚   â”œâ”€â”€ monomorphize/           âŒ æ²¡æœ‰ tests å­ç›®å½•
â”‚   â”‚   â”œâ”€â”€ escape_analysis/        âŒ æ²¡æœ‰ tests å­ç›®å½•
â”‚   â”‚   â”œâ”€â”€ lifetime/              âŒ æ²¡æœ‰ tests å­ç›®å½•
â”‚   â”‚   â””â”€â”€ ir.rs                   âŒ æ²¡æœ‰é…å¥—æµ‹è¯•
â”‚   â”‚
â”‚   â”œâ”€â”€ backends/
â”‚   â”‚   â””â”€â”€ dev/
â”‚   â”‚       â””â”€â”€ tui_repl/          âŒ æ²¡æœ‰ tests å­ç›®å½•
â”‚   â”‚
â”‚   â””â”€â”€ std/                        âŒ æ²¡æœ‰ tests ç›®å½•
â”‚
â”‚   â””â”€â”€ util/
â”‚       â””â”€â”€ span.rs                 âš ï¸ å†…è”æµ‹è¯•
â”‚
â”‚   â””â”€â”€ middle/
â”‚       â””â”€â”€ monomorphize/
â”‚           â””â”€â”€ instance.rs         âš ï¸ å†…è”æµ‹è¯•
â”‚
â””â”€â”€ tests/
    â””â”€â”€ unit/
        â””â”€â”€ codegen.rs              âš ï¸ æ··åˆå¤šä¸ªæ¨¡å—çš„æµ‹è¯• (240è¡Œ)
```

### 1.2 å½“å‰æµ‹è¯•ç»Ÿè®¡

| æ¨¡å— | æµ‹è¯•æ–‡ä»¶æ•° | æµ‹è¯•ç”¨ä¾‹æ•° | è¦†ç›–ç‡ | çŠ¶æ€ |
|------|-----------|-----------|--------|------|
| frontend/parser | 5 | ~50+ | é«˜ | âœ… å®Œæ•´ |
| frontend/typecheck | 7 | ~100+ | é«˜ | âœ… å®Œæ•´ |
| middle/codegen | 0 | 0 | 0% | âŒ ç¼ºå¤± |
| middle/monomorphize | 0 | 0 | 0% | âŒ ç¼ºå¤± |
| middle/escape_analysis | 0 | 0 | 0% | âŒ ç¼ºå¤± |
| middle/ir | 0 | 0 | 0% | âŒ ç¼ºå¤± |
| vm (å†…è”æµ‹è¯•) | 5 | ~15 | ä¸­ | âš ï¸ éœ€è¿ç§» |
| runtime (å†…è”æµ‹è¯•) | 3 | ~10 | ä½ | âš ï¸ éœ€è¿ç§» |
| util/span | 1 | ~5 | ä½ | âš ï¸ éœ€è¿ç§» |
| middle/monomorphize/instance | 1 | ~5 | ä½ | âš ï¸ éœ€è¿ç§» |
| **æ€»è®¡** | **22** | **~190+** | **~25%** | **ä¸å®Œæ•´** |

---

## äºŒã€é—®é¢˜æ¸…å•

### 2.1 ä¸¥é‡é—®é¢˜ (Critical)

| # | é—®é¢˜ | å½±å“ | ä½ç½® |
|---|------|------|------|
| 1 | **æµ‹è¯•ç›®å½•ä¸ä¸€è‡´** | å‰ç«¯æ¨¡å—æœ‰ `tests/` å­ç›®å½•ï¼Œä¸­ç«¯æ¨¡å—æ²¡æœ‰ï¼Œå¯¼è‡´æµ‹è¯•ç»„ç»‡æ··ä¹± | `src/middle/` |
| 2 | **æµ‹è¯•æ–‡ä»¶è‡ƒè‚¿** | `tests/unit/codegen.rs` æ··åˆäº† opcodeã€å•æ€åŒ–ã€é€ƒé€¸åˆ†æã€IRã€å­—èŠ‚ç æµ‹è¯•ï¼Œéš¾ä»¥ç»´æŠ¤ | `tests/unit/codegen.rs:1-240` |
| 3 | **ä¸­ç«¯æ¨¡å—ç¼ºå°‘æµ‹è¯•** | `codegen/`, `monomorphize/`, `escape_analysis/` å®Œå…¨æ²¡æœ‰å•å…ƒæµ‹è¯• | `src/middle/` |
| 4 | **IR ç¼ºå°‘æµ‹è¯•** | æ ¸å¿ƒæ•°æ®ç»“æ„ IR æ²¡æœ‰é…å¥—æµ‹è¯• | `src/middle/ir.rs` |

### 2.2 ä¸­ç­‰é—®é¢˜ (Major)

| # | é—®é¢˜ | å½±å“ | ä½ç½® |
|---|------|------|------|
| 5 | **VM ç¼ºå°‘æµ‹è¯•** | è™šæ‹Ÿæœºæ ¸å¿ƒç»„ä»¶æ²¡æœ‰æµ‹è¯•ï¼Œæ‰§è¡Œé€»è¾‘æ— æ³•éªŒè¯ | `src/middle/` |
| 6 | **Runtime ç¼ºå°‘æµ‹è¯•** | GCã€å†…å­˜ç®¡ç†ã€è°ƒåº¦å™¨æ²¡æœ‰æµ‹è¯•ï¼Œè¿è¡Œæ—¶å¯é æ€§æ— æ³•ä¿è¯ | `src/middle/` |
| 7 | **ç¼ºå°‘é›†æˆæµ‹è¯•** | æ²¡æœ‰ç«¯åˆ°ç«¯æµ‹è¯•æµç¨‹ï¼Œæ— æ³•éªŒè¯å®Œæ•´ç¼–è¯‘ç®¡çº¿ | `tests/` |
| 8 | **æµ‹è¯•å‘½åä¸ç»Ÿä¸€** | æœ‰äº›ç”¨ `basic.rs`ï¼Œæœ‰äº›ç”¨ `check.rs`ï¼Œç¼ºä¹ç»Ÿä¸€è§„èŒƒ | å¤šä¸ªä½ç½® |

### 2.3 è½»å¾®é—®é¢˜ (Minor)

| # | é—®é¢˜ | å½±å“ |
|---|------|------|
| 9 | **ç¼ºå°‘æ€§èƒ½æµ‹è¯•** | æ²¡æœ‰åŸºå‡†æµ‹è¯•ï¼Œæ€§èƒ½å›å½’æ— æ³•æ£€æµ‹ |
| 10 | **ç¼ºå°‘æ¨¡ç³Šæµ‹è¯•** | æ²¡æœ‰éšæœºæµ‹è¯•ï¼Œè¾¹ç•Œæƒ…å†µå¯èƒ½é—æ¼ |
| 11 | **ç¼ºå°‘æ–‡æ¡£æµ‹è¯•** | æ–‡æ¡£ä¸­çš„ç¤ºä¾‹ä»£ç æ²¡æœ‰éªŒè¯æœºåˆ¶ |

---

## ä¸‰ã€æ”¹è¿›æ–¹æ¡ˆ

### 3.1 ç›®å½•ç»“æ„é‡æ„

```
yaoxiang/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ frontend/
â”‚   â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â””â”€â”€ tests/              âœ… ä¿æŒç°çŠ¶
â”‚   â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚       â”œâ”€â”€ basic.rs
â”‚   â”‚   â”‚       â”œâ”€â”€ boundary.rs
â”‚   â”‚   â”‚       â”œâ”€â”€ state.rs
â”‚   â”‚   â”‚       â””â”€â”€ type_parser.rs
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ typecheck/
â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚       â””â”€â”€ tests/              âœ… ä¿æŒç°çŠ¶
â”‚   â”‚           â”œâ”€â”€ mod.rs
â”‚   â”‚           â”œâ”€â”€ basic.rs
â”‚   â”‚           â”œâ”€â”€ check.rs
â”‚   â”‚           â”œâ”€â”€ error.rs
â”‚   â”‚           â”œâ”€â”€ generic.rs
â”‚   â”‚           â”œâ”€â”€ infer.rs
â”‚   â”‚           â””â”€â”€ types.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ middle/
â”‚   â”‚   â”œâ”€â”€ codegen/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â””â”€â”€ tests/              ğŸ”„ æ–°å¢ - è¡¨è¾¾å¼å’Œè¯­å¥ç”Ÿæˆæµ‹è¯•
â”‚   â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚       â”œâ”€â”€ expr.rs         ğŸ”„ æ–°å¢ - è¡¨è¾¾å¼ä»£ç ç”Ÿæˆ
â”‚   â”‚   â”‚       â””â”€â”€ stmt.rs         ğŸ”„ æ–°å¢ - è¯­å¥ä»£ç ç”Ÿæˆ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ monomorphize/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ instance.rs         ğŸ”„ è¿ç§» - ä»å†…è”æµ‹è¯•
â”‚   â”‚   â”‚   â””â”€â”€ tests/              ğŸ”„ æ–°å¢ - å•æ€åŒ–æµ‹è¯•
â”‚   â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚       â”œâ”€â”€ instance.rs     ğŸ”„ ä» instance.rs è¿ç§»
â”‚   â”‚   â”‚       â””â”€â”€ specialization.rs ğŸ”„ æ–°å¢ - ç‰¹åŒ–ç­–ç•¥
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ escape_analysis/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â””â”€â”€ tests/              ğŸ”„ æ–°å¢ - é€ƒé€¸åˆ†ææµ‹è¯•
â”‚   â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚       â”œâ”€â”€ propagate.rs    ğŸ”„ æ–°å¢ - ä¼ æ’­é€»è¾‘
â”‚   â”‚   â”‚       â””â”€â”€ allocation.rs   ğŸ”„ æ–°å¢ - åˆ†é…å†³ç­–
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ir/
â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚       â””â”€â”€ tests/              ğŸ”„ æ–°å¢ - IR æ•°æ®ç»“æ„æµ‹è¯•
â”‚   â”‚           â”œâ”€â”€ mod.rs
â”‚   â”‚           â””â”€â”€ instruction.rs  ğŸ”„ æ–°å¢ - æŒ‡ä»¤æµ‹è¯•
â”‚   â”‚
â”‚   â”œâ”€â”€ backends/
â”‚   â”‚   â””â”€â”€ dev/
â”‚   â”‚       â””â”€â”€ tui_repl/
â”‚   â”‚           â””â”€â”€ tests/          ğŸ”„ æ–°å¢ - ä¸º REPL æ·»åŠ æµ‹è¯•
â”‚   â”‚               â”œâ”€â”€ mod.rs
â”‚   â”‚               â””â”€â”€ repl.rs     ğŸ”„ æ–°å¢ - REPL åŠŸèƒ½æµ‹è¯•
â”‚   â”‚
â”‚   â””â”€â”€ util/
â”‚       â””â”€â”€ span.rs
â”‚           â””â”€â”€ tests/              ğŸ”„ æ–°å¢ - ä»å†…è”æµ‹è¯•è¿ç§»
â”‚               â”œâ”€â”€ mod.rs
â”‚               â””â”€â”€ span.rs         ğŸ”„ ä» span.rs è¿ç§»
â”‚
â”‚   â””â”€â”€ frontend/
â”‚       â””â”€â”€ lexer/
â”‚           â””â”€â”€ tests/              ğŸ”„ æ–°å¢ - ä»å†…è”æµ‹è¯•è¿ç§»
â”‚               â”œâ”€â”€ mod.rs
â”‚               â””â”€â”€ lexer.rs        ğŸ”„ ä» lexer/mod.rs è¿ç§»
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ unit/                       âŒ åˆ é™¤ - å•å…ƒæµ‹è¯•ç§»åˆ°æ¨¡å—å†…
    â”‚
    â””â”€â”€ integration/               âœ… ä¿ç•™ - é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•
        â”œâ”€â”€ mod.rs
        â”œâ”€â”€ parser_typecheck.rs     ğŸ”„ æ–°å¢ - å‰ç«¯é›†æˆæµ‹è¯•
        â”œâ”€â”€ codegen_vm.rs           ğŸ”„ æ–°å¢ - åç«¯é›†æˆæµ‹è¯•
        â””â”€â”€ end_to_end.rs           ğŸ”„ æ–°å¢ - ç«¯åˆ°ç«¯æµ‹è¯•
```

### 3.2 æµ‹è¯•ç­–ç•¥

| æµ‹è¯•ç±»å‹ | ä½ç½® | è¯´æ˜ |
|---------|------|------|
| **å•å…ƒæµ‹è¯•** | `src/module/tests/` | æ‰€æœ‰æ¨¡å—çš„å•å…ƒæµ‹è¯•ï¼Œæµ‹è¯•å†…éƒ¨å®ç° |
| **å†…è”æµ‹è¯•** | å…¨éƒ¨ç§»é™¤ | è¿ç§»åˆ° `tests/` å­ç›®å½• |
| **é›†æˆæµ‹è¯•** | `tests/integration/` | è·¨æ¨¡å—æµ‹è¯•ï¼ŒéªŒè¯æ¨¡å—é—´åä½œ |
| **ç«¯åˆ°ç«¯æµ‹è¯•** | `tests/integration/` | å®Œæ•´ç¼–è¯‘ç®¡çº¿æµ‹è¯• |

### 3.3 æµ‹è¯•å‘½åè§„èŒƒ

| æµ‹è¯•ç±»å‹ | æ–‡ä»¶å‘½å | ç¤ºä¾‹ |
|---------|---------|------|
| å•å…ƒæµ‹è¯• | `{æ¨¡å—å}.rs` | `expr.rs`, `stmt.rs` |
| è¾¹ç•Œæµ‹è¯• | `boundary.rs` | è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ |
| é”™è¯¯æµ‹è¯• | `error.rs` | é”™è¯¯å¤„ç†å’Œæ¶ˆæ¯ |
| æ³›å‹æµ‹è¯• | `generic.rs` | æ³›å‹ä»£ç æµ‹è¯• |
| é›†æˆæµ‹è¯• | `integration/` | è·¨æ¨¡å—æµ‹è¯• |
| ç«¯åˆ°ç«¯æµ‹è¯• | `end_to_end.rs` | å®Œæ•´æµç¨‹æµ‹è¯• |

### 3.3 æµ‹è¯•ç”¨ä¾‹è§„èŒƒ

```rust
// æ–‡ä»¶: src/middle/codegen/tests/expr.rs

#[cfg(test)]
mod binary_operation_tests {
    use super::*;

    /// æµ‹è¯•ç”¨ä¾‹å‘½åè§„èŒƒï¼štest_<åŠŸèƒ½>_<åœºæ™¯>
    #[test]
    fn test_i64_add_positive_numbers() {
        // Given: å‡†å¤‡æµ‹è¯•æ•°æ®
        let left = Operand::Const(ConstValue::Int(10));
        let right = Operand::Const(ConstValue::Int(20));
        
        // When: æ‰§è¡Œè¢«æµ‹å‡½æ•°
        let result = generate_binop(&BinOp::Add, &left, &right);
        
        // Then: éªŒè¯ç»“æœ
        assert!(result.is_ok());
    }

    /// æµ‹è¯•æµ®ç‚¹æ•°åŠ æ³•
    #[test]
    fn test_f64_add_decimal_numbers() {
        let left = Operand::Const(ConstValue::Float(3.14));
        let right = Operand::Const(ConstValue::Float(2.86));
        
        let result = generate_binop(&BinOp::Add, &left, &right);
        assert!(result.is_ok());
    }

    /// æµ‹è¯•æº¢å‡ºæƒ…å†µ
    #[test]
    fn test_i64_add_overflow() {
        let max = Operand::Const(ConstValue::Int(i64::MAX));
        let one = Operand::Const(ConstValue::Int(1));
        
        let result = generate_binop(&BinOp::Add, &max, &one);
        // åº”è¯¥è¿”å›é”™è¯¯æˆ–æ­£ç¡®å¤„ç†æº¢å‡º
        assert!(result.is_err());
    }
}
```

---

## å››ã€è¡ŒåŠ¨è®¡åˆ’

### é˜¶æ®µä¸€ï¼šè¿ç§»å†…è”æµ‹è¯•åˆ°æ¨¡å—å†…çš„ tests/ å­ç›®å½• (P0)

| ä»»åŠ¡ | æºæ–‡ä»¶ | ç›®æ ‡ç›®å½• | ä¾èµ– |
|------|--------|---------|------|
| è¿ç§» vm/opcode.rs å†…è”æµ‹è¯• | `src/middle/opcode.rs` | `src/middle/tests/opcode.rs` | æ—  |
| è¿ç§» vm/errors.rs å†…è”æµ‹è¯• | `src/middle/errors.rs` | `src/middle/tests/errors.rs` | ä»»åŠ¡1 |
| è¿ç§» vm/executor.rs å†…è”æµ‹è¯• | `src/middle/executor.rs` | `src/middle/tests/executor.rs` | ä»»åŠ¡1 |
| è¿ç§» vm/frames.rs å†…è”æµ‹è¯• | `src/middle/frames.rs` | `src/middle/tests/frames.rs` | ä»»åŠ¡1 |
| è¿ç§» vm/instructions.rs å†…è”æµ‹è¯• | `src/middle/instructions.rs` | `src/middle/tests/instructions.rs` | ä»»åŠ¡1 |
| è¿ç§» runtime/gc å†…è”æµ‹è¯• | `src/middle/gc/mod.rs` | `src/middle/gc/tests/mod.rs` | æ—  |
| è¿ç§» runtime/memory å†…è”æµ‹è¯• | `src/middle/memory/mod.rs` | `src/middle/memory/tests/mod.rs` | ä»»åŠ¡6 |
| è¿ç§» runtime/scheduler å†…è”æµ‹è¯• | `src/middle/scheduler/mod.rs` | `src/middle/scheduler/tests/mod.rs` | ä»»åŠ¡6 |
| è¿ç§» util/span å†…è”æµ‹è¯• | `src/util/span.rs` | `src/util/span/tests/mod.rs` | æ—  |
| è¿ç§» frontend/lexer å†…è”æµ‹è¯• | `src/frontend/lexer/mod.rs` | `src/frontend/lexer/tests/mod.rs` | æ—  |
| è¿ç§» monomorphize/instance å†…è”æµ‹è¯• | `src/middle/monomorphize/instance.rs` | `src/middle/monomorphize/tests/instance.rs` | æ—  |

### é˜¶æ®µäºŒï¼šæ‹†åˆ† tests/unit/codegen.rs (P1)

| ä»»åŠ¡ | è¯´æ˜ | ä¾èµ– |
|------|------|------|
| æ‹†åˆ† opcode_tests | ç§»åˆ° `src/middle/tests/opcode.rs` | é˜¶æ®µä¸€ä»»åŠ¡1 |
| æ‹†åˆ† monomorphize_tests | ç§»åˆ° `src/middle/monomorphize/tests/` | é˜¶æ®µä¸€ä»»åŠ¡11 |
| æ‹†åˆ† escape_analysis_tests | ç§»åˆ° `src/middle/escape_analysis/tests/` | é˜¶æ®µä¸€åæ–°å»º |
| æ‹†åˆ† codegen_tests | ç§»åˆ° `src/middle/codegen/tests/` | é˜¶æ®µä¸€åæ–°å»º |
| æ‹†åˆ† bytecode_instruction_tests | ç§»åˆ° `src/middle/codegen/tests/` | é˜¶æ®µä¸€åæ–°å»º |

### é˜¶æ®µä¸‰ï¼šæ–°å¢ç¼ºå¤±æµ‹è¯•ç›®å½• (P1)

| ä»»åŠ¡ | è¯´æ˜ | ä¾èµ– |
|------|------|------|
| åˆ›å»º middle/codegen/tests/ | ä»£ç ç”Ÿæˆæµ‹è¯•ç›®å½• | é˜¶æ®µä¸€å®Œæˆå |
| åˆ›å»º middle/escape_analysis/tests/ | é€ƒé€¸åˆ†ææµ‹è¯•ç›®å½• | é˜¶æ®µä¸€å®Œæˆå |
| åˆ›å»º middle/ir/tests/ | IR æµ‹è¯•ç›®å½• | é˜¶æ®µä¸€å®Œæˆå |
| åˆ é™¤ tests/unit/ ç›®å½• | å•å…ƒæµ‹è¯•å·²è¿ç§»åˆ°æ¨¡å—å†… | é˜¶æ®µäºŒå®Œæˆå |

### é˜¶æ®µå››ï¼šåˆ›å»ºé›†æˆæµ‹è¯• (P2)

| ä»»åŠ¡ | è¯´æ˜ | ä¾èµ– |
|------|------|------|
| åˆ›å»º tests/integration/ ç›®å½• | é›†æˆæµ‹è¯•ç›®å½• | é˜¶æ®µä¸‰å®Œæˆå |
| åˆ›å»º parser_typecheck.rs | å‰ç«¯é›†æˆæµ‹è¯• | é˜¶æ®µä¸‰å®Œæˆå |
| åˆ›å»º codegen_vm.rs | åç«¯é›†æˆæµ‹è¯• | é˜¶æ®µä¸‰å®Œæˆå |
| åˆ›å»º end_to_end.rs | ç«¯åˆ°ç«¯æµ‹è¯• | é˜¶æ®µä¸‰å®Œæˆå |

---

## äº”ã€æµ‹è¯•è¦†ç›–ç›®æ ‡

### 5.1 è¦†ç›–æŒ‡æ ‡

| æ¨¡å— | å½“å‰è¦†ç›–ç‡ | ç›®æ ‡è¦†ç›–ç‡ | å·®è· |
|------|-----------|-----------|------|
| frontend/parser | ~90% | 95% | +5% |
| frontend/typecheck | ~85% | 95% | +10% |
| middle/codegen | 0% | 80% | +80% |
| middle/monomorphize | ~10% | 80% | +70% |
| middle/escape_analysis | ~10% | 80% | +70% |
| middle/ir | 0% | 90% | +90% |
| vm | ~20% â†’ 80% | 80% | +60% |
| runtime | ~10% â†’ 60% | 70% | +60% |
| util | ~10% â†’ 60% | 80% | +70% |
| frontend/lexer | ~10% â†’ 60% | 80% | +70% |
| **æ€»ä½“** | **~25%** | **80%** | **+55%** |

### 5.2 æµ‹è¯•ç±»å‹åˆ†å¸ƒ

```
æµ‹è¯•ç±»å‹åˆ†å¸ƒç›®æ ‡ï¼š
â”œâ”€â”€ æ¨¡å—å†…å•å…ƒæµ‹è¯• (src/module/tests/)  70%
â”‚   â”œâ”€â”€ æ•°æ®ç»“æ„æµ‹è¯•                    20%
â”‚   â”œâ”€â”€ ç®—æ³•æµ‹è¯•                        30%
â”‚   â””â”€â”€ è¾¹ç•Œæµ‹è¯•                        20%
â”œâ”€â”€ é›†æˆæµ‹è¯• (tests/integration/)       20%
â”‚   â”œâ”€â”€ æ¨¡å—é—´æµ‹è¯•                      10%
â”‚   â””â”€â”€ ç®¡çº¿æµ‹è¯•                        10%
â””â”€â”€ ç«¯åˆ°ç«¯æµ‹è¯• (tests/integration/)     10%
```

### 5.3 è¿ç§»ç»Ÿè®¡

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ |
|------|------|------|
| å†…è”æµ‹è¯•æ¨¡å—æ•° | 12 | 0 |
| æ¨¡å—å†… tests/ ç›®å½•æ•° | 2 | 17 |
| tests/unit/ æ–‡ä»¶æ•° | 1 | 0 |
| tests/integration/ æ–‡ä»¶æ•° | 0 | 4 |

---

## å…­ã€æ€»ç»“

æœ¬è®¡åˆ’æå‡ºäº†ä»¥ä¸‹æ”¹è¿›æªæ–½ï¼š

1. **è¿ç§»æ‰€æœ‰å†…è”æµ‹è¯•** - å°† 12 ä¸ªæ–‡ä»¶ä¸­çš„å†…è”æµ‹è¯•æ¨¡å—è¿ç§»åˆ°æ¨¡å—å†…çš„ `tests/` å­ç›®å½•
2. **ç»Ÿä¸€æµ‹è¯•ç›®å½•ç»“æ„** - ä¸ºæ‰€æœ‰æ¨¡å—æ·»åŠ  `tests/` å­ç›®å½•ï¼Œä¿æŒä¸€è‡´æ€§
3. **æ‹†åˆ†è‡ƒè‚¿æµ‹è¯•æ–‡ä»¶** - å°† `tests/unit/codegen.rs` æ‹†åˆ†ä¸ºå¤šä¸ªä¸“ç”¨æµ‹è¯•æ–‡ä»¶
4. **æ–°å¢ç¼ºå¤±æµ‹è¯•** - ä¸º codegenã€monomorphizeã€escape_analysisã€ir æ·»åŠ å•å…ƒæµ‹è¯•
5. **å»ºç«‹é›†æˆæµ‹è¯•** - åˆ›å»ºå‰ç«¯ã€åç«¯ã€ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
6. **æ¸…ç† tests/ ç›®å½•** - åˆ é™¤ `tests/unit/` ç›®å½•ï¼Œåªä¿ç•™ `tests/integration/`

### è¿ç§»å‰åå¯¹æ¯”

```
è¿ç§»å‰ï¼š                              è¿ç§»åï¼š
â”œâ”€â”€ tests/                           â”œâ”€â”€ tests/
â”‚   â””â”€â”€ unit/                       â”‚   â””â”€â”€ integration/  â† åªä¿ç•™é›†æˆæµ‹è¯•
â”‚       â””â”€â”€ codegen.rs              â”‚       â”œâ”€â”€ parser_typecheck.rs
â”‚                                   â”‚       â”œâ”€â”€ codegen_vm.rs
â”œâ”€â”€ src/middle/opcode.rs                â”‚       â””â”€â”€ end_to_end.rs
â”‚   â””â”€â”€ #[cfg(test)]                â”‚
â”‚       mod tests { ... }           â”œâ”€â”€ src/middle/
â”‚                                   â”‚   â””â”€â”€ tests/  â† æ–°å¢
â”œâ”€â”€ src/middle/gc/mod.rs           â”‚       â”œâ”€â”€ opcode.rs  â† ä» opcode.rs è¿ç§»
â”‚   â””â”€â”€ #[cfg(test)]                â”‚       â”œâ”€â”€ errors.rs  â† ä» errors.rs è¿ç§»
â”‚       mod tests { ... }           â”‚       â””â”€â”€ executor.rs â† ä» executor.rs è¿ç§»
â”‚   ... (12ä¸ªæ–‡ä»¶)                   â”‚
â”‚                                   â””â”€â”€ src/middle/gc/
â”‚                                       â””â”€â”€ tests/  â† æ–°å¢
â”‚                                           â””â”€â”€ collector.rs â† ä» mod.rs è¿ç§»
```

å®æ–½æœ¬è®¡åˆ’åï¼š
- æµ‹è¯•è¦†ç›–ç‡é¢„è®¡ä» ~25% æå‡åˆ° 80%
- å†…è”æµ‹è¯•æ¨¡å—ä» 12 ä¸ªå‡å°‘åˆ° 0 ä¸ª
- æ¨¡å—å†… tests/ ç›®å½•ä» 2 ä¸ªå¢åŠ åˆ° 17 ä¸ª
- æµ‹è¯•ç»„ç»‡æ›´åŠ ä¸€è‡´å’Œå¯ç»´æŠ¤

---

> ã€Œåƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚ã€å»ºè®®ä»è¿ç§» vm æ¨¡å—çš„å†…è”æµ‹è¯•å¼€å§‹ï¼Œé€æ­¥å®Œå–„æµ‹è¯•ä½“ç³»ã€‚
